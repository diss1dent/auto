app.factory("urlStore",[function(){return{redirectUrl:"/dashboard/",dashboard:"/dashboard/",pwdExpired:"/expiredPassword/",forgetPassword:"/expiredPassword/?fp\x3dtrue",updateBrokerBidderEmail:"/updateBrokerBidderEmail/",login:"/login",lotDetailUrl:"/lotDetail/",noWatchlistLots:"/noResults/watchlist",noLotsFound:"/noResults/lots",home:"/",protectedUrls:["/Content/US/en/Premier-Member-Fees"]}}]);
app.factory("urlService",["$location","$filter","userService","auctionsCalendarService","$q","$sce","$routeParams","$rootScope","copartUser",function($location,$filter,userService,auctionsCalendarService,$q,$sce,$routeParams,$rootScope,copartUser){return{redirectUrl:"/dashboard/",dashboard:"/dashboard/",pwdExpired:"/expiredPassword/",forgetPassword:"/expiredPassword/?fp\x3dtrue",updateBrokerBidderEmail:"/updateBrokerBidderEmail/",login:"/login",lotDetailUrl:"/lotDetail/",noWatchlistLots:"/public/fetchDirective.html?directive\x3dwatchlist/noItemsWatchList",
noLotsFound:"/public/fetchDirective.html?directive\x3dvehicleFinder/noSearchFound",home:"/",getContentURL:function(context){var url=appInit.localeString+"/Content/"+appInit.regionCode+"/"+appInit.localeString;if(context)url+="/"+context;console.log("URL generated as :"+url);return url},getURLProtocol:function(){return $location.protocol()},getHeadingForURL:function(url,locale){if(url.indexOf("/watchList")!=-1)return"My Watchlist";else if(url.indexOf("saleListResult")!=-1){var location=$location.search().displayStr;
if(_.isUndefined(location))location=$location.search().location;$rootScope.$emit("meta-args-update",{searchText:location});return"Sale List for "+location}else if(url.indexOf("vehicleFinderSearch")!=-1){var displayStr=$location.search().displayStr;$rootScope.$emit("meta-args-update",{searchText:displayStr});return"Search Results for: "+displayStr}else if(url.indexOf("/search/")!=-1||url.indexOf("/quickpick/")!=-1){var displayStr=$location.search().displayStr;$rootScope.$emit("meta-args-update",{searchText:displayStr});
return"Search Results for: "+displayStr}else return locale.messages["app.label.search.results"]},getSubHeaderForURL:function(url,locale){var deferred=$q.defer();if(url.indexOf("saleListResult")!=-1){var yardNum=$location.search().yardNum||$routeParams.yard;auctionsCalendarService.auctionByYard(yardNum).then(function(auction){var saleDate=parseInt($location.search().saleDate);var yardNum=$routeParams.yard;if(!_.isUndefined(saleDate)&&!isNaN(saleDate))if("Future"==saleDate)deferred.resolve("Sale Date / Time: "+
saleDate+" (\x3ca class\x3d'cursor-pointer' data-uname\x3d'lotLocation' location-modal yard-number\x3d'"+yardNum+"' yard-details\x3d'yardDetails' show-inventory\x3dfalse\x3eView Location\x3c/a\x3e)");else{var date=moment(saleDate);var preBidStart=moment(saleDate);var prelimOffset=auction.endOfPreBid,prelimOffsetParts=prelimOffset.split(":"),hourDelta=prelimOffsetParts[0],minuteDelta=prelimOffsetParts[1];preBidStart.subtract({hours:hourDelta,minutes:minuteDelta});var dateTimeFormat=userService.userConfig.dateFormat+
" "+userService.userConfig.timeFormat+" zz";var dateStr=date.tz(userService.userConfig.selectedTimezone).format(dateTimeFormat);var preBidStartStr=preBidStart.tz(userService.userConfig.selectedTimezone).format(dateTimeFormat);if(date.isValid()&&preBidStart.isValid())deferred.resolve("Sale Date/Time: "+dateStr+" Pre-Bid Ends:"+preBidStartStr+" (\x3ca class\x3d'cursor-pointer' data-uname\x3d'lotLocation' location-modal yard-number\x3d'"+yardNum+"' yard-details\x3d'yardDetails' show-inventory\x3dfalse\x3eView Location\x3c/a\x3e)");
else deferred.resolve()}else deferred.resolve()})}else deferred.resolve();return deferred.promise},getNoResultsURL:function(url){if(url.indexOf("watchList")!=-1)return this.noWatchlistLots;else return this.noLotsFound}}}]);
app.service("functionQueueService",["$location",function($location){var self=this;var functionQueue=[];self.addToQueue=function(funcCall){functionQueue.push(funcCall)};self.executeQueue=function(){for(var i=0;i<functionQueue.length;i++){var funcCall=functionQueue[i];funcCall.funcRef(funcCall.paramArr[0])}functionQueue=[]}}]);app.factory("History",function(){return{lastRoute:{},secondLastRoute:{}}});
app.service("siteCatalyst",["userService",function(userService){var self=this;var valQueue={};self.addToQueue=function(fname,val){valQueue[fname]=val};self.executeCall=function(fname){var val=AppUtils.isUndefined(fname)?null:valQueue[fname];valQueue[fname]=null;if(!AppUtils.isUndefined(val))try{var memNumber=userService.userConfig.buyerNumber;lm.Omniture[fname](val["lotId"],memNumber,val["linkName"],val["download"],val["addremove"],val["channel"],val["pagename"],val["server"],val["ipaddress"],val["country"],
val["state"],val["city"],val["zipcode"],val["yardname"],val["type"],val["doctitle"],val["widgetName"],memNumber,val["selectedLanguage"],memNumber,val["videoUrl"],val["imageNumber"],val["tag"])}catch(e){console.log("error executing site catalyst call")}};self.doTagPageView=function(pageName){try{if(window.location.hash!="#data\x3drefresh"){var prefix="";if(userService.isAnonymous())prefix="public:";else prefix="member:";s.pageName=prefix+pageName;s.channel="public";s.pageType="";lm.Omniture.PageName=
s.pageName;s.prop1=s.pageName;var s_code=s.t();if(s_code)document.write(s_code);lm.Omniture.ClearVars()}else window.location.hash=""}catch(e){log.error("Site Catalyst call unsuccessful")}}}]);
app.controller("appController",["$interpolate","$scope","$interval","$sce","$window","$compile","$filter","$locale","$timeout","$route","$cookies","config","dataServiceG2","copartUser","$location","$http","urlService","$q","$rootScope","$templateCache","appConfigService","userService","loginService","auctionsCalendarService","HttpPendingRequestsService","siteCatalyst","localStorageService","History","metaDataService","geocodingService","cmsContentService",function AppController($interpolate,$scope,
$interval,$sce,$window,$compile,$filter,$locale,$timeout,$route,$cookies,config,dataServiceG2,copartUser,$location,$http,urlService,$q,$rootScope,$templateCache,appConfigService,userService,loginService,auctionsCalendarService,HttpPendingRequestsService,siteCatalyst,localStorageService,History,metaDataService,geocodingService,cmsContentService){var log=new Logger({name:"AppController",level:config.logLevel});var self=$scope;self.restoreUrl=false;self.appConfig=appConfigService.getAppConfig();var defaultBaseUrl=
"";var defaultBaseUrlRegEx=new RegExp(appInit.redirectUrl);var siteCode=copartUser.getUserConfig().siteCode;self.isCrashedToy=siteCode.indexOf("CRT")>-1;$("body").on("contentRoute",function(event,userLang,region,contentPath){$location.url("/Content/"+region+"/"+userLang+"/"+contentPath)});$scope.$on("$locationChangeStart",function(event,next,current){try{var baseURI=document.baseURI;if(!baseURI){var baseTags=document.getElementsByTagName("base");baseURI=baseTags.length?baseTags[0].href:document.URL}var oldRoute=
current.replace(baseURI,"");var nextRoute=next.replace(baseURI,"");History.secondLastRoute=_.clone(History.lastRoute);History.lastRoute=oldRoute;if(self.restoreUrl){console.log("Redirect URL\x3d"+oldRoute);urlService.redirectUrl=oldRoute;self.restoreUrl=false}}catch(e){}});$scope.$on("$routeChangeStart",function(scope,next,current){try{var allowAccess=next.$$route.allowAccess;var scrollSave=current?current.$$route.scrollRestore?true:false:false;if(scrollSave){var scrollTop=window.pageYOffset!==undefined?
window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop;var pageName=current.$$route.scrollRestoreKey;localStorageService.set(pageName+"-scrollPosition",scrollTop);console.log("Saved scroll position:"+scrollTop)}var restoreUrl=current?current.$$route.restoreUrlOnLogin?true:false:false;var isLoginPage=$location.url().indexOf("/login")>=0;if(restoreUrl&&isLoginPage)self.restoreUrl=true;var templateUrl=next.$$route.templateUrl;var blockAccess=next.$$route.blockAccess;
var altRoute=next.$$route.altRoute;var userRoles=copartUser.config.roles;if(angular.isDefined(next.$$route.noCache)&&next.$$route.noCache==true)$templateCache.remove(next.$$route.templateUrl);$rootScope.title=metaDataService.getTitleForRoute(next.$$route,self.locale);$rootScope.description=metaDataService.getDescForRoute(next.$$route,self.locale);$rootScope.redirectAfterLoginUrl=next.$$route.redirectAfterLoginUrl;var metaDataUpdateEvent=$rootScope.$on("update-site-meta",function(event,data){$rootScope.title=
metaDataService.getTitleForRoute(next.$$route,self.locale);$rootScope.description=metaDataService.getDescForRoute(next.$$route,self.locale)});if(siteCode!="CRTSUS")if(_.isEmpty(next.params)){$rootScope.languageHrefPath=next.$$route.originalPath;$rootScope.showLanguageHref=true}else $rootScope.showLanguageHref=false;if(allowAccess!=null&&_.contains(userRoles,"ROLE_ANONYMOUS")&&templateUrl.indexOf("/public/")<0&&templateUrl.indexOf("login.html")<0)next.$$route.templateUrl=templateUrl.replace("/","/public/");
if(allowAccess!=null&&!_.contains(allowAccess,"ROLE_ANONYMOUS")){var allowedSet=_.intersection(allowAccess,userRoles);if(allowedSet.length==0)$location.path("/accessDenied")}if(blockAccess!=null){var blockedSet=_.intersection(blockAccess,userRoles);if(blockedSet.length!=0)if(altRoute!=null)$location.path(altRoute);else $location.path("/accessDenied")}jQuery(".modal-backdrop").remove();jQuery("body").removeClass("modal-open");var baseUrlRegEx;var baseURI=document.baseURI;if(!baseURI){var baseTags=
document.getElementsByTagName("base");baseURI=baseTags.length?baseTags[0].href:document.URL}var pathName=baseURI.replace(window.location.origin,"");if(next.baseUrl)baseUrlRegEx=new RegExp(next.baseUrl);if(!next.baseUrl){if(pathName.indexOf("/auctions/")!=-1&&pathName!="/")location.replace(defaultBaseUrl+$location.url())}else if(!baseUrlRegEx.test(pathName)){var baseUrl=appInit.localeString=="en"?"/"+next.baseUrl:"/"+appInit.localeString+"/"+next.baseUrl;location.replace(baseUrl+$location.url())}}catch(e){console.error(e)}});
function scrollToPoint(key){try{var pageName=key;var scrollPosition=localStorageService.get(pageName+"-scrollPosition");localStorageService.remove(pageName+"-scrollPosition");if(scrollPosition)setTimeout(function(){jQuery("html,body").animate({scrollTop:scrollPosition},500)},1)}catch(e){console.error(e)}}$scope.$on("$routeChangeSuccess",function(scope,next,current){setTimeout(function(){window.scrollTo(0,0)},1);try{self.noAds=window.appInit.isTopBuyer;var pixelId=self.locale.getMessage("app.facebook.Pixel.ID");
if(pixelId>0)facebookPixel(next.$$route,pixelId);if(next.$$route){var invokeSiteCatalystEvent=next.$$route.invokeSiteCatalystEvent;setTimeout(function(){window.scrollTo(0,0)},1);if(!AppUtils.isUndefined(invokeSiteCatalystEvent)){console.log("Printing the event **** "+invokeSiteCatalystEvent);siteCatalyst.executeCall(invokeSiteCatalystEvent)}var scrollRestore=next?next.$$route.scrollRestore?true:false:false;if(scrollRestore){var pageName=next.$$route.scrollRestoreKey;window.pageName=pageName;var waitForEvent=
next.$$route.scrollOnEvent;if(waitForEvent)jQuery(window).one("scrollToPoint",function(){scrollToPoint(window.pageName)});else scrollToPoint(window.pageName)}if(googletag)googletag.destroySlots();var pageName=next.$$route.pageName;if(pageName){if(next.$$route.originalPath.indexOf("/Content")==0||next.$$route.originalPath.indexOf("/content")==0)pageName=next.params.contentPath.replace(".html","").replace(/[^a-zA-Z ]/g,"-");else if(pageName=="registration")lm.Omniture.doTagBeginRegistration();else if(pageName.indexOf("locations_")>
-1)pageName+=next.params.yardNumber;else if(pageName.indexOf("lotdetail")>-1){s.products=";"+next.params.lotId.toString();s.events="prodView"}if(!AppUtils.isUndefined(next.pathParams.showAllPhotos))pageName="lotphotos";self.doTagPageView(pageName)}}}catch(e){log.error("Error in $routeChangeSuccess-\x3e "+e)}});self.userConfig=null;self.locale=null;self.ds=dataServiceG2;self.langOptions=[{name:"English",value:"en_us"},{name:"Español",value:"es_es"},{name:"Nederlands",value:"nl_nl"}];BaseController(self,
{$sce:$sce,$window:$window,$compile:$compile,$filter:$filter,$locale:$locale,$timeout:$timeout,config:config});self.getSuggestion=function(val){var deferred=$q.defer();dataServiceG2.getSuggestion(val).then(function(response){deferred.resolve(response)},function errorCallback(response){deferred.reject("failed_to_get_suggestions_appcontroller");log.error("Error for getSuggestion returned in appcontroller"+response)});return deferred.promise};self.setAccountType=loginService.setAccountType;self.goToSellerLogin=
function(){$window.location.href=appConfigService.getEnvConfigProps().sellerLoginURL};self.changeTimezone=function(saveNewTimeZone){copartUser.changeTimezone(saveNewTimeZone);if(saveNewTimeZone)dataServiceG2.updateUserConfig(userService.userConfig,$route).then(function(data){auctionsCalendarService.getAuctionsCalender(true).then(function(){$route.reload()})})};self.refreshAndGetUser=function(){self.userConfig=copartUser.refreshAndGetUser()};self.changePopupLanguage=function(selectedLang){self.selectedLang=
selectedLang};self.showSelectUrl=function(mySelecturl){$window.location.href=mySelecturl};self.changeLanguage=function(selectedLang){self.locale=self.localeModal;var data=userService.userConfig;data.selectedLang=selectedLang;dataServiceG2.updateUserConfig(data).then(function(){var port=$location.port();var newURL=port!=undefined&&port!=null?$location.host()+":"+port+"/":$location.host()+"/";newURL=$location.$$protocol+"://"+newURL+selectedLang+$location.url();$window.location.href=newURL})};self.routeReload=
function(path){var url=$location.path();if(path==url)$route.reload()};self.openLink=function($event){var link=$($event.target).find("a").attr("href");if(!_.isEmpty(link))window.open(link,"_blank");$("#lang").val(userService.userConfig.siteCode)};self.redirectURL=function(url){$location.url(url)};self.doTagPageView=function(pageName){try{if(window.location.hash!="#data\x3drefresh"){var prefix="";if(userService.isAnonymous())prefix="public:";else prefix="member:";s.pageName=prefix+pageName;if(self.userConfig.siteCode==
"CRTSUS")s.server="crashedtoys.com";else s.server="copart.com";s.channel="public";s.pageType="";lm.Omniture.PageName=s.pageName;s.prop1=s.pageName;var s_code=s.t();if(s_code)document.write(s_code);lm.Omniture.ClearVars()}else window.location.hash=""}catch(e){log.error("Site Catalyst call unsuccessful")}};self.submitFeedBack=function(feedback){dataServiceG2.postFeedback(feedback,function(response){console.log("Thankyou! Feedback sent !")});$("#feedback").modal("hide")};var fetchTitleDescription=function(){var parentFragmentId=
"Content/US/EN/Title-Description";cmsContentService.setParentFragment(parentFragmentId).then(function(){var titleDescription=cmsContentService.getFragmentContent(parentFragmentId);if(typeof titleDescription==="object"&&titleDescription!==null){self.locale.titleDescription=titleDescription;metaDataService.refresh(self.locale)}else log.error("Invalid title/description fetched from CMS.")})};var updateLanguageTags=function(){var languageMeta=self.locale.messages["app.meta.language"];if(languageMeta)$rootScope.languageMeta=
languageMeta};self.init=function(){log.info("Loading {} {} - please wait ...",config.appName,config.appRelease);log.debug("Application config\x3d{}",JSON.stringify(config));self.userConfig=copartUser.config;self.selectedLang=self.userConfig.selectedLang;self.locale=dataServiceG2.getLocale();self.localeModal=self.locale;self.country="";dataServiceG2.getCldrData(self.locale.lang,config.locale.territory,function(response){Globalize.load(response);var thisLocale=config.locale.territory&&config.locale.territory!=
""?self.locale.lang+"-"+config.locale.territory:self.locale.lang;Globalize.locale(thisLocale);app.globalizeNumberFormatter=Globalize.numberFormatter();self.locale.cldrData=response;if(app.globalizeNumberFormatterPromise)app.globalizeNumberFormatterPromise.resolve(app.globalizeNumberFormatter)});dataServiceG2.getQuickPickCounts("HOME");if(self.userConfig.selectedLang==null)self.userConfig.selectedLang="en";if(self.timeZones==null)self.timeZones=moment.tz.names();globalLicenceCategory=self.userConfig.licenceCategory;
dataServiceG2.loadReferenceData(function(appConfigData){appConfigService.updateAppConfigWithMoreData(appConfigData.data)});dataServiceG2.getEnvConfigProps(function(evnConfigPropertiesData){appConfigService.setEnvConfigProps(new EnvConfigProps(evnConfigPropertiesData))});appConfigService.getLocationsListBySite(function(response){self.tempLocations=response;self.yardLocations=_.filter(self.tempLocations,function(item){if(item.yardName.charAt(0)!="*"&&item.yardName.indexOf("-")==3)return item})});fetchTitleDescription();
updateLanguageTags()};self.init();copartUser.initializeTime();$interval(copartUser.updateTime,1E4);self.zipCodeError=false;self.locationError=false;self.nearestLocationModal={};self.lookForNearestLocation=function(modal){self.zipCodeError=false;self.locationError=false;if(modal.zip)geocodingService.getCoordinatesForZip(modal.zip,function(retData){if(retData.status==-1){self.resetLocationForm();document.getElementById("PostalCode1").value="";return}var zipObject={};_.defaults(zipObject,{latitude:"*",
longitude:"*",miles:9999});zipObject.latitude=retData.latitude;zipObject.longitude=retData.longitude;if(self.miles)zipObject.miles=self.miles;var zipQuery=$interpolate("{!geofilt pt\x3d{{latitude}},{{longitude}} sfield\x3dyard_location d\x3d{{miles}}}")(zipObject);var data={query:["*"],filter:{MISC:[encodeURIComponent(zipQuery)]},sort:["geodist() asc"],rawParams:{sfield:"yard_location",pt:zipObject.latitude+","+zipObject.longitude}};dataServiceG2.getNearestLocationDetail(data,function(response){self.yardDetails=
response.data;auctionsCalendarService.auctionByYard(self.yardDetails.yardNumber).then(function(data){self.yardDetails.nextAuction=data.currentSaleTimeEpoch});modal.foundLocation=true})});else if(modal.yardLocation)dataServiceG2.getLocationDetail(modal.yardLocation,function(response){self.yardDetails=response.data;auctionsCalendarService.auctionByYard(self.yardDetails.yardNumber).then(function(data){self.yardDetails.nextAuction=data.currentSaleTimeEpoch});modal.foundLocation=true});else{self.zipCodeError=
true;self.locationError=true}};self.resetLocationForm=function(){self.nearestLocationModal.foundLocation=false;self.nearestLocationModal.zip="";self.nearestLocationModal.yardLocation=""};self.payAllUK=function(fromRequest){var requestParam={};requestParam.GATEWAY_URL_KEY="PAY_ALL_UK";dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=response.data.pciURL.trim();else log.error("Error in Gateway")})};self.doLogout=function(){$window.location.href=
"/logout"};var contentPage;$.bbq.pushState=function(pageObject){console.log("Page number-"+pageObject.page);contentPage=pageObject.page;$location.search("page",pageObject.page);$timeout(function(){$rootScope.$digest()},0)};$.bbq.getState=function(stateParam){var ret=$location.search()[stateParam];return ret}}]);app.getControllerScope=function(scope){while(!AppUtils.isUndefined(scope)&&AppUtils.isUndefined(scope.ds))scope=scope.$parent;return scope};"use strict";
app.service("loginService",["$http","dataServiceG2","$rootScope","$location","urlService","$window","functionQueueService","siteCatalyst","localStorageService",function($http,dataServiceG2,$rootScope,$location,urlService,$window,functionQueueService,siteCatalyst,localStorageService){var self=this;var thisLocale=dataServiceG2.getLocale();var statusEnum={ERROR:"ERROR",SUCCESS:"SUCCESS",PASSWORD_EXPIRED:"PASSWORD_EXPIRED",FORGET_PASSWORD:"FORGET_PASSWORD",ACCOUNT_VOIDED:"ACCOUNT_VOIDED",ACCOUNT_SUSPENDED:"ACCOUNT_SUSPENDED",
UPDATE_BROKER_BIDDER_EMAIL:"UPDATE_BROKER_BIDDER_EMAIL"};self.accountTypeValues=[];self.loginAlerts=[];self.accountType=null;self.preLoginFunction=null;self.initAccountTypes=function(){self.accountTypeValues=[{value:"0",description:"Member"},{value:"1",description:"Seller"},{value:"2",description:"Counterman"}]};self.setAccountType=function(index){self.accountType=self.accountTypeValues[parseInt(index)];if(!$rootScope.redirectAfterLoginUrl)urlService.redirectUrl=$location.url();else urlService.redirectUrl=
$rootScope.redirectAfterLoginUrl;$rootScope.$emit("accountTypeChanged",self.accountType)};self.submitForm=function(action,form,isFirstTime){if(form.accountType.value!=1)if(validateForm(form)){form.accountTypeValue=form.accountType.value;if(self.preLoginFunction&&jQuery.isFunction(self.preLoginFunction)){self.preLoginFunction();self.preLoginFunction=null}$("#password").attr("disabled","disabled");$http({url:action,method:"POST",data:form}).success(function(data,status,headers,config){$("#password").removeAttr("disabled");
if(data.data.result=="updateBrokerBidderEmail")$window.location.href=urlService.updateBrokerBidderEmail;else if(data.data.result=="success"){functionQueueService.executeQueue();lm.Omniture.doTagLoginSuccess(form.username);if($rootScope.storeUserURl==""||$rootScope.storeUserURl==undefined||$rootScope.storeUserURl==null){history.pushState(null,null,"/");$window.location.href=urlService.redirectUrl}else{$window.location.href=$rootScope.storeUserURl;$rootScope.storeUserURl==""}if(form.rememberme)localStorageService.cookie.set("username",
form.username,365);else localStorageService.cookie.set("username","",365)}else if(data.data.error==statusEnum.PASSWORD_EXPIRED)$window.location.href=urlService.pwdExpired;else if(data.data.error==statusEnum.FORGET_PASSWORD)$window.location.href=urlService.forgetPassword;else if(data.data.error==statusEnum.ACCOUNT_SUSPENDED)addLoginAlerts("danger",thisLocale.messages["app.errorMessage.suspended.buyer"],isFirstTime);else if(data.data.error=="incorrectCredentials")addLoginAlerts("danger","Unable to continue. The following error needs to be corrected:The User ID or password provided is incorrect",
isFirstTime)}).error(function(data,status,headers,config){if(data!=undefined&&data!=null){var dbMessage=data.message;if(dbMessage!=undefined&&dbMessage!=null)if(dbMessage.indexOf("BadCredentialsException">-1)){var userMessage=dbMessage.substring(dbMessage.indexOf(":"),dbMessage.length);addLoginAlerts("danger","Unable to continue."+userMessage,isFirstTime)}}else addLoginAlerts("danger","Unable to continue. The following error needs to be corrected:The User ID or password provided is incorrect",isFirstTime)});
return true}else{if(isFirstTime)$window.location.href="/tempPasswordExpired";return false}};var validateForm=function(form){var username=form.username;var password=form.password;self.resetLoginErrors();if(/\s/.test(username)){addLoginAlerts("danger","Spaces are not allowed in User ID");return false}if(isDecimalIfNumber(username)){addLoginAlerts("danger","Decimals are not allowed in User ID");return false}if(!username||0===username.length){addLoginAlerts("danger","Email/User ID is required");return false}if(!password||
0===password.length){addLoginAlerts("danger","Password is required");return false}if(!username&&!password){addLoginAlerts("danger","Unable to continue. The following error needs to be corrected:The User ID or password provided is incorrect");return false}if(!username||username.length>40){addLoginAlerts("danger","Unable to continue. The following error needs to be corrected:The User ID or password provided is incorrect");return false}if(isNaN(username))if(!validateEmail(username)){addLoginAlerts("danger",
"Unable to continue. The following error needs to be corrected:The User ID or password provided is incorrect");return false}if(password.length<5||password.length>10){addLoginAlerts("danger","Unable to continue. Your password must be between 5 and 10 characters long");return false}else return true};function isDecimalIfNumber(username){var invalidCharList=[];if(username&&!isNaN(username)){var onlyDigitsPattern=/^-?[0-9]+$/;if(!onlyDigitsPattern.test(username))return true}return false}self.resetPwdForm=
{};self.emailPassword=function(isIDProvided){if(!isIDProvided)self.resetPwdForm.showEmailRequiredError=true;else if(!isNaN(self.resetPwdForm.userIDOrEmail)||validateEmail(self.resetPwdForm.userIDOrEmail)){if(!isNaN(self.resetPwdForm.userIDOrEmail))if(self.resetPwdForm.userIDOrEmail.length>6){self.resetPwdForm.showEmailRequiredError=true;return}dataServiceG2.emailPassword(self.resetPwdForm.userIDOrEmail,function(response){if(response.returnCode==1){$("#forgotuserid").modal("hide");$("#Successforgotuserid").modal("show")}else if(response.returnCodeDesc==
"InvalidUserID")self.resetPwdForm.showEmailRequiredError=true;else if(response.returnCodeDesc=="UnknownError"){$("#forgotuserid").modal("hide");$("#forgotuseridFailed").modal("show")}else{$("#forgotuserid").modal("hide");$("#forgotuseridFailed").modal("show")}})}else self.resetPwdForm.showEmailRequiredError=true};function validateEmail(email){var emailReg=/^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/;if(!emailReg.test(email))return false;else return true}var addLoginAlerts=function(type,msg,isFirstTime){if(isFirstTime)$window.location.href=
"/tempPasswordExpired";else self.loginAlerts.push({msg:msg,type:type})};self.resetLoginErrors=function(){self.loginAlerts.splice(0,self.loginAlerts.length)};self.closeLoginAlert=function(index){self.loginAlerts.splice(index,1)}}]);
app.controller("loginController",["$scope","$http","$location","$rootScope","$routeParams","urlService","dataServiceG2","loginService","localStorageService","appConfigService","userService","$window",function($scope,$http,$location,$rootScope,$routeParams,urlService,dataServiceG2,loginService,localStorageService,appConfigService,userService,$window){var self=$scope;var rememberedID=localStorageService.cookie.get("username");self.form={username:rememberedID};if(typeof rememberedID!=="undefined"&&rememberedID!==
null&&rememberedID!=="")self.form.rememberme=true;loginService.initAccountTypes();self.showError=null;self.locale=self.$parent.locale;if($location.search().redirectUrl)urlService.redirectUrl=$location.search().redirectUrl;self.accountTypeValues=loginService.accountTypeValues;if(userService.userConfig.siteCode=="CPRTCA"||userService.userConfig.siteCode=="CPRTUK"||userService.userConfig.siteCode=="CPRTMEA")self.accountTypeValues=self.accountTypeValues.filter(function(obj){return obj.value!="2"});if(userService.userConfig.siteCode==
"CPRTIE")self.accountTypeValues=self.accountTypeValues.filter(function(obj){return obj.value==="0"});if(_.isNull(loginService.accountType))self.form.accountType=self.accountTypeValues[0];else self.form.accountType=loginService.accountType;loginService.loginAlerts=[];self.loginAlerts=loginService.loginAlerts;self.closeLoginAlert=loginService.closeLoginAlert;self.emailPassword=function(isIDProvided){loginService.emailPassword(isIDProvided);self.resetPwdForm=loginService.resetPwdForm};self.submitForm=
loginService.submitForm;self.resetPwdForm=loginService.resetPwdForm;var accountTypeChangedEvent=$rootScope.$on("accountTypeChanged",function(event,data){self.form.accountType=data});$scope.$on("$destroy",function(){accountTypeChangedEvent()});self.goToSellerLogin=function(){$window.location.href=appConfigService.getEnvConfigProps().sellerLoginURL};var token1=$location.search().token1;var token2=$location.search().token2;if(token1&&token2){var form={};form.username=token2;form.password=token1;form.accountType=
{};form.accountType.value="0";form.forgetPassword=true;loginService.submitForm("processLogin",form,true)}}]);
app.controller("homeContentController",["$scope","$http","$timeout","$locale","dataServiceG2","searchCriteria","$location","userService","copartUser","auctionsCalendarService",function($scope,$http,$timeout,$locale,dataServiceG2,searchCriteria,$location,userService,copartUser,auctionsCalendarService){var self=$scope;self.quickPicks=new QuickPicks;self.liveAuctions=0;self.pageId="HOME";var auctionsCountPromise=null;var quickPickCountUpdate=null;self.aucListLoading=false;self.todaysAuctionsList=[];
self.todaysDate=new Date;self.userConfig=copartUser.getUserConfig();self.isAnonymous=userService.isAnonymous();self.searchCriteria=searchCriteria;auctionsCalendarService.getAllAuctionData().then(function(data){var count=0;_.each(data.todayAuctions.liveAuctions,function(auction){if(auction.laneInfoList!=null)count=count+auction.laneInfoList.length});self.liveAuctions=count;self.auctionList=_.clone(data.todayAuctions.liveAuctions);if(data.todayAuctions.laterAuctions.length>0)_.each(data.todayAuctions.laterAuctions,
function(auctions){if(auctions.yard.number!=770&&auctions.yard.number!=771)self.auctionList.push(auctions)});self.aucListLoading=false});self.init=function(){self.aucListLoading=true;searchCriteria.MISC=[]};self.init();self.searchQuickPicks=function(query){self.searchCriteria.MISC.push(query);return true};$scope.$on("$destroy",function(){if(auctionsCountPromise)$timeout.cancel(auctionsCountPromise);if(quickPickCountUpdate)$timeout.cancel(quickPickCountUpdate)})}]);
app.controller("myBidsController",["$scope","$filter","$http","$locale","$routeParams","copartUser","userService","$compile","config","$location","backToLinkService","dataServiceG2","saveLotNumbersService","auctionsCalendarService","appConfigService","localStorageService","History","dataTableConfig","watchListService",function($scope,$filter,$http,$locale,$routeParams,copartUser,userService,$compile,config,$location,backToLinkService,dataServiceG2,saveLotNumbersService,auctionsCalendarService,appConfigService,
localStorageService,History,dataTableConfig,watchListService){var self=$scope;self.locale=$scope.$parent.locale;var table=new ServersideDatatable_DB(saveLotNumbersService,dataTableConfig);watchListService.setWatchListDefinition($location.url());self.filterType=$routeParams.filterType;var buyerNumber=copartUser.getUserConfig().buyerNumber;self.yardDetails={};self.liveAuction=[];self.bidderList=null;self.watchList=[];self.images={};self.selectedBidder=null;self.backToLink=$location.url();backToLinkService.setBackToLink(self.backToLink);
self.selectedFilterType=self.locale.messages["app.label.all.bids"];var log=new Logger({name:"myBidsController",level:config.logLevel});function checkIfFromDetails(){try{var lastRoute=History.lastRoute;if(lastRoute&&(lastRoute.indexOf("lot/")==0||lastRoute.indexOf("invoiceDetails/")==0))return true;else return false}catch(e){return false}}var state=false;var stateRestoreFromAnywhere=localStorageService.get("restore-search-state-from-anywhere");localStorageService.remove("restore-search-state-from-anywhere");
if(checkIfFromDetails()||$location.search().state=="restore"||stateRestoreFromAnywhere)state=localStorageService.get("restore-search-state");var tableId="#mybids-datatable";if(self.filterType)if(self.filterType==="Winning"||self.filterType==="NotWinning"){self.url="/data/lots/currentBids/"+buyerNumber+"/0";if(self.filterType==="Winning")self.selectedFilterType=self.locale.messages["app.label.winning"];else self.selectedFilterType=self.locale.messages["app.label.outBid"]}else{if(self.filterType===
"currentBids")self.selectedFilterType=self.locale.messages["bidder.grid.title.currentbid"];else self.selectedFilterType=self.locale.messages["app.label.open.items"];self.url="/data/lots/"+self.filterType+"/"+buyerNumber+"/0"}else{self.url="/data/lots/myBids/"+buyerNumber+"/0";self.selectedFilterType=self.locale.messages["app.label.all.bids"]}table.overrideDefaults=function(data){var filterJSONString={filters:[]};var bidStatusFilter={};var lotStatusFilter={};var bidderFilter={};if($routeParams.filterType===
"Winning"){bidStatusFilter.filterBy="bidStatusStr";bidStatusFilter.filterValue=["H"];filterJSONString.filters.push(bidStatusFilter);lotStatusFilter.filterBy="lotStatus";lotStatusFilter.filterValue=["0"];filterJSONString.filters.push(lotStatusFilter)}else if($routeParams.filterType==="NotWinning"){bidStatusFilter.filterBy="bidStatusStr";bidStatusFilter.filterValue=["O"];filterJSONString.filters.push(bidStatusFilter);lotStatusFilter.filterBy="lotStatus";lotStatusFilter.filterValue=["0"];filterJSONString.filters.push(lotStatusFilter)}if(self.selectedBidder){bidderFilter.filterBy=
"bidderNumber";bidderFilter.filterValue=[self.selectedBidder];filterJSONString.filters.push(bidderFilter)}data.filterCriteria=JSON.stringify(filterJSONString)};self.findMake=function(make){if(!make)return make;var makeObj=_.find(self.appConfig.vehicleMakeandModels,function(obj){if(obj.type&&obj.type.trim()==make.trim())return true});return makeObj?makeObj.code.toUpperCase():make};var getWatchListForBuyer=function(){$http({method:"GET",url:"/data/lots/watchList"}).then(function successCallback(response){self.watchList=
response.data.data.watchList},function errorCallback(response){})};if(!userService.isAnonymous())getWatchListForBuyer();self.isAlreadyAdded=watchListService.isAlreadyAdded;self.addToWatchList=watchListService.addToWatchList;self.removeFromWatchList=watchListService.removeFromWatchList;self.isWatchList=watchListService.isWatchList();self.storeNavigationInfo=function(resultIndex){var info={backTo:"."+$location.url(),resultIndex:resultIndex};localStorageService.set("lot-navigation-info",info)};self.loadBidsData=
function(){saveLotNumbersService.clearAll();var dataTableOptions={"pageLength":20,"columnDefs":[{"targets":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14],"data":null,"defaultContent":""},{"targets":[0,14],"orderable":false},{"targets":["bidderNumber"],"visible":self.bidderList.length>1,"searchable":false},{className:"control",orderable:false,targets:-1}],"order":[[6,"desc"]],"lengthMenu":[[20,25,50,100],[20,25,50,100]],"url":self.url,"stateSave":state,"stateRetrieveFunction":function(data){self.selectedBidder=
data.selectedBidder;self.bidderList=data.bidderList;self.filterTable(self.selectedBidder)},"noResultMessage":self.locale.messages["mybids.nobidsfound"]+" \x3ca href\x3d'./Content/"+appInit.regionCode+"/"+appInit.localeString+"/Support/How-to-Buy/Place-Bids'\x3e"+self.locale.messages["mybids.learnBidding"]+"\x3c/a\x3e or \x3ca href\x3d'./vehicleFinder'\x3e "+self.locale.messages["mybids.findVehicles"]+"\x3c/a\x3e "+self.locale.messages["mybids.findVehicles.text2"],"noResultInfoMessage":"We Found 0 Vehicles",
"fnRowCallback":function(nRow,aData,iDisplayIndex){jQuery(".nowrap",nRow).attr("nowrap","nowrap");return nRow},"dom":'\x3c"top"lipf\x3c"clear"\x3e\x3ert\x3c"bottom"lipf\x3c"clear"\x3e\x3e',"columns":[{"mData":"imgp","render":function(data,type,row,meta){var description=row["yearOfVehicle"]+" "+row["makeOfVehicle"]+" "+row["modelOfVehicle"];var lotId=row["lotId"];var currentBid=row["currentBid"];if(row["lotStatus"]!="0")currentBid=row["myBid"];var backTo=self.backToLink;var resultIndex=meta.settings._iDisplayStart+
meta.row;var totalRecords=meta.settings._iRecordsTotal;var smallImageUrl=row["smallImage"].url;var rowSaleDate=row["saleDate"]?row["saleDate"]:0;var dateOfSale=rowSaleDate.dateAsInt?rowSaleDate.dateAsInt:0;var futureFlag=dateOfSale===0;var currencyCode=row["yard"]&&row["yard"].currency&&row["yard"].currency.code?row["yard"].currency.code:"";return"\x3cfigure\x3e"+"\x3ca lot-id\x3d'"+lotId+"' class\x3d'imgpath cursor-pointer' "+"lot-desc\x3d'"+description+"' "+"auction-date\x3d'"+row["saleDate"].date+
"' "+"currency-code\x3d'"+currencyCode+"' "+" images\x3d'images' current-bid\x3d'"+currentBid+"' modal-image-viewer back-to\x3d"+backTo+" result-index\x3d"+resultIndex+" total-records\x3d"+totalRecords+" yard\x3d"+row["yard"].number+" auction-lane\x3d"+row["auctionLane"]+" auction-date\x3d"+row["auctionDateUtc"]+" is-future\x3d"+futureFlag+" flag\x3d1\x3e\x3cspan class\x3d'searchiconbtn'\x3e\x3c/span\x3e"+"\x3cimg src\x3d'"+smallImageUrl+"' error-image\x3d'/images/testImages/no_photo.jpg' data-uName\x3d'imgThumbNail' /\x3e"+
"\x3c/a\x3e"+"\x3cfigcaption\x3e"+"\x3cdiv class\x3d'viewallphotos nowrap'\x3e"+"\x3ca class\x3d'image_viewer_link' href\x3d'./lotDetail/"+lotId+"/Photos?backTo\x3d/myBids'\x3e"+self.locale.messages["counterman.searchResults.viewAllPhotos.label"]+"\x3c/a\x3e"+"\x3c/div\x3e"+"\x3c/figcaption\x3e"+"\x3c/figure\x3e"}},{"mData":"lotNumber","render":function(data,type,row,meta){var lotId=row["lotId"];var resultIndex=meta.settings._iDisplayStart+meta.row;var totalRecords=meta.settings._iRecordsTotal;saveLotNumbersService.addLotNumber(lotId);
return"\x3ca href\x3d'./lot/"+lotId+"' ng-click\x3d'storeNavigationInfo("+resultIndex+")'\x3e"+lotId+"\x3c/a\x3e\x3cbr/\x3e"+"\x3cbutton class\x3d'black-line watch-btn' ng-hide\x3d'isAlreadyAdded("+lotId+")' ng-click\x3d'addToWatchList("+lotId+")' data-uName\x3d'watchListButton'\x3e"+self.locale.messages["app.label.watch"]+"\x3c/button\x3e"+"\x3cbutton class\x3d'black-line watch-btn watched' ng-hide\x3d'!isAlreadyAdded("+lotId+")' ng-click\x3d'removeFromWatchList("+lotId+")' data-uName\x3d'watchListButton'\x3e"+
self.locale.messages["app.label.remove"]+"\x3c/button\x3e"}},{"mData":"lotyear","render":function(data,type,row){if(row["lotIcons"]){var iconCodes=_.intersection(row["lotIcons"],self.validIconCodes);var template="\x3cspan data-uname\x3d'lotsearchLotcenturyyear'\x3e"+row["yearOfVehicle"]+"\x3c/span\x3e\x3cbr\x3e";return self.generateIconTemplate(template,iconCodes)}return row["yearOfVehicle"]}},{"mData":"lotMake","render":function(data,type,row){return row["makeOfVehicle"]}},{"mData":"lotModel","render":function(data,
type,row){return row["modelOfVehicle"]}},{"mData":"itemNumber","render":function(data,type,row){return row["itemNumber"]}},{"mData":"yardName","render":function(data,type,row){var yardNumber=row["yard"].number;return"\x3ca class\x3d'cursor-pointer' data-uname\x3d'lotLocation' href\x3d'./locationDetail/"+yardNumber+"' target\x3d'_blank'\x3e"+row["yard"].name+"\x3c/a\x3e\x3c/td\x3e"}},{"mData":"saleDateStr","render":function(data,type,row){var isFuture=row["saleDate"].dateAsInt===0;var html="\x3cul class\x3d'list-unstyled'\x3e";
html+="\x3cli ng-if\x3dliveAuction["+row["lotId"]+'] class\x3d"btn btn-success"\x3e'+self.locale.messages["app.label.live.now"]+"\x3c/li\x3e";html+="\x3cli ng-if\x3d'(!liveAuction["+row["lotId"]+"] \x26\x26 "+isFuture+")' data-uName\x3d'saleDate'\x3e"+self.locale.messages["app.label.future"]+"\x3c/li\x3e"+"\x3cli ng-if\x3d'(!liveAuction["+row["lotId"]+"] \x26\x26 "+!isFuture+")' data-uName\x3d'saleDate'\x3e"+$filter("globalize_format_date")(row["saleDate"].date,"medium")+"\x3c/li\x3e";html+="\x3c/ul\x3e";
return html}},{"mData":"odometerReading","render":function(data,type,row){return $filter("globalize_number")(row["odometerReading"])+" "+row["odometerType"]}},{"mData":"docType","render":function(data,type,row){return row["docType"]}},{"mData":"damageType","render":function(data,type,row){return row["damageType"].toTitleCase()}},{"mData":"actualCostOfVehicle","render":function(data,type,row){return $filter("globalize_currency_using_code")(row["actualCostOfVehicle"],row["yard"]&&row["yard"].currency&&
row["yard"].currency.code?row["yard"].currency.code:"")}},{"mData":"bidderNumber","sClass":"bidderNumber","render":function(data,type,row){return row["bidderNumber"]}},{"mData":"bidStatus","render":function(data,type,row,meta){var html="\x3cul class\x3d'list-unstyled'\x3e";var lotId=row["lotId"];var resultIndex=meta.settings._iDisplayStart+meta.row;var totalRecords=meta.settings._iRecordsTotal;if(row["lotStatus"]=="0")html+="\x3cli\x3e"+self.locale.messages["app.label.currentBid"]+":\x3c/li\x3e"+
"\x3cli data-uname\x3d'currentBid'\x3e "+$filter("globalize_currency_using_code")(row["currentBid"],row["yard"]&&row["yard"].currency&&row["yard"].currency.code?row["yard"].currency.code:"")+"\x3c/li\x3e";if(row["lotStatus"]!="0")html+="\x3cli\x3e"+self.locale.messages["app.label.currentBid"]+":\x3c/li\x3e"+"\x3cli data-uname\x3d'currentBid'\x3e"+$filter("globalize_currency_using_code")(row["myBid"],row["yard"]&&row["yard"].currency&&row["yard"].currency.code?row["yard"].currency.code:"")+"\x3c/li\x3e";
if(row["bidStatus"]){if(row["bidStatus"]==="RELIST_FEES_DUE")html+="\x3cli class\x3d'btn btn-success' data-uName\x3d'lotStatus'\x3e"+self.locale.messages["app.label.winning"]+"\x3c/li\x3e";if(row["bidStatus"]==="OUT_BID")html+="\x3cli class\x3d'btn btn-danger' data-uName\x3d'lotStatus'\x3e"+self.locale.messages["lotdetail.bidStatus.outBid"]+"\x3c/li\x3e"}if(row["lotStatus"]=="2")html+="\x3cli class\x3d'btn btn-warning' data-uName\x3d'lotStatus'\x3e"+"\x3ca href\x3d'./lotDetail/"+lotId+"?resultIndex\x3d"+
resultIndex+"\x26totalRecords\x3d"+totalRecords+"\x26backTo\x3d{{backToLink}}\x26flag\x3d1'\x3e"+self.locale.messages["lotdetail.bidStatus.AWAITING_SELLER_RESPONSE"]+"\x3c/a\x3e\x3c/li\x3e";if(row["lotStatus"]=="3")html+="\x3cli class\x3d'btn btn-warning' data-uName\x3d'lotStatus'\x3e"+self.locale.messages["lotdetail.bidStatus.AWAITING_APPROVAL"]+"\x3c/li\x3e";if(row["lotStatus"]=="1")html+="\x3cli class\x3d'btn btn-warning' data-uName\x3d'lotStatus'\x3e"+"\x3ca href\x3d'./lotDetail/"+lotId+"?resultIndex\x3d"+
resultIndex+"\x26totalRecords\x3d"+totalRecords+"\x26backTo\x3d{{backToLink}}\x26flag\x3d1'\x3e"+self.locale.messages["lotdetail.bidStatus.SELLER_COUNTERED"]+"\x3c/a\x3e\x3c/li\x3e";html+="\x3c/ul\x3e";return html}},{"mData":"maxBid","render":function(data,type,row){var html="";var lotId=row["lotId"];self.testCounter=0;auctionsCalendarService.isAuctionLive(row["yard"].number,row["auctionLane"],row["saleDate"].date).then(function(flag){self.liveAuction[lotId]=flag});if(row["lotStatus"]!="1"&&row["lotStatus"]!=
"2"&&row["lotStatus"]!="3"){html="\x3cul class\x3d'list-unstyled' ng-if\x3d'liveAuction["+lotId+"]'\x3e\x3cli\x3e";html+='\x3ca data-toggle\x3d"modal" id\x3d"join-auction-laneselector"'+'href\x3d"./auctionDashboard?auctionDetails\x3d'+row["yard"].number+"-"+row["auctionLane"]+'" class\x3d"button small blue ajax btn btn-green"\x3e'+self.locale.messages["app.label.joinAuction"]+"\x3c/a\x3e";html+="\x3c/li\x3e\x3c/ul\x3e";html+="\x3cul class\x3d'list-unstyled' ng-if\x3d'!liveAuction["+lotId+"]'\x3e";
html+="\x3cli\x3e"+self.locale.messages["app.label.myMaxBid"]+":\x3c/li\x3e"+"\x3cli data-uname\x3d'maxBid'\x3e "+$filter("globalize_currency_using_code")(row["myMaxBid"],row["yard"]&&row["yard"].currency&&row["yard"].currency.code?row["yard"].currency.code:"")+"\x3c/li\x3e"+"\x3cli\x3e\x3ca href\x3d'./lotDetail/"+lotId+"' class\x3d'btn btn-primary' data-uName\x3d'increaseBid'\x3e"+self.locale.messages["app.label.increaseBid"]+"\x3c/a\x3e\x3c/li\x3e"+"\x3c/ul\x3e"}return html}},{"mData":"","render":function(data,
type,row){return""}}]};var datatable=table.initServerSideDataTable("#serverSideDataTable",dataTableOptions,function(){self.compileDom("#serverSideDataTable")});datatable.on("stateSaveParams.dt",function(e,settings,data){data.selectedBidder=self.selectedBidder;data.bidderList=self.bidderList});datatable.on("responsive-display.dt",function(e,datatable,row){$compile(row.child())(self)})};dataServiceG2.getBidderStatusList(function(responseData){console.log(responseData);if(responseData.returnCode==-1)log.error("Error");
else{self.bidderList=responseData.data;self.loadBidsData()}});self.filterTable=function(bidder){self.selectedBidder=bidder;console.log("calling filtering"+bidder);self.reloadTable()};self.compileDom=function(table){var $dest=jQuery(table).find("tbody");var retn=$compile($dest)($scope);self.$apply()};self.reloadTable=function(){var temptable=jQuery("#serverSideDataTable").DataTable();temptable.ajax.url(self.url).load()};var highlightIcons=_.where(appConfigService.appConfig.highlightIcons,{iconType:"H"});
self.validIconCodes=_.pluck(highlightIcons,"iconCode");self.generateIconTemplate=function(template,iconCodes){template=template+'\x3cspan copart-vehicle-iconss class\x3d" highlighticon""\x3e ';for(var i=0;i<iconCodes.length;i++){var code=iconCodes[i];template+='\x3ca lot-highlights-tool-tip fragment-id\x3d"'+code+'" class\x3d"icon-tooltip popover-parent" data-placement\x3d"auto right" data-toggle\x3d"popover" data-container\x3d".mybids"\x3e'+'\x3cspan class\x3d"vehicleicon"\x3e\x3cimg src\x3d"../images/global/highlightIcons-'+
appInit.regionCode+'.png" class\x3d"lotIcon-'+code+' bid-icon-img"\x3e\x3c/span\x3e\x3c/a\x3e'}template=template+"\x3c/span\x3e";return template}}]);
app.controller("AccountInfoController",["$scope","$http","$locale","$location","$filter","$routeParams","dataServiceG2","accountInfoDataService","copartUser",function($scope,$http,$locale,$location,$filter,$routeParams,dataServiceG2,accountInfoDataService,copartUser){var self=$scope;self.locale=$scope.$parent.locale;self.activeTab=$routeParams.navMenu;self.showEdit=false;var init=function(){accountInfoDataService.getDepositRefundDetails().then(function(response){self.showHideDepositBalance=response})};
init()}]);
app.controller("accountInfoFormsController",["$scope","$locale","cmsContentService",function($scope,$locale,cmsContentService){var self=$scope;self.locale=$scope.$parent.locale;var parentFragmentId="Content/US/EN/Forms/Buyer_FormsList_JSON";var fragmentId="forms_list";self.formsArray=[];var init=function(){cmsContentService.setParentFragment(parentFragmentId).then(function(){var fragmentedCms=jQuery(cmsContentService.getFragmentContent(parentFragmentId));self.formsArray=fragmentedCms[0].forms_list})};init()}]);
app.controller("AccountInfoLicenseController",["$scope","$locale","copartUtils","dataServiceG2","$sce",function($scope,$locale,copartUtils,dataServiceG2,$sce){var self=$scope;self.licenseRecords={};self.licenseFile={};self.locale=$scope.$parent.locale;self.validFileFormats="pdf,jpg,jpeg,tif,tiff,png,gif";self.reset=function(){$("#uploadLicenseStatus").modal("hide");$("#uploadLicenseModal").modal("hide");self.wlWaiting=false;self.message=null};self.reset();self.getLicenseInfo=function(){dataServiceG2.getLicenseInfo(function(response){self.licenseRecords=
response.data.licenseInfoList},function(errorResponse){console.log("Error occured"+errorResponse)})};self.getLicenseInfo();self.uploadLicense=function(updateLicense){self.wlWaiting=false;self.uploadStatus=null;self.message=null;if(typeof self.licenseFile=="undefined"||typeof self.licenseFile.name=="undefined"){self.message=self.locale.getMessage("app.acctInfo.uploadLicense.noFileSelected");return false}else if(!self.validateFile())self.message=self.locale.getMessage("app.acctInfo.uploadLicense.validationMessage");
else if(self.licenseFile.size>3145728)self.message=self.locale.getMessage("app.acctInfo.uploadLicense.sizeLimitValidationMessage");else{var formData=new FormData;formData.append("file",self.licenseFile);formData.append("applicationName","G2MBR");formData.append("destination","CAS");formData.append("fileType","DOCUMENT");formData.append("documentType","BUYER_LICENSE");formData.append("objectType","MEMBER");formData.append("country","US");dataServiceG2.uploadLicense(formData,function(response){if(response.returnCodeDesc==
"Success"){self.uploadStatus=true;self.getLicenseInfo()}else{self.uploadStatus=false;console.log("Error occurred while uploading the license document!")}$("#uploadLicenseStatus").modal("show");$("#uploadLicenseModal").modal("hide");self.wlWaiting=false;self.getLicenseInfo()});self.wlWaiting=true}};self.validateFile=function(){var _validFormatsArray=copartUtils.splitIntoArray(self.validFileFormats,",",true);return copartUtils.validateFile(self.licenseFile,_validFormatsArray)};self.triggerClickOnFileSelect=
function(){$("#fileInputSelect").click()};self.clearAndSetValue=function(){self.message=null;document.getElementById("file_name").value=""}}]);
app.controller("accountInfoChangePwdController",["$scope","$http","$locale","$routeParams","$location","$window","copartUser","dataServiceG2",function($scope,$http,$locale,$routeParams,$location,$window,copartUser,dataServiceG2){var self=$scope;self.accountInfoVO={};self.accountInfoVO.oldPassword;self.accountInfoVO.password;self.accountInfoVO.confirmPassword;self.isError=null;self.locale=$scope.$parent.locale;self.forgetPassword=$location.search().fp;self.changePassword=function(isExpired){if(self.forgetPassword===
"true")self.accountInfoVO.forgetPassword=true;if(self.accountInfoVO.password.length!=self.accountInfoVO.confirmPassword.length||self.accountInfoVO.password!=self.accountInfoVO.confirmPassword){self.errorDesc=self.locale.getMessage("app.accountinformation.error.confirm.mismatch");self.isError=true;return}dataServiceG2.changePassword(self.accountInfoVO,function(response){var responseCode=response.data.data.errorMsg;var responseCodeDesc=response.data.returnCodeDesc;if(responseCode!=null&&responseCode.trim()!=
""&&responseCodeDesc!=null&&responseCodeDesc.trim()!="Success"){self.isError=true;var temp=self.locale.getMessage("app.accountinformation.error.errorcode."+responseCode.trim());if(temp!=null&&temp!="")self.errorDesc=temp;else self.errorDesc="Unknown Error"}else{self.isError=false;self.errorDesc=self.locale.getMessage("app.accountinformation.error.errorcode.chgPwd.SUCCESS");if(isExpired)if(copartUser.refreshAndGetConfig().isUpdateEmailRequired)$location.path("/updateBrokerBidderEmail");else{jQuery("#memberModal").removeClass("fade").modal("hide");
$window.location.href="/dashboard"}}})};self.cancelChangePassword=function(){$location.path("/logout")}}]);app.controller("accountInfoContactDetailsController",["$scope","$http","$locale","$routeParams","$location","copartUser",function($scope,$http,$locale,$routeParams,$location,copartUser){var self=$scope;self.locale=$scope.$parent.locale;self.contactInfo={};$http.get("/data/contactinfo").then(function(response){self.contactInfo=response.data},function(response){console.log("Error retrieving forms")})}]);
app.controller("accountInfoFinanceController",["$scope","$http","$locale","$routeParams","$location","copartUser","dataServiceG2","urlService",function($scope,$http,$locale,$routeParams,$location,copartUser,dataServiceG2,urlService){var self=$scope;self.locale=$scope.$parent.locale;self.accountInfoVO=new AccountInfo;self.financeVOList={};self.isError=null;self.errorMsg=null;self.loadingFinance=false;self.getFinanceInfo=function(){dataServiceG2.getFinanceInfo(function(response){if(response.returnCodeDesc==
"Success"){self.financeVOList=response.data.financeList;for(var i=0;i<self.financeVOList.length;i++)if(self.financeVOList[i].providerURL!==undefined&&self.financeVOList[i].providerURL!==""&&!self.financeVOList[i].providerURL.toLowerCase().startsWith("http"))self.financeVOList[i].providerURL="http://"+self.financeVOList[i].providerURL}})};self.verifyFinanceAccount=function(){self.loadingFinance=true;dataServiceG2.verifyFinanceAccount(self.accountInfoVO,function(response){var errorCode=response.data.accountInfoVO.errorCode;
var validDealerFlag=response.data.accountInfoVO.validDealerFlag;if(errorCode!=null&&errorCode.trim()!=""||validDealerFlag=="N"){if(errorCode.trim()=="")self.errorMsg=self.locale.getMessage(self.locale.getMessage("app.acctInfo.verifyFinance.error.errorcode.common"));else self.errorMsg=self.locale.getMessage("app.acctInfo.error.errorcode."+errorCode.trim())+". "+self.locale.getMessage("app.acctInfo.verifyFinance.error.errorcode.common");self.isError=true;self.isSuccess=false}else{self.errorMsg=self.locale.getMessage("app.accountInfo.success.accountVerified");
self.isError=false;self.loadingFinance=false;self.isSuccess=true}})};self.getAvailableBalance=function(){self.loadingFinance=true;dataServiceG2.getAvailableBalance(self.accountInfoVO,function(response){var errorCode=response.data.accountInfoVO.errorCode;if(errorCode!=null&&errorCode.trim()!=""){self.errorMsg=self.locale.getMessage("app.acctInfo.error.errorcode."+errorCode.trim())+". "+self.locale.getMessage("app.acctInfo.verifyFinance.error.errorcode.common");self.isError=true}else{self.errorMsg=
"";self.availableBalance=response.data.accountInfoVO.availableBalance;self.isError=false;self.date=moment().format("MM/DD/YYYY hh:mm A zz");self.loadingFinance=false}})};self.resetData=function(){self.errorMsg="";self.isError=false;self.accountInfoVO.dealerID="";self.loadingFinance=false};self.initialize=function(){self.resetData();self.getFinanceInfo();self.getAvailableBalance()}()}]);
app.controller("AccountInfoDepositRefundController",["$scope","$locale","copartUtils","dataServiceG2","accountInfoDataService",function($scope,$locale,copartUtils,dataServiceG2,accountInfoDataService){var self=$scope;self.locale=$scope.$parent.locale;self.parentScope=self.$parent.$parent;self.depositRefundSection="";self.depositRefundStatus="";self.refundHistory={};self.refundRequest=0;self.totalRefundsIssued=0;self.currencyCode="";self.selectedCreditCard={};self.requestedRefundAmount=0;self.depositRefundRequest=
{};self.wlWaiting=true;self.wlRefundWaiting=null;self.getDepositRefundTransactionHistory=function(selectedCardNo){if(selectedCardNo===undefined||selectedCardNo===null){self.formSubmitted=true;return}self.depositRefundSection="depositRefundReview";self.wlWaiting=true;dataServiceG2.getDepositRefundTransactionHistory(selectedCardNo,function(response){var successCode=response.data.returnCodeDesc;if(successCode=="Success"){self.totalRefundsIssued=0;self.refundHistory=response.data.data.refundHistory;if(self.refundHistory!=
null&&self.refundHistory!=undefined)for(var i=0;i<self.refundHistory.length;i++){self.totalRefundsIssued=self.totalRefundsIssued+self.refundHistory[i].txAmt1;self.depositRefundRequest.currencyCode=self.refundHistory[i].txCurrencyCode1}self.depositRefundRequest.selectedCreditCard=_.filter(self.creditCards,function(item){return item.cardId===selectedCardNo});self.depositRefundRequest.requestedRefundAmount=self.depositRefundRequest.selectedCreditCard[0].availableAmount}self.wlWaiting=false})};var validateAmount=
function(requestedRefundAmount){if(!isNaN(requestedRefundAmount))if(self.depositRefundRequest.requestedRefundAmount>self.depositRefundRequest.selectedCreditCard[0].availableAmount)self.validationMessage=self.locale.getMessage("app.acctInfo.depositRefund.refundLimitExceeded");else if(self.depositRefundRequest.requestedRefundAmount<0)self.validationMessage=self.locale.getMessage("app.acctInfo.depositRefund.positiveValue");else{var max2Decimals=Math.round(self.depositRefundRequest.requestedRefundAmount*
100)/100;if(self.depositRefundRequest.requestedRefundAmount!=max2Decimals)self.validationMessage=self.locale.getMessage("app.acctInfo.depositRefund.max2Decimals");else{self.validationMessage=null;return true}}};self.submitDepositRefund=function(){var requestedRefundAmount=self.depositRefundRequest.requestedRefundAmount;if(!validateAmount(requestedRefundAmount))return;var depositRefundDTO={cardID:self.depositRefundRequest.selectedCreditCard[0].cardId,refundAmount:requestedRefundAmount};self.wlRefundWaiting=
true;dataServiceG2.submitDepositRefund(depositRefundDTO,function(response){var returnCodeDesc=response.data.returnCodeDesc;if(returnCodeDesc=="Success"){self.depositRefundStatus=response.data.data.depositRefundStatus;if(self.depositRefundStatus===undefined||self.depositRefundStatus===null||self.depositRefundStatus.status.trim()==="REJECTED")self.refundStatus="error";else if(self.depositRefundStatus.status.trim()==="ACCEPTED"){self.refundStatus="success";self.depositRefundSection="depositRefundSuccess"}}else if(returnCodeDesc==
"Error occurred")self.refundStatus="error";accountInfoDataService.setShowHideDepositBalanceFlag("UnInitialized");self.wlRefundWaiting=false})};self.changeStep=function(){self.refundStatus=null;self.formSubmitted=false;self.validationMessage=null;self.depositRefundSection="depositRefund";self.wlWaiting=true;accountInfoDataService.getCreditCardDetailsForDepositRefund().then(function(response){self.creditCards=response;self.wlWaiting=false});accountInfoDataService.getRefundBalanceAmount().then(function(response){self.refundBalance=
response})};self.changeStep()}]);
app.controller("accountMaintenanceController",["$scope","$http","$locale","$filter","$routeParams","dataServiceG2","copartUser","appConfigService",function($scope,$http,$locale,$filter,$routeParams,dataServiceG2,copartUser,appConfigService){var self=$scope;self.userConfig=copartUser.getUserConfig();self.accountInfoVO={};self.accountInfoEditVO={};self.locale=$scope.$parent.locale;self.bidderAccess=0;self.showEdit=false;self.errors={phoneNumber:false,alternatePhone:false};var tempMailingAddressLine1=
"";var tempMailingAddressLine2="";var tempMailingAddressCountry="";var tempMailingAddressCity="";var tempMailingAddressZip="";var tempMailingAddressState="";self.addressCheck=false;self.saveContactInfoVO={};self.cancelTrue=false;self.loadingContact=true;self.cultureTemplateUrl="/fetchDirective.html?directive\x3daccountinfo/addressCultureTemplate";self.contactAddressCultureTemplateUrl="/fetchDirective.html?directive\x3daccountinfo/contactAddressCultureTemplate";self.irelandCounties=["Co. Carlow","Co. Cavan",
"Co. Clare","Co. Cork","Co. Donegal","Co. Dublin","Co. Galway","Co. Kerry","Co. Kildare","Co. Kilkenny","Co. Laois","Co. Leitrim","Co. Limerick","Co. Longford","Co. Louth","Co. Mayo","Co. Meath","Co. Monaghan","Co. Offaly","Co. Roscommon","Co. Sligo","Co. Tipperary","Co. Waterford","Co. Westmeath","Co. Wexford","Co. Wicklow"];if(_.contains(copartUser.getUserConfig().roles,"ROLE_BROKER_BIDDER"))if($routeParams.navMenu=="contactInfo")$routeParams.navMenu="bidderContactInfo";self.activeTab=$routeParams.navMenu;
var cell=self.locale.getMessage("contact.label.phone.cell");var home=self.locale.getMessage("contact.label.phone.home");var work=self.locale.getMessage("contact.label.phone.work");var fax=self.locale.getMessage("contact.label.phone.fax");self.changeCountry=function(){var element=$('[name\x3d"phoneNumber"]');var countryArray=element.intlTelInput.getCountryData();var selected=$("#userCountry option:selected").text().toUpperCase();for(var i=0;i<countryArray.length;i++){var country=countryArray[i].name.toUpperCase();
if(country.indexOf("(")>-1)country=country.substring(0,countryArray[i].name.indexOf("(")).trim();if(country==selected){element.intlTelInput("setCountry",countryArray[i].iso2);break}}};self.showEditContact=function(){appConfigService.appConfig.countries.forEach(function(item){if(item.code==self.countryObj1[0].code)self.accountInfoEditVO.mailingAddressCountry=item});self.showEdit=true};self.showContact=function(){self.showEdit=false};self.showContactInfo=function(){dataServiceG2.getContactInfo(function(response){self.loadingContact=
true;self.accountInfoVO=response.data.contactInfoList;self.stateObj=_.where(self.appConfig.countryStates,{code:self.accountInfoVO.state});self.countryObj=_.where(self.appConfig.countries,{code:self.accountInfoVO.country});self.accountInfoVO.displayAddressState=self.stateObj[0].description;self.accountInfoVO.displayAddressCountry=self.countryObj[0].description;self.stateObj1=_.where(self.appConfig.countryStates,{code:self.accountInfoVO.mailingAddressState});self.countryObj1=_.where(self.appConfig.countries,
{code:self.accountInfoVO.mailingAddressCountry});if(self.stateObj1.length!=0)self.accountInfoVO.displayMailingAddressState=self.stateObj1[0].description;if(self.countryObj1.length!=0)self.accountInfoVO.displayMailingAddressCountry=self.countryObj1[0].description;self.accountInfoVO.contactPhone2=self.accountInfoVO.contactPhoneNumber.substring(0,3);self.accountInfoVO.contactPhone3=self.accountInfoVO.contactPhoneNumber.substring(3,7);self.accountInfoVO.altPhone2=self.accountInfoVO.altPhoneNumber.substring(0,
3);self.accountInfoVO.altPhone3=self.accountInfoVO.altPhoneNumber.substring(3,7);self.accountInfoVO.confirmEmail=self.accountInfoVO.email;if(self.accountInfoVO.mailingAddressZip2!=null&&self.accountInfoVO.mailingAddressZip2!="")self.accountInfoVO.mailingAddressZip1=self.accountInfoVO.mailingAddressZip1+" "+self.accountInfoVO.mailingAddressZip2;if(self.accountInfoVO.fullContactPhoneNumber.indexOf("0")==0)self.accountInfoVO.phoneNumber=self.accountInfoVO.fullContactPhoneNumber.substr(1);else self.accountInfoVO.phoneNumber=
self.accountInfoVO.fullContactPhoneNumber;if(self.accountInfoVO.fullAltPhoneNumber.indexOf("0")==0)self.accountInfoVO.alternatePhone=self.accountInfoVO.fullAltPhoneNumber.substr(1);else self.accountInfoVO.alternatePhone=self.accountInfoVO.fullAltPhoneNumber;self.phoneTypeText="";if(self.accountInfoVO.altPhoneType=="C")self.phoneTypeText=cell;else if(self.accountInfoVO.altPhoneType=="W")self.phoneTypeText=work;else if(self.accountInfoVO.altPhoneType=="H")self.phoneTypeText=home;else if(self.accountInfoVO.altPhoneType==
"F")self.phoneTypeText=fax;self.loadingContact=false;self.accountInfoEditVO=self.accountInfoVO})};self.showContactInfo();$scope.stateFilter=function(item){return item.type==="USA"||item.type==="CAN"};self.saveContactInfo=function(isValid){if(self.errors.phoneNumber||self.errors.alternatePhone)return;var teleInputs=$('[name\x3d"phoneNumber"]');var isValidPhoneNumber=teleInputs.first().intlTelInput("isValidNumber");if(isValid&&isValidPhoneNumber&&!self.errors.specialChars){var phoneNumberTrimmed=self.accountInfoEditVO.phoneNumber.replace(/[- )(]/g,
"");if(self.accountInfoEditVO.alternatePhone!="")if(teleInputs.last().intlTelInput("isValidNumber")){var alternatePhoneTrimmed=self.accountInfoEditVO.alternatePhone.replace(/[- )(]/g,"");self.errors.alternatePhone=false;self.accountInfoEditVO.altPhoneAreaCode=alternatePhoneTrimmed.toString().substr(0,3);var altPhone2=alternatePhoneTrimmed.toString().substr(3,3);var altPhone3=alternatePhoneTrimmed.toString().substr(6,4);self.accountInfoEditVO.altPhoneNumber=altPhone2+altPhone3}else{self.errors.alternatePhone=
true;self.errors.phoneNumber=!isValidPhoneNumber;return}self.errors.phoneNumber=false;self.accountInfoEditVO.fullContactPhoneNumber=self.accountInfoEditVO.phoneNumber;self.accountInfoEditVO.fullAltPhoneNumber=self.accountInfoEditVO.alternatePhone;self.accountInfoEditVO.contactPhoneAreaCode=self.accountInfoEditVO.phoneNumber.toString().substr(0,3);var contactPhone2=phoneNumberTrimmed.toString().substr(3,3);var contactPhone3=phoneNumberTrimmed.substr(6,4);self.accountInfoEditVO.contactPhoneNumber=contactPhone2+
contactPhone3;var phoneType=self.accountInfoEditVO.altPhoneType;if(phoneType==cell)self.accountInfoEditVO.altPhoneType="C";else if(phoneType==work)self.accountInfoEditVO.altPhoneType="W";else if(phoneType==home)self.accountInfoEditVO.altPhoneType="H";else if(phoneType==fax)self.accountInfoEditVO.altPhoneType="F";if(self.accountInfoEditVO.mailingAddressZip1!=""&&self.accountInfoEditVO.mailingAddressZip1!=undefined){var maZip1=self.accountInfoEditVO.mailingAddressZip1;if(maZip1.indexOf("-")>-1){var split=
maZip1.trim().split("-");self.accountInfoEditVO.mailingAddressZip1=split[0].trim();self.accountInfoEditVO.mailingAddressZip2=split[1].trim()}else if(maZip1.indexOf(" ")>-1){var split=maZip1.trim().split(" ");self.accountInfoEditVO.mailingAddressZip1=split[0].trim();self.accountInfoEditVO.mailingAddressZip2=split[1].trim()}else if(maZip1.length>5){self.accountInfoEditVO.mailingAddressZip1=maZip1.substring(0,4);self.accountInfoEditVO.mailingAddressZip2=maZip1.substring(5)}else self.accountInfoEditVO.mailingAddressZip1=
maZip1}self.accountInfoEditVO.mailingAddressCountry=self.accountInfoEditVO.mailingAddressCountry.code;self.loadingContact=true;dataServiceG2.saveContactInfo(self.accountInfoEditVO,function(response){var responseCode=response.data.data.errorMsg;var responseCodeDesc=response.data.returnCodeDesc;if(responseCode!=null&&responseCode.trim()!=""){self.displayError=true;self.showEdit=true;var temp=self.locale.getMessage("contact.error.contact."+responseCode.trim());if(temp!=null&&temp!="")self.errorDesc=
temp;else self.errorDesc=responseCodeDesc}else{self.displayError=false;self.accountInfoVO=self.accountInfoEditVO;if(self.accountInfoVO.altPhoneType=="C")self.phoneTypeText=cell;else if(self.accountInfoVO.altPhoneType=="W")self.phoneTypeText=work;else if(self.accountInfoVO.altPhoneType=="H")self.phoneTypeText=home;else if(self.accountInfoVO.altPhoneType=="F")self.phoneTypeText=fax;self.accountInfoVO.mailingAddressZip1=self.accountInfoVO.mailingAddressZip1+"-"+self.accountInfoVO.mailingAddressZip2;
self.errorDesc=self.locale.getMessage("contact.contact.success.message");self.showEdit=false;self.cancelTrue=false}});self.loadingContact=false}else{self.errors.phoneNumber=!isValidPhoneNumber;self.submitted=true}};self.saveContactInfoBidder=function(){var accountVO={};accountVO["email"]=self.accountInfoVO.email;dataServiceG2.updateContactEmail(accountVO,function(response){var responseCode=response.data.data.errorMsg;var responseCodeDesc=response.data.returnCodeDesc;if(responseCode!=null&&responseCode.trim()!=
""){self.displayError=true;var temp=self.locale.getMessage("contact.error.contact."+responseCode.trim());if(temp!=null&&temp!="")self.errorDesc=temp;else self.errorDesc="Unknown Error";self.showEdit=true}else{self.displayError=false;self.errorDesc=self.locale.getMessage("contact.contact.success.message")}});self.showEdit=false};self.checkForSpecialChars=function(){if(self.accountInfoEditVO.mailingAddressLine1==""||self.accountInfoEditVO.mailingAddressLine1==undefined)self.errors.specialChars=false;
else self.errors.specialChars=!/^[a-zA-Z0-9-. ]*$/.test(self.accountInfoEditVO.mailingAddressLine1.toString())};self.cancelEdit=function(){self.showEdit=false;self.cancelTrue=true;self.showContactInfo()};$scope.filterValue=function($event){if(isNaN(String.fromCharCode($event.keyCode)))$event.preventDefault()};self.isUKSite=function(){var userConfig=copartUser.getUserConfig();return userConfig.siteCode=="CPRTUK"||userConfig.siteCode=="CPRTMEA"||userConfig.siteCode=="CPRTIE"};self.isMEASite=function(){var userConfig=
copartUser.getUserConfig();return userConfig.siteCode=="CPRTMEA"}}]);
app.controller("accountInfoPreferenceController",["$scope","$http","$locale","$routeParams","$location","urlService","copartUser","dataServiceG2","$filter","$timeout","$window",function($scope,$http,$locale,$routeParams,$location,urlService,copartUser,dataServiceG2,$filter,$timeout,$window){var self=$scope;self.showEdit=false;self.accountPrefVO={};self.paymentOptions={};self.editPaymentOptions=null;self.locale=$scope.$parent.locale;self.inOut=true;self.loadingPreferences=true;var edit=$routeParams.edit;
if(edit&&edit=="Y")self.showEdit=true;self.buyerNumber=copartUser.getUserConfig().buyerNumber;self.showEditPreference=function(){self.showEdit=true};self.hideEditPreference=function(){self.showEdit=false;self.showPreferences()};self.manageCreditCards=function(){var requestParam={};requestParam.GATEWAY_URL_KEY="MANAGE_CARDS";requestParam.cancelCallBackUrl="accountInformation/myPreferences";requestParam.successCallBackURL="accountInformation/myPreferences";requestParam.cookieValue=$location.path();
dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=response.data.pciURL.trim();else log.error("Error in Gateway")})},self.errors={phoneNumber:false},self.showPreferences=function(){self.loadingPreferences=true;dataServiceG2.getCreditCardList(function(response){var creditCardLength=response.data.length;if(creditCardLength>0)self.creditCard=self.locale.getMessage("member.pref.credit.onfile");else self.creditCard=self.locale.getMessage("member.pref.credit.none.onfile")});
dataServiceG2.getContactInfo(function(response){self.accountInfoVO=response.data.contactInfoList;self.countryCheck=response.data.contactInfoList.country});dataServiceG2.getMemberPreferences(function(response){self.accountPrefVO=response.data.memberPreferenceList;var paymentTypesList=response.data.paymentTypesList;_.each(paymentTypesList,function(paymentMethod){if(paymentMethod.paymentType=="U")paymentMethod.paymentDesc=self.locale.messages["paymentDue.paymentType."+paymentMethod.paymentType]+" "+
paymentMethod.buyerNumber+"-"+paymentMethod.buyerName;else paymentMethod.paymentDesc=self.locale.messages["paymentDue.paymentType."+paymentMethod.paymentType]});if(self.countryCheck=="USA"||self.countryCheck=="CAN")paymentTypesList=_.filter(paymentTypesList,function(item){return!(item.paymentType=="G")});self.paymentOptions=paymentTypesList;self.accountPrefVO.displayPhoneNumber=self.accountPrefVO.contactPhoneAreaCode+self.accountPrefVO.contactPhoneNumber;if(self.accountPrefVO.mailTitleDocs=="Yes")self.accountPrefVO.mailDocsCheckedTrue=
true;else if(self.accountPrefVO.mailTitleDocs=="No")self.accountPrefVO.mailDocsCheckedTrue=false;if(self.accountPrefVO.rsCountry!=null&&self.accountPrefVO.rsCountry.trim().toUpperCase()=="MEX"&&self.accountPrefVO.optIn.trim().toUpperCase()=="A")self.accountPrefVO.optInchecked="Yes";else self.accountPrefVO.optInchecked="No";if(self.accountPrefVO.optIn=="A")self.accountPrefVO.inOut="I";else if(self.accountPrefVO.optIn=="I")self.accountPrefVO.inOut="O";self.parseShipService=_.find(self.appConfig.shippingServices,
{code:self.accountPrefVO.shippingServices});if(self.parseShipService!=null)self.accountPrefVO.shippingServicesDesc=self.parseShipService.description;else self.accountPrefVO.shippingServicesDesc="";self.loadingPreferences=false})};var init=function(){self.showPreferences()};init();self.contentURL=urlService.getContentURL("_Forms");dataServiceG2.getAccountInfoForms(function(response){self.forms=response.data});self.checkTerms=function(){if(titleDelivery.terms.checked==false){self.isTermsError=true;
self.termsError=self.locale.getMessage("member.terms.of.service");return false}else{self.isTermsError=false;return true}};self.updateMemberPreference=function(isValid){if(!isValid)if(self.accountPrefVO.mailTitleDocs=="No")isValid=true;var isValidNumber=$('[name\x3d"phoneNumber"]').intlTelInput("isValidNumber");if(isValid&&isValidNumber){self.checkTerms();self.loadingPreferences=true;if(self.isTermsError==false){self.accountPrefVO.contactPhoneAreaCode=self.accountPrefVO.displayPhoneNumber.substring(0,
3);self.accountPrefVO.contactPhoneNumber=self.accountPrefVO.displayPhoneNumber.substring(3,10);self.accountPrefVO.mailingAddressLine3="";self.accountPrefVO.mailingAddressZip2="";self.accountPrefVO.defaultPaymentId="PAYTYPEG2M";self.accountPrefVO.countryExport="MEX";self.accountPrefVO.vin="";dataServiceG2.updateMemberPreference(self.accountPrefVO,function(response){var responseCode=response.data.returnCode;var errorMsg=response.data.data.errorMsg;var responseCodeDesc=response.data.returnCodeDesc;if(errorMsg!=
null&&errorMsg.trim()!=""){self.isError=true;var temp=self.locale.getMessage("member.error.pref."+errorMsg.trim());if(temp!=null&&temp!="")self.errorDesc=temp;else self.errorDesc="Unknown Error";self.showEdit=true}else{self.showPreferences();self.loadingPreferences=true;self.isError=false;self.errorDesc=self.locale.getMessage("member.pref.success");self.showEdit=false}})}}else{self.errors.phoneNumber=!isValidNumber;self.submitted=true}}}]);
app.controller("UpgradeMembershipController",["$scope","$http","$locale","$routeParams","$location","copartUser","dataServiceG2","$filter","$timeout","$window",function($scope,$http,$locale,$routeParams,$location,copartUser,dataServiceG2,$filter,$timeout,$window){var self=$scope;if($routeParams.flag=="renewal"){var requestParam={};requestParam.GATEWAY_URL_KEY="RENEWAL_FEES";requestParam.cancelCallBackUrl="logout";requestParam.successCallBackURL="dashboard";dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==
1)$window.location.href=response.data.pciURL.trim();else log.error("Error in Gateway")})}self.addBidLimitInquiryVO={};self.upgradeMember=function(fromRequest){self.addBidLimitInquiryVO.lotNumber=0;self.addBidLimitInquiryVO.buyingPower=0;self.addBidLimitInquiryVO.depositAmount=0;var requestParam={};requestParam.GATEWAY_URL_KEY="UPGRADE_MEMBERSHIP";if(fromRequest=="dashboard"){requestParam.cancelCallBackUrl="dashboard";requestParam.successCallBackURL="backFromPayments"}else if(fromRequest=="myaccount"){requestParam.cancelCallBackUrl=
"accountInformation/contactInfo";requestParam.successCallBackURL="backFromPayments"}requestParam.cookieValue=$location.path()+"?reAuthn\x3dtrue";dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=response.data.pciURL.trim();else log.error("Error in Gateway")})};self.increaseBuyingPower=function(fromRequest){self.addBidLimitInquiryVO.lotNumber=0;self.addBidLimitInquiryVO.buyingPower=0;self.addBidLimitInquiryVO.depositAmount=0;dataServiceG2.increaseBuyingPower(self.addBidLimitInquiryVO,
function(response){if(response.returnCode==1){var batchNumber=response.data.batchNumber;var requestParam={};requestParam.transactionId=batchNumber;requestParam.GATEWAY_URL_KEY="INCREASE_BUYING_POWER";if(fromRequest=="dashboard"){requestParam.cancelCallBackUrl="dashboard";requestParam.successCallBackURL="dashboard"}else if(fromRequest=="myaccount"){requestParam.cancelCallBackUrl="accountInformation/contactInfo";requestParam.successCallBackURL="accountInformation/contactInfo"}requestParam.cookieValue=
$location.path();dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=response.data.pciURL.trim();else log.error("Error in Gateway")})}})}}]);
app.controller("lotSearchResultsController",["$filter","$scope","$location","$http","$timeout","$route","urlService","userService","dataServiceG2","saveSearchCriteria","$compile","$rootScope","$templateCache","$interpolate","$routeParams","miscSearchQuery","config","watchListService","appConfigService","backToLinkService","searchText","siteCatalyst","localStorageService","History","deviceService","metaDataService",function($filter,$scope,$location,$http,$timeout,$route,urlService,userService,dataServiceG2,
saveSearchCriteria,$compile,$rootScope,$templateCache,$interpolate,$routeParams,searchCriteria,config,watchListService,appConfigService,backToLinkService,searchText,siteCatalyst,localStorageService,History,deviceService,metaDataService){try{var self=$scope;watchListService.setWatchListDefinition($location.url());self.tableId="serverSideDataTable";var log=new Logger({name:"ServerSideDataTable",level:config.logLevel});var defaultDateFormat=userService.userConfig.dateFormat.toUpperCase();var defaultTimeFormat=
userService.userConfig.displayPref.timeFormat;var auctionDateFormat=defaultDateFormat+" \x3cbr\x3e "+defaultTimeFormat+" zz";var selectedTimezone=userService.userConfig.selectedTimezone;self.userService=userService;self.userConfig=self.userService.userConfig;self.isUKregion=appInit.regionCode=="uk"?true:false;self.date=moment().tz(selectedTimezone).format("YYYY MMMM DD");self.noResults=false;self.isMobileDevice=deviceService.isMobileDevice();self.isMobileSize=deviceService.isMobileSize();self.loadingSearchResults=
true;self.errCustomColCount=false;self.query=$location.search().query;self.locale=$scope.$parent.locale;self.searchName="";self.searchText=self.query;self.savedSearchCompleted=false;self.saved=false;self.selectAllChecked=false;self.showMultiBidCheckbox=false;self.eligibleToMultiLotBid=userService.isEligibleToMultiBid($location.url());self.isLiveAuction=$location.search().liveAuction=="true"?true:false;if(searchCriteria.displayStr){self.header="Search Results for: "+searchCriteria.displayStr;$rootScope.$emit("meta-args-update",
{searchText:searchCriteria.displayStr});searchCriteria.displayStr=null}else{$rootScope.$emit("meta-args-update",{searchText:self.searchText});self.header=urlService.getHeadingForURL($location.url(),self.locale)}urlService.getSubHeaderForURL($location.url(),self.locale).then(function(subHeader){self.subHeader=subHeader});self.images={};var free=$location.search().free;self.tempScope=self.$new();self.yardDetails={};self.lotsObj={};self.lots=angular.copy(self.lotsObj);if(_.isUndefined(self.query)||_.isNull(self.query)||
self.query==""){self.query="*";free=false}self.successMessage=false;self.messageText="";self.watchList=[];self.csvUrl="public/exportLotSearchResults?view\x3dcsv\x26date\x3d"+self.date;self.csvFileName="LotSearchresults_"+self.date+".csv";self.urlFromWatchList=$location.url();self.urlToTrigger="/public/lots/search";self.compareLotIdString="";var backTo=$location.url();self.backToLink=$location.url();self.urlFrom=$location.search().from;if(self.urlFromWatchList.indexOf("/watchList")!=-1){if(userService.isAnonymous()){urlService.redirectUrl=
$location.path();$location.path(urlService.login)}self.urlToTrigger="/lot/watchList";self.csvUrl="exportWatchlistResults?view\x3dcsv\x26date\x3d"+self.date;self.csvFileName="WatchList_"+self.date+".csv"}else self.loadingSearchResults=false;self.$watch("loadingSearchResults",function(newValue,oldValue){$timeout(function(){$("#serverSideDataTable").DataTable().columns.adjust().responsive.recalc()},0)});var externalSearchCriteria=$location.search().externalSearchCriteria||!_.isEmpty(searchCriteria.MISC);
if(externalSearchCriteria)if(searchCriteria.sortByZip)self.zipcode=searchCriteria.buyerEnteredZip;var fromSavedSearch=$location.search().fromSavedSearch;function checkIfSearchStrIsPresent(){try{var searchCriteria=JSON.parse($location.search().searchCriteria);if(_.isObject(searchCriteria)){saveSearchCriteria.data=searchCriteria;return true}return false}catch(e){return false}}if(checkIfSearchStrIsPresent()){fromSavedSearch=true;if($location.search().page)$location.search("page",1)}self.viewType=$location.search().viewType;
self.showAllEnabled=userService.isShowAllEnabled($location.url());var showAll=self.viewType=="showAll"?true:false;var state=false;var stateRestoreFromAnywhere=localStorageService.get("restore-search-state-from-anywhere");localStorageService.remove("restore-search-state-from-anywhere");if(checkIfFromLotDetails(History)||$location.search().state=="restore"||stateRestoreFromAnywhere){state=localStorageService.get("restore-search-state");self.viewedLot=localStorageService.get("viewed-lot");localStorageService.remove("viewed-lot")}localStorageService.remove("restore-search-state");
var stateStage=localStorageService.get("stateStage");state=state?true:false;if(state)localStorageService.set("stateStage","1");else localStorageService.set("stateStage","0");self.alerts=[];self.isAlertOnModal=false;self.customizationErrors=[];if(!externalSearchCriteria){backTo=backTo+"\x26query\x3d"+self.query;self.backTolink=self.backTolink+"\x26query\x3d"+self.query}var lengthOfHeaders=$("#"+self.tableId).find("th").length;var pageLength=localStorageService.cookie.get("searchResultsPageLength");
pageLength=pageLength?pageLength:20;var pageNumber=$location.search().page;if(_.isEmpty(pageNumber)||_.isNaN(pageNumber-0)||pageNumber<1)pageNumber=1;pageNumber=parseInt(pageNumber);var iDisplayStart=(pageNumber-1)*pageLength;self.dataTableOptions={"pageLength":pageLength,"lengthMenu":[[20,50,100],[20,50,100]],"iDisplayStart":iDisplayStart,"columnDefs":[{"targets":[0,1,lengthOfHeaders-2],"orderable":false},{"targets":[3],"orderSequence":["desc","asc"]},{targets:"no-sort",orderable:false},{"targets":[lengthOfHeaders-
2],"visible":self.eligibleToMultiLotBid&&self.showMultiBidCheckbox},{className:"control",orderable:false,targets:-1}],"initOrder":!free?[[1,"asc"]]:[],"freeFormSearch":free?true:false,"showAll":showAll,"url":self.urlToTrigger,"containsFilters":false,"stateSave":state,"query":!externalSearchCriteria?self.query:"*","searchCriteria":!externalSearchCriteria?false:searchCriteria,"fromSavedSearch":fromSavedSearch?true:false,"saveSearchCriteria":fromSavedSearch?saveSearchCriteria:{},"fnRowCallback":function(nRow,
aData,iDisplayIndex){jQuery(".nowrap",nRow).attr("nowrap","nowrap");return nRow},"afterInit":function(datatable){jQuery("#selectAllHdr").html("\x3cdiv class\x3d'text-center'\x3e\x3cinput type\x3d'checkbox' ng-checked\x3d'selectAllChecked' ng-click\x3d'selectAll()'/\x3e\x3c/div\x3e");$compile(jQuery("#selectAllHdr"))($scope);self.tableHeaders=populateMobileSortMenu(datatable.columns().header());self.$apply();if(localStorageService.get("filtersHidden"))$timeout(function(){if(!self.isMobileDevice)jQuery("#filter-anchor").click()},
5);if(localStorageService.get("showImages")==false){self.showImages=false;self.showHideImages(false)}}};var populateMobileSortMenu=function(headers){var mobileHeaders=[];for(var i=0;i<headers.length;i++){var headerObj=$(headers[i]);if(headerObj.hasClass("sortable")){var header={};header.index=i;header.order="asc";header.displayName=headerObj.attr("data-header-name");mobileHeaders.push(header)}}return mobileHeaders};self.clearAllCheckBoxes=function(){self.selectedLotNumbers=[];self.selectAllChecked=
false;$("#serverSideDataTable tbody tr").removeClass("row-selected")};self.showHideImages=function(flag){var table=$(self.tableId).DataTable();table.column(1).visible(flag);if(!flag)localStorageService.set("showImages",false);else localStorageService.remove("showImages");self.clearAllCheckBoxes()};self.toggleMultiBid=function(flag){self.showMultiBidCheckbox=flag;var table=$(self.tableId).DataTable();table.column(lengthOfHeaders-2).visible(flag);self.clearAllCheckBoxes()};self.searchWithSpellCheck=
function(searchText){$rootScope.$broadcast("search-again",{searchText:searchText})};var addAlerts=function(type,msg){self.alerts.push({msg:msg,type:type})};self.closeAlert=function(index){self.alerts.splice(index,1);self.isAlertOnModal=false};self.selectAll=function(){self.selectAllChecked=!self.selectAllChecked;self.selectedLotNumbers=[];if(self.selectAllChecked&&!showAll){$("#serverSideDataTable tbody tr").addClass("row-selected");var boxes=jQuery("#serverSideDataTable tbody tr").find("input:checkbox");
for(var i=0;i<boxes.length;i++){var lotNum=boxes[i].id;self.selectedLotNumbers.push(lotNum)}}else $("#serverSideDataTable tbody tr").removeClass("row-selected")};self.showAll=function(){var url=$location.url();url=url.replace("saleListResult","saleListResultAll");var siteCatalystVal={};siteCatalystVal.fname="doTagViewAllLaneSalelist";siteCatalyst.addToQueue("doTagViewAllLaneSalelist",siteCatalystVal);siteCatalyst.executeCall("doTagViewAllLaneSalelist");$location.url(url)};self.showLess=function(){$location.search("viewType",
"showLess")};self.goToPage=function(pageNumber){var table=$(self.tableId).DataTable();var totalPages=table.page.info().pages;pageNumber=pageNumber-0;if(pageNumber>0&&pageNumber<=totalPages){table.page(pageNumber-1).draw(false);self.scrollTop=true}else self.pageNumberInvalid=true};self.storeBackToUrl=function(){localStorageService.set("back-to-url",$location.url())};self.storeNavigationInfo=function(resultIndex,totalRecords){var info={backTo:"."+$location.url(),resultIndex:resultIndex,totalRecords:totalRecords,
fromSearch:true};localStorageService.set("lot-navigation-info",info)};var highlightIcons=appConfigService.appConfig.validHighlightIcons;self.validIconCodes=_.pluck(highlightIcons,"iconCode");function generateIconTemplate(template,iconCodes){template=template+'\x3cspan class\x3d"highlighticon" \x3e';for(var i=0;i<iconCodes.length;i++){var code=iconCodes[i];template+='\x3ca fragment-id\x3d"'+code+'" class\x3d"icon-tooltip" data-trigger\x3d"focus" data-placement\x3d"auto right" data-toggle\x3d"popover" data-container\x3d".searchresultstable"\x3e'+
'\x3cspan class\x3d"vehicleicon"\x3e\x3cimg src\x3d"../images/global/highlightIcons-'+appInit.regionCode+'.png" class\x3d"lotIcon-'+code+'"\x3e\x3c/span\x3e\x3c/a\x3e'}template=template+"\x3c/span\x3e";return template}var getDefaultRowValues=function(row){row=_.defaults(row,{"lotNumberStr":"13955196","ln":0,"mkn":"","lm":"","lcy":0,"fv":"","la":0,"rc":0,"orr":0,"ord":"","obc":"","egn":"","cy":"","ld":"","yn":"","cuc":"","tz":"","ad":0,"at":"00:00:00","aan":0,"hb":0,"ss":0,"bndc":"","bnp":0,"sbf":false,
"ts":"0","stt":"0","td":"0","dd":"0","tims":"","lic":[],"gr":"-","dtc":"","al":"-","adt":"","ynumb":0,"phynumb":0,"bf":false,"cc":"","ymin":0,"myb":0,"lmc":"","lcc":"","sdd":"","bstl":"","ftd":"","lcd":"","ft":"","hk":false,"sn":"","kys":false,"nts":"","drv":""});return row};self.getHeaderColumns=function(){var userColumns=[];var columns={};$(self.tableId).find("thead tr th").each(function(i,v){var jsonProperty=$(this).attr("data-jsonproperty");var fieldid=$(this).data("fieldid");if("imagePathSmall"==
fieldid)columns["data"]={"defaultContent":"","render":function(data,type,row,meta){row=getDefaultRowValues(row);row["resultIndex"]=meta.settings._iDisplayStart+meta.row;row["totalRecords"]=meta.settings._iRecordsTotal;row["backTo"]=backTo;row["header"]=self.header;var bidString=$filter("globalize_currency_using_code")(row["hb"],row["cuc"]);var isFuture=row["adt"]=="E"?true:false;var template="\x3cdiv class\x3d'imgpath cursor-pointer' lot-id\x3d'"+row["ln"]+"' lot-desc\x3d'"+row["ld"]+"' sealed-bid\x3d'"+
row["sbf"]+"' images\x3d'images' current-bid\x3d'"+row["hb"]+"' is-future\x3d'"+isFuture+"' modal-image-viewer "+"result-index\x3d'"+row["resultIndex"]+"' total-records\x3d'"+row["totalRecords"]+"' from-search\x3dtrue "+"auction-date\x3d'"+row["ad"]+"' yard-number\x3d'"+row["ynumb"]+"' bid-string\x3d'"+bidString+"' currency-code\x3d'"+row["cuc"]+"'\x3e\x3cspan class\x3d'searchiconbtn'\x3e\x3c/span\x3e";var siteCatVal=JSON.stringify({"fname":"doTagLotImages","imageNumber":"1","lotId":row["ln"].toString()});
if(row["tims"]!="")template=template+"\x3cimg site-catalyst\x3d'"+siteCatVal+"'   lazy-src\x3d'"+row["tims"]+"' title\x3d'"+row.ld+"' alt\x3d'"+row.ld+"' data-uname\x3d'lotsearchLotimage' height\x3d'72' width\x3d'96'\x3e";else template=template+"\x3cimg site-catalyst\x3d'"+siteCatVal+"' lazy-src\x3d'images/testImages/no_photo.jpg' data-uname\x3d'lotsearchLotimage' height\x3d'72' width\x3d'96'\x3e";template=template+"\x3c/div\x3e\x3cdiv class\x3d'viewallphotos'\x3e\x3ca ng-click\x3d'storeNavigationInfo([[resultIndex]],[[totalRecords]])' ng-href\x3d'./lot/[[ ln ]]/Photos' class\x3d'image_viewer_link'\x3e"+
self.locale.messages["counterman.searchResults.viewAllPhotos.label"]+"\x3c/a\x3e\x3c/div\x3e";return compileCellWithUnderscore(template,row)}};else if(fieldid=="checkbox")columns["data"]={"defaultContent":"","render":function(data,type,row){row=getDefaultRowValues(row);var template="\x3cdiv class\x3d'text-center'\x3e"+"\x3cinput type\x3d'checkbox' class\x3d'action-item' name\x3d'lot-select' id\x3d'[[ln]]' ng-checked\x3d'selectedLotNumbers.indexOf(\"[[ln]]\")\x3e-1' ng-click\x3d\"ifChecked('[[ln]]',$event)\"/\x3e\x3cbr\x3e";
return compileCellWithUnderscore(template,row)}};else if(fieldid=="lotYear")columns["data"]={"defaultContent":"","render":function(data,type,row){row=getDefaultRowValues(row);if(row["lic"])var iconCodes=_.intersection(row["lic"],self.validIconCodes);var template="\x3cspan data-uname\x3d'lotsearchLotcenturyyear'\x3e"+row["lcy"]+"\x3c/span\x3e\x3cbr\x3e";return generateIconTemplate(template,iconCodes)}};else if(fieldid=="lotNumber")columns["data"]={"defaultContent":"","render":function(data,type,row,
meta){row=getDefaultRowValues(row);row["resultIndex"]=meta.settings._iDisplayStart+meta.row;row["totalRecords"]=meta.settings._iRecordsTotal;row["backTo"]=backTo;row["header"]=self.header;if(self.viewedLot&&self.viewedLot==row["ln"]){self.viewedRowIndex=meta.row;self.viewedLot=null}var template="\x3cdiv class\x3d'ng-cloak'\x3e"+"\x3ca ng-href\x3d'./lot/[[ ln ]]' "+"ng-click\x3d'storeNavigationInfo([[resultIndex]],[[totalRecords]])' data-uname\x3d'lotsearchLotnumber'\x3e[[ ln ]]\x3c/a\x3e\x3cbr/\x3e"+
"\x3cbutton type\x3d'submit' class\x3d'black-line watch-btn' ng-hide\x3d\"isAlreadyAdded('[[ln]]')\" check-for-logged-in-user state-restore\x3d'true'"+"ng-click\x3d\"addToWatchList('[[ln]]')\" data-uname\x3d'lotsearchWatchlot'\x3e"+self.locale.messages["app.label.watch"]+"\x3c/button\x3e"+"\x3cbutton type\x3d'submit' class\x3d'black-line watch-btn watched' ng-hide\x3d\"!isAlreadyAdded('[[ln]]')\""+"ng-click\x3d\"removeFromWatchList('[[ln]]')\" data-uname\x3d'lotsearchRemovelot'\x3e"+self.locale.messages["app.label.remove"]+
"\x3c/button\x3e"+"\x3c/div\x3e";return compileCellWithUnderscore(template,row)}};else if(fieldid=="auctionDateUtc")columns["data"]={"defaultContent":"","render":function(data,type,row){row=getDefaultRowValues(row);var template="";if(row["adt"]=="E")template="\x3cspan data-uname\x3d'lotsearchLotauctiondate' ng-if\x3d\"lots.lot_[[ln]].liveBid!\x3d'Y'\x26\x26!isLiveAuction\"\x3eFuture\x3c/span\x3e";else{var date=moment.utc(row["ad"]).tz(userService.userConfig.selectedTimezone).format(auctionDateFormat);
template="\x3cspan data-uname\x3d'lotsearchLotauctiondate' ng-if\x3d\"lots.lot_[[ln]].liveBid!\x3d'Y'\x26\x26!isLiveAuction\"\x3e"+date+"\x3c/span\x3e"}template=template+"\x3cspan data-uname\x3d'lotsearchLotauctiondate' class\x3d'btn btn-success' ng-if\x3d\"lots.lot_[[ln]].liveBid\x3d\x3d'Y'||isLiveAuction\"\x3e"+self.locale.messages["app.label.live.now"]+"\x3c/span\x3e";return compileCellWithUnderscore(template,row)}};else if(fieldid=="auctionTime")columns["data"]={"defaultContent":"","render":function(data,
type,row){row=getDefaultRowValues(row);var date=moment.utc(row["ad"]).tz(selectedTimezone).format("hh:mm A zz");return date}};else if(fieldid=="engine")columns["data"]={"defaultContent":"","render":function(data,type,row){row=getDefaultRowValues(row);var template="\x3cspan data-uname\x3d'lotsearchLotEngine'\x3e"+row["egn"]+"\x3c/span\x3e\x3cbr\x3e";return template}};else if(fieldid=="cylinders")columns["data"]={"defaultContent":"","render":function(data,type,row){row=getDefaultRowValues(row);var template=
"\x3cspan data-uname\x3d'lotsearchLotEngine'\x3e"+row["cy"]+"\x3c/span\x3e\x3cbr\x3e";return template}};else if(fieldid=="lotAcv")columns["data"]={"defaultContent":"","render":function(data,type,row){row=getDefaultRowValues(row);var template="\x3cspan data-uname\x3d'lotsearchLotestimatedretailvalue'\x3e"+$filter("globalize_currency_using_code")(row["la"],row["cuc"])+"\x3c/span\x3e";return template}};else if(fieldid=="repairCost")columns["data"]={"defaultContent":"","render":function(data,type,row){row=
getDefaultRowValues(row);var template="\x3cspan data-uname\x3d'lotsearchLotrepaircost'\x3e"+$filter("globalize_currency_using_code")(row["rc"],row["cuc"])+"\x3c/span\x3e";return template}};else if(fieldid=="odometerReadingReceived")columns["data"]={"defaultContent":"","render":function(data,type,row){row=getDefaultRowValues(row);var template="\x3cspan data-uname\x3d'lotsearchLotodometerreading' title \x3d'"+row["ord"]+"'\x3e"+$filter("globalize_number")(row["orr"])+" "+row["obc"]+"\x3c/span\x3e";
return template}};else columns["data"]={"defaultContent":"","render":function(data,type,row,meta){row=getDefaultRowValues(row);row["resultIndex"]=meta.settings._iDisplayStart+meta.row;row["totalRecords"]=meta.settings._iRecordsTotal;row["backTo"]=backTo;row["header"]=self.header;var template=$("#"+fieldid).html();if(!_.isUndefined(template)){var compiled=_.template(template);return compiled(row)}return data}};userColumns.push(columns["data"])});return userColumns};function compileCellWithUnderscore(template,
data){var compiled=_.template(template);return compiled(data)}self.saveSearch=function(){dataServiceG2.saveSearch(self.getSearchObject(),function(response){if(response.data.returnCode!=-1){self.savedSearchCompleted=true;self.savedSearchError=false;self.savedSearchErrorLimit=false;self.saved=true}else if(response.data.data.errorMsg.trim()=="MBRWBCRSDS04")self.savedSearchErrorLimit=true;else self.savedSearchError=true})};self.getSearchObject=function(){var queryArr=[];queryArr.push(self.query);var tempFilterArray=
{};_.each(self.filterQueryArr,function(value,key,list){if(!_.isArray(value))tempFilterArray[key]=value.split(",");else tempFilterArray[key]=value});return{query:queryArr,filter:tempFilterArray,sort:self.sortApplied.split(","),searchName:self.searchName,watchListOnly:self.watchListOnly,freeFormSearch:free?true:false}};self.isAlreadyAdded=watchListService.isAlreadyAdded;self.addToWatchList=watchListService.addToWatchList;self.removeFromWatchList=watchListService.removeFromWatchList;self.isWatchList=
watchListService.isWatchList();self.selectedLotNumbers=[];self.ifChecked=function(lotNum,$event){var $row=$($event.target).closest("tr");var index=self.selectedLotNumbers.indexOf(lotNum);self.selectAllChecked=false;if($event.target.checked){if(index==-1)self.selectedLotNumbers.push(lotNum);$row.addClass("row-selected")}else{if(index>-1)self.selectedLotNumbers.splice(index,1);$row.removeClass("row-selected")}};self.compareLots=function(){if(self.selectedLotNumbers.length>1&&self.selectedLotNumbers.length<
6){self.compareLotIdString=self.selectedLotNumbers.join(",");var url="/compareLots/"+self.compareLotIdString;backToLinkService.setBackToLink(self.backToLink);$location.url(url)}else addAlerts("danger","Select a minimum of 2 vehicles for comparison and a maximum of 5. Please try again.")};self.increaseLimit=function(filter){if(filter.limit<filter.items.length)filter.limit+=10};var generateLotsByLotNumbers=function(lotNumbers){lots=[];for(var i=0;i<lotNumbers.length;i++){var lot={lotId:lotNumbers[i]};
lots.push(lot)}return lots};self.removeCheckedFromWatchList=function(){if(!userService.isAnonymous())if(self.selectedLotNumbers.length==self.metadata.size&&!showAll){if(self.metadata.size>99){addAlerts("danger",self.locale.messages["app.msg.lotsearch.add.max"]);return}var queryArr=[];queryArr.push(self.query);watchListService.removeAllFromWatchlist({query:queryArr,filter:self.filterQueryArr,sort:self.sortApplied.split(","),page:self.metadata.page,size:self.metadata.size},function(){$route.reload()})}else{if(self.selectedLotNumbers.length==
0){addAlerts("danger",self.locale.messages["app.msg.lotsearch.please.select"]);return}if(self.selectedLotNumbers.length>99){addAlerts("danger",self.locale.messages["app.msg.lotsearch.add.max"]);return}var selectedLots=generateLotsByLotNumbers(self.selectedLotNumbers);watchListService.removeCheckedFromWatchlist(selectedLots,function(response){addAlerts("success",self.locale.messages["app.msg.lotsearch.remove.watchlist"])})}};self.addCheckedToWatchList=function(){if(!userService.isAnonymous()){if(self.selectedLotNumbers.length==
self.metadata.size&&!showAll){if(self.metadata.size>99){addAlerts("danger",self.locale.messages["app.msg.lotsearch.add.max"]);return}var queryArr=[];queryArr.push(self.query);addAllToWatchList({query:queryArr,filter:self.filterQueryArr,sort:self.sortApplied.split(","),page:self.metadata.page,size:self.metadata.size})}else if(self.selectedLotNumbers.length==self.metadata.size&&showAll){if(self.totalRecords>99){addAlerts("danger",self.locale.messages["app.msg.lotsearch.add.max"]);return}var queryArr=
[];queryArr.push(self.query);addAllToWatchList({query:queryArr,filter:self.filterQueryArr,sort:self.sortApplied.split(","),page:0,size:self.totalRecords})}else{if(self.selectedLotNumbers.length==0){addAlerts("danger",self.locale.messages["app.msg.lotsearch.please.select"]);return}if(self.selectedLotNumbers.length>99){addAlerts("danger",self.locale.messages["app.msg.lotsearch.add.max"]);return}var selectedLots=generateLotsByLotNumbers(self.selectedLotNumbers);watchListService.addAllCheckedToWatchList(selectedLots,
function(response){addAlerts("success",self.locale.messages["app.msg.lotsearch.add.watchlist"])},watchListError)}for(var i in self.selectedLots)if(!AppUtils.isUndefined(self.selectedLots)&&!AppUtils.isUndefined(self.selectedLots[i].lotId)){var siteCatalystVal={};siteCatalystVal.fname="doTagWatchList";siteCatalystVal.addremove="add";siteCatalystVal.lotId=self.selectedLots[i].lotId;siteCatalyst.addToQueue("doTagWatchList",siteCatalystVal);siteCatalyst.executeCall("doTagWatchList")}}};var watchListError=
function(response){if(!AppUtils.isUndefined(response.data.data))addAlerts("danger","Unable to add the following lots: "+response.data.data.toString());else addAlerts("danger","Error occurred while adding")};var addAllToWatchList=function(data){watchListService.addAllToWatchList(data,function(response){addAlerts("success",self.locale.messages["app.msg.lotsearch.add.watchlist"])},watchListError)};$("#multiselect").multiselect({keepRenderingSort:true});self.moveOptionUp=function(id){var $selected=$("#multiselect_to option:selected");
if($selected.length)$selected.first().prev().before($selected)};self.moveOptionDown=function(id){var $selected=$("#multiselect_to option:selected");if($selected.length)$selected.last().next().after($selected)};self.resetToDefault=function(id){$("#multiselect_to").empty();var defValues=[];var defValuesOrig=[];$("#multiselect_def option").each(function(){defValues.push($(this).clone())});$("#multiselect_to").html(defValues);$("#multiselect").empty();var buyerAvailValues=[];var defAvailFields=[];$("#multiselect_defAvail option").each(function(){buyerAvailValues.push($(this).clone())});
$("#multiselect").html(buyerAvailValues)};self.confirmCustomization=function(){var selectedOptions=[];var options=$("#multiselect_to option");if(options.length<7){var values=$.map(options,function(option){return option.index+":"+option.value});function mapper(str){var o={};var strArr=str.split(":");o[strArr[0].trim()]=strArr[1].trim();return o}var resultArray=values.map(mapper);var colString=JSON.stringify(values);$.ajax({type:"POST",dataType:"json",contentType:"application/json; charset\x3dutf-8",
url:"/data/lotSrchDisplayPref",data:JSON.stringify({"customLotSearchColumns":colString}),success:function(result){if(result&&result.returnCode===1){$("#customize").modal("hide");$("body").removeClass("modal-open");$(".modal-backdrop").remove();var currentPageTemplate=$route.current.templateUrl;$templateCache.remove(currentPageTemplate);localStorageService.set("restore-search-state",true);$location.search("state","restore");$route.reload()}},error:function(){}})}else{self.errCustomColCount=true;addAlerts("danger",
"You can only customize a maximum of 6 columns for display.Please re-select your customization.");self.isAlertOnModal=true}};self.getLot=function(lotNumber){if(self.lots!=null||!_.isEmpty(self.lots)){var lot=self.lots["lot_"+parseInt(lotNumber)];return _.isUndefined(lot)?{}:lot}return{}};self.images.getLot=self.getLot;self.showExportResultsWarningModal=function(){var table=$(self.tableId).DataTable();var totalRecords=table.page.info().recordsTotal;if(totalRecords>1E4)$("#exportResultsWarning").modal("show");
else window.open(self.csvUrl,"_blank")};self.formatDateTime=function(value){if(value&&value!="")return moment(value,"x").tz(selectedTimezone).format(defaultDateFormat+" "+defaultTimeFormat+" zz")};self.getBuyerPosition=function(lotNumber){var lot=self.getLot(lotNumber);var returnObj={};if(_.isEmpty(lot))returnObj.position="N";else if(parseInt(userService.getBuyerNumber())==lot.highBidder)returnObj.position="W";else if(lot.hasBid=="Y")returnObj.position="L";else returnObj.position="N";return returnObj};
self.images.getLot=self.getLot;self.showExportResultsWarningModal=function(){var table=$(self.tableId).DataTable();var totalRecords=table.page.info().recordsTotal;if(totalRecords>1E4)$("#exportResultsWarning").modal("show");else window.open("public/exportLotSearchResults?view\x3dcsv\x26date\x3d"+self.date,"_blank")};var bidFormDeregisterEvent=$rootScope.$on("registerBidForm",function(event,data){var checkObj=_.where(self.preBidForms,{lotNum:data.lotNum});if(checkObj.length==0)self.preBidForms.push(data);
else _.extend(_.findWhere(self.preBidForms,{lotNum:data.lotNum}),data)});var currentBidDeregisterEvent=$rootScope.$on("got-current-bid-data",function(event,data){self.lots=angular.copy(self.lotsObj);if(data.returnCode==1)var tempLots=_.indexBy(data.data,"lotNum");else if(data.returnCode==2)var tempLots=data.data;angular.forEach(tempLots,function(value,key){var lot=value;if(_.isEmpty(lot))lot.position="N";else if(parseInt(userService.getBuyerNumber())==lot.highBidder)lot.position="W";else if(lot.hasBid==
"Y")lot.position="L";else lot.position="N";self.lots["lot_"+key]=value})});function setSearchCriteriaInUrl(){$location.search("searchStr",JSON.stringify(getSearchObject()))}var noRecordsDeregisterEvent=$rootScope.$on("no-records",function(event,data){var str=$location.search().query||$location.search().displayStr;searchText.construct(str,data);self.noResults=true;if(self.urlToTrigger=="/lot/watchList")self.loadingSearchResults=false});var yardDetailsLoadedEvent=$rootScope.$on("yardDetailsLoaded",
function(event,data){self.navigationAddress="";self.yardDetails=data;if("IRL"==self.tempScope.yardDetails.yardCountryCode||"IRL"==self.yardDetails.yardCountryCode){self.yardDetails.yardZip="R14 YK37";self.yardDetails.yardMailingZip="R14 YK37";if(self.tempScope){self.tempScope.yardDetails.yardZip="R14 YK37";self.tempScope.yardDetails.yardMailingZip="R14 YK37"}}self.navigationAddress=(self.tempScope.yardDetails.yardAddress1||data.yardAddress1)+" "+(self.tempScope.yardDetails.yardAddress2||data.yardAddress2)+
" "+(self.tempScope.yardDetails.yardCity||data.yardCity)+" "+(self.tempScope.yardDetails.yardStateName||data.yardStateName)+" "+(self.tempScope.yardDetails.yardZip||data.yardZip);if("ARE"==self.tempScope.yardDetails.yardCountryCode||"BHR"==self.tempScope.yardDetails.yardCountryCode||"ARE"==data.yardCountryCode||"BHR"==data.yardCountryCode)self.navigationAddress="Copart "+(self.tempScope.yardDetails.yardCity||data.yardCity)+" "+(self.tempScope.yardDetails.yardStateName||data.yardStateName)});var scopeRestoreEvent=
$rootScope.$on("state-restore",function(event,data){self.showImages=data.showImages;self.showHideImages(self.showImages);self.showMultiBidCheckbox=data.showMultiBidCheckbox;self.zipcode=data.zipcode});self.cleanUp=function(){currentBidDeregisterEvent();bidFormDeregisterEvent();noRecordsDeregisterEvent();yardDetailsLoadedEvent();scopeRestoreEvent();metaDataService.clearPageTags()};$scope.$on("$destroy",function(){self.cleanUp()})}catch(e){console.error(e);$location.url("/unknown-error")}}]);
app.controller("freeTextSearchController",["$scope","$location","$route","$rootScope","dataServiceG2","urlService",function($scope,$location,$route,$rootScope,dataServiceG2,urlService){var self=$scope;self.searchText="";function goToSearchOrLotDetails(response){try{var url=$location.url();if(!_.isUndefined(response.data.data.results.content)&&response.data.data.results.content.length==1){var lot=response.data.data.results.content[0];$location.url(urlService.lotDetailUrl+lot.ln)}else if(url=="/lotSearchResults?query\x3d"+
self.searchText){$location.url("/lotSearchResults?query\x3d"+self.searchText);$route.reload()}else $location.url("/lotSearchResults?free\x3dtrue\x26query\x3d"+self.searchText)}catch(e){console.log(e)}}self.search=function(){var url=$location.url();if(!_.isUndefined(self.searchText)&&!_.isNull(self.searchText)&&!isNaN(self.searchText)&&!_.isEmpty(self.searchText)&&self.searchText.length>4){var lotSearchArr=[];lotSearchArr.push("ps_lot_number:"+self.searchText);var searchCriteria={MISC:lotSearchArr};
dataServiceG2.getLotsByLotNumber({filter:searchCriteria},goToSearchOrLotDetails)}else if(validateVin(self.searchText)){var lotSearchArr=[];lotSearchArr.push("ps_vin_number:"+self.searchText);var searchCriteria={MISC:lotSearchArr};dataServiceG2.getLotsByLotNumber({filter:searchCriteria},goToSearchOrLotDetails)}else if(url=="/lotSearchResults?query\x3d"+self.searchText){$location.url("/lotSearchResults?query\x3d"+self.searchText);$route.reload()}else $location.url("/lotSearchResults?free\x3dtrue\x26query\x3d"+
self.searchText)};$rootScope.$on("search-again",function(event,args){self.searchText=args.searchText;self.search()})}]);function checkIfFromLotDetails(History){try{var lastRoute=History.lastRoute;if(lastRoute&&(lastRoute.indexOf("lot/")==0||lastRoute.indexOf("lotDetail/")==0||lastRoute.indexOf("vehicleFinderSearch/")==0||lastRoute.indexOf("compareLots/")==0))return true;else return false}catch(e){return false}}
app.controller("saleListController",["$scope","searchCriteria","$location","alphanumericFilter","$route","$templateCache","dataServiceG2","watchListService","$filter","$timeout","backToLinkService","userService","urlService","$rootScope","auctionsCalendarService","copartUtils","deviceService","localStorageService","History","saleListOnMessageService",function($scope,searchCriteria,$location,alphanumericFilter,$route,$templateCache,dataServiceG2,watchListService,$filter,$timeout,backToLinkService,
userService,urlService,$rootScope,auctionsCalendarService,copartUtils,deviceService,localStorageService,History,saleListOnMessageService){var self=$scope;self.userService=userService;self.filters=[];self.nullIncludeTags=[];self.appliedFilters=[];self.sortBy="auction_date_utc asc";self.secSortBy="auction_date_utc asc";self.watchListOnly=false;self.yardDetails={};self.images={};self.selectedLots=[];self.compareLotIdString="";self.alerts=[];self.totalRecords=0;self.showImages=true;var thumbnailLength=
5;self.urlFrom=$location.search().from;watchListService.setWatchListDefinition($location.url());self.header=urlService.getHeadingForURL($location.url(),self.locale);urlService.getSubHeaderForURL($location.url(),self.locale).then(function(subHeader){self.subHeader=subHeader});self.date=moment().format("YYYY MMMM DD");var state=false;var stateRestoreFromAnywhere=localStorageService.get("restore-search-state-from-anywhere");localStorageService.remove("restore-search-state-from-anywhere");if(checkIfFromLotDetails(History)||
$location.search().state=="restore"||stateRestoreFromAnywhere){state=localStorageService.get("restore-search-state");self.viewedLot=localStorageService.get("viewed-lot");localStorageService.remove("viewed-lot")}localStorageService.remove("restore-search-state");state=state?true:false;var stateObj={};if(state)stateObj=localStorageService.get("state-saved-sale-list");function stateRestore(){self.appliedFilters=stateObj.filters;self.secSortBy=stateObj.secSortBy;self.sortBy=stateObj.sortBy;self.watchListOnly=
stateObj.watchListOnly;self.showImages=stateObj.showImages;reloadtable()}function stateSave(){var state={filters:self.appliedFilters,secSortBy:self.secSortBy,sortBy:self.sortBy,watchListOnly:self.watchListOnly,showImages:self.showImages};localStorageService.set("state-saved-sale-list",state)}var init=function(){window.addEventListener&&window.addEventListener("message",saleListOnMessageService.onMessage,false)||window.attachEvent&&window.attachEvent("onmessage",saleListOnMessageService.onMessage);
if(!_.isEmpty(stateObj))stateRestore();else{localStorageService.remove("state-saved-sale-list");$("#searchSaleslistForm").append(" \x3cinput class\x3d'hiddenFields' type\x3d'hidden' name\x3d'query' value\x3d'*'\x3e\x3cbr\x3e");$("#searchSaleslistForm").append(" \x3cinput class\x3d'hiddenFields' type\x3d'hidden' name\x3d'sort' value\x3d'auction_date_utc asc'\x3e\x3cbr\x3e");$("#searchSaleslistForm").append(" \x3cinput class\x3d'hiddenFields' type\x3d'hidden' name\x3d'defaultSort' value\x3d'true'\x3e\x3cbr\x3e");
$("#searchSaleslistForm").append(" \x3cinput class\x3d'hiddenFields' type\x3d'hidden' name\x3d'backUrl' value\x3d'"+$location.url()+"'\x3e\x3cbr\x3e");if(searchCriteria.MISC)for(var i=0;i<searchCriteria.MISC.length;i++)$("#searchSaleslistForm").append(" \x3cinput type\x3d'hidden' class\x3d'hiddenFields' name\x3d'filter[MISC]' value\x3d'"+searchCriteria.MISC[i]+"'\x3e\x3cbr\x3e");$("#searchSaleslistForm").submit()}};var addAlerts=function(type,msg){self.alerts.push({msg:msg,type:type})};self.closeAlert=
function(index){self.alerts.splice(index,1);self.isAlertOnModal=false};self.showLess=function(){var url=$location.url();url=url.replace("saleListResultAll","saleListResult");$location.url(url)};function reloadtable(){$(".hiddenFields").remove();stateSave();var appliedFilters=_.groupBy(self.appliedFilters,function(item){return item.quickPickCode});$("#searchSaleslistForm").append(" \x3cinput type\x3d'hidden'  class\x3d'hiddenFields' name\x3d'query' value\x3d'*'\x3e\x3cbr\x3e");$("#searchSaleslistForm").append(" \x3cinput type\x3d'hidden'  class\x3d'hiddenFields' name\x3d'sort[0]' value\x3d'"+
self.sortBy+"'\x3e\x3cbr\x3e");$("#searchSaleslistForm").append(" \x3cinput type\x3d'hidden'  class\x3d'hiddenFields' name\x3d'sort[1]' value\x3d'"+self.secSortBy+"'\x3e\x3cbr\x3e");$("#searchSaleslistForm").append(" \x3cinput type\x3d'hidden'  class\x3d'hiddenFields' name\x3d'watchListOnly' value\x3d'"+self.watchListOnly+"'\x3e\x3cbr\x3e");$("#searchSaleslistForm").append(" \x3cinput class\x3d'hiddenFields' type\x3d'hidden' name\x3d'backUrl' value\x3d'"+$location.url()+"'\x3e\x3cbr\x3e");$("#searchSaleslistForm").append(" \x3cinput class\x3d'hiddenFields' type\x3d'hidden' name\x3d'hideImages' value\x3d'"+
!self.showImages+"'\x3e\x3cbr\x3e");if(searchCriteria.MISC)for(var i=0;i<searchCriteria.MISC.length;i++)$("#searchSaleslistForm").append(" \x3cinput type\x3d'hidden'  class\x3d'hiddenFields' name\x3d'filter[MISC]' value\x3d'"+searchCriteria.MISC[i]+"'\x3e\x3cbr\x3e");angular.forEach(appliedFilters,function(valueArr,key){for(var i=0;i<valueArr.length;i++)$("#searchSaleslistForm").append(" \x3cinput type\x3d'hidden'  class\x3d'hiddenFields' name\x3d'filter["+key+"]' value\x3d'"+valueArr[i].query+"'\x3e\x3cbr\x3e")});
$("#searchSaleslistForm").submit()}function resizeIframe(obj,frame){obj.style.height=frame.contentHeight+"px"}function boldLot(iframe){if(self.viewedLot){var doc=iframe.contentDocument||iframe.contentWindow.document;doc.getElementById(self.viewedLot).parentElement.parentElement.className+=" bold";self.viewedLot=null}}var msgFunction=function(evt){console.log(evt);var message=evt.data;try{if(typeof message!=="string")return;else if(message.indexOf("salesListFrameLoaded")!=-1){var saleslistIframe=window.frames["resultsFrame"];
resizeIframe(document.getElementById("resultsFrame"),saleslistIframe);boldLot(document.getElementById("resultsFrame"))}else if(message.indexOf("salesListFacetsLoaded")!=-1){var saleslistIframe=window.frames["resultsFrame"];var facets=JSON.parse(saleslistIframe.facets);self.totalRecords=saleslistIframe.totalRecords;resizeIframe(document.getElementById("resultsFrame"),saleslistIframe);populateFacets(facets)}else if(message.indexOf("salesListSorted")!=-1){var saleslistIframe=window.frames["resultsFrame"];
self.sortBy=saleslistIframe.sortBy;self.secSortBy=saleslistIframe.secSortBy;reloadtable()}else if(message.indexOf("openLocationsModal")!=-1){var saleslistIframe=window.frames["resultsFrame"];var requestedYard=saleslistIframe.yard;getYardDetails(requestedYard)}else if(message.indexOf("openImagesModal")!=-1){var saleslistIframe=window.frames["resultsFrame"];var requestedImages=saleslistIframe.requestedImages;getImages(requestedImages)}else if(message.indexOf("refreshSelectedLots")!=-1){var saleslistIframe=
window.frames["resultsFrame"];var lots=saleslistIframe.selectedLots;var compareLotIdString=saleslistIframe.compareLotIdString;var selectAllChecked=saleslistIframe.selectAllChecked;refeshSelectedLots(lots,compareLotIdString,selectAllChecked)}else if(message.indexOf("addToWatchlist")!=-1){var saleslistIframe=window.frames["resultsFrame"];var lotNumber=saleslistIframe.lotNumber;addToWatchList(lotNumber)}else if(message.indexOf("removeFromWatchlist")!=-1){var saleslistIframe=window.frames["resultsFrame"];
var lotNumber=saleslistIframe.lotNumber;removeFromWatchlist(lotNumber)}else if(message.indexOf("openLotDetails")!=-1){var saleslistIframe=window.frames["resultsFrame"];var url=saleslistIframe.requestedLot;var resultIndex=saleslistIframe.resultIndex;var totalRecords=saleslistIframe.totalRecords;goToLot(url,resultIndex,totalRecords)}}catch(e){console.log("Not a Sale list event")}};saleListOnMessageService.setMsgFunction(msgFunction);init();var goToLot=function(lotUrl,resultIndex,totalRecords){var info=
{backTo:"."+$location.url(),resultIndex:resultIndex,totalRecords:totalRecords,fromSearch:true};localStorageService.set("lot-navigation-info",info);if(lotUrl.indexOf(".")==0)lotUrl=lotUrl.substring(1);$location.url(lotUrl);self.$apply()};function populateFacets(facets){self.filters=[];for(var i=0;i<facets.length;i++){var facet={};facet.name=facets[i].displayName;facet.includeTag=facets[i].includeTag;facet.quickPickCode=facets[i].quickPickCode;facet.limit=10;if(_.isUndefined(facet.includeTag)||_.isNull(facet.includeTag)||
_.isEmpty(facet.includeTag.trim()))if(_.isEmpty(self.nullIncludeTags))self.nullIncludeTags.push(facet.quickPickCode);facet.items=copartUtils.clubFacets(facets[i].facetCounts,facet.quickPickCode);facet.facetField=facets[i].facetField;self.filters.push(facet)}self.$digest()}self.setWatchListOnly=function(){self.watchListOnly=!self.watchListOnly;reloadtable()};self.applyFilter=function(item,$event){if($event.target.checked){var item={};item.id=$event.target.id;item.name=$event.target.value;item.quickPickCode=
$event.target.name;item.query=$event.target.attributes.query.value;self.appliedFilters.push(item)}else removeFilter($event.target.id);reloadtable()};self.removeFilter=function(id){removeFilter(id);reloadtable()};self.isFilterApplied=function(id){return!_.isUndefined(_.find(self.appliedFilters,function(item){return item.id==alphanumericFilter(id)}))};self.clearSectionFilters=function(filter){var sectionFilters=_.filter(self.appliedFilters,function(item){return item.quickPickCode==filter.quickPickCode});
_.each(sectionFilters,function(item){removeFilter(item.id)});reloadtable()};self.clearAllFilters=function(){self.appliedFilters=[];self.watchListOnly=false;reloadtable()};function removeFilter(id){var index=_.findIndex(self.appliedFilters,function(item){return item.id==id});self.appliedFilters.splice(index,1)}self.errCustomColCount=false;self.alerts=[];self.isAlertOnModal=false;$("#multiselect").multiselect({keepRenderingSort:true});self.resetToDefault=function(id){$("#multiselect_to").empty();var defValues=
[];var defValuesOrig=[];$("#multiselect_def option").each(function(){defValues.push($(this).clone())});$("#multiselect_to").html(defValues);$("#multiselect").empty();var buyerAvailValues=[];var defAvailFields=[];$("#multiselect_defAvail option").each(function(){buyerAvailValues.push($(this).clone())});$("#multiselect").html(buyerAvailValues)};self.confirmCustomization=function(){var selectedOptions=[];var options=$("#multiselect_to option");if(options.length<7){var values=$.map(options,function(option){return option.index+
":"+option.value});function mapper(str){var o={};strArr=str.split(":");o[strArr[0].trim()]=strArr[1].trim();return o}var resultArray=values.map(mapper);var colString=JSON.stringify(values);$.ajax({type:"POST",dataType:"json",contentType:"application/json; charset\x3dutf-8",url:"/data/lotSrchDisplayPref",data:JSON.stringify({"customLotSearchColumns":colString}),success:function(result){if(result&&result.returnCode===1){$("#customize").modal("hide");$("body").removeClass("modal-open");$(".modal-backdrop").remove();
var currentPageTemplate=$route.current.templateUrl;localStorageService.set("restore-search-state",true);$location.search("state","restore");$templateCache.remove(currentPageTemplate);$route.reload()}},error:function(){}})}else{self.errCustomColCount=true;addAlerts("danger","You can only customize a maximum of 6 columns for display.Please re-select your customization.");self.isAlertOnModal=true}};var getYardDetails=function(requestedYard){self.yardDetails={};self.yardDetails.showInventory=true;dataServiceG2.getLocationDetail(requestedYard.yardNumber,
function(response){self.yardDetails=response.data;self.yardDetails.liveAuction=requestedYard.live=="false"?false:true;if(self.yardDetails.liveAuction){self.yardDetails.auctionLane=requestedYard.lane;self.yardDetails.yardNumber=requestedYard.yardNumber}jQuery("#locationGenericModal").modal("show")})};var getImages=function(requestedImages){self.images={};self.images.lotDesc=requestedImages.lotDesc;self.images.lotId=requestedImages.lotId;self.images.currentBid=requestedImages.currentBid;self.images.bidString=
$filter("globalize_currency_using_code")(requestedImages.currentBid,requestedImages.currecyCode);self.images.resultIndex=requestedImages.resultIndex;self.images.totalRecords=requestedImages.totalRecords;self.isAlreadyAdded=watchListService.isAlreadyAdded;self.addToWatchList=watchListService.addToWatchList;self.removeFromWatchList=watchListService.removeFromWatchList;var auctionDate=parseInt(requestedImages.auctionDate);self.images.auctionTimeLeft=auctionsCalendarService.timeToAuction(auctionDate);
self.locale=self.$parent.locale;self.images.storeNavigationInfo=function(){var info={backTo:"."+$location.url(),resultIndex:self.images.resultIndex,totalRecords:self.images.totalRecords,fromSearch:true};localStorageService.set("lot-navigation-info",info)};dataServiceG2.getLotImages(requestedImages.lotId,function(response){if(response!=null){var imagesList=response.data.data.imagesList;self.images.fullSizeImages=imagesList.FULL_IMAGE;self.images.thumbNailImages=imagesList.THUMBNAIL_IMAGE;if(self.images.thumbNailImages.length>
10){self.images.thumbnailLength=10;thumbnailLength=10}else{self.images.thumbnailLength=5;thumbnailLength=5}$timeout(loadImageViewer,0)}})};var loadImageViewer=function(){carousel4=new ImageCarousel("#carousel4",{errorImage:"/images/testImages/no_photo.jpg",lazyInit:true,buyerNumber:userService.userConfig.buyerNumber,lotId:self.images.lotId,thumbnailLength:thumbnailLength});carousel4.initImageViewer();jQuery("#lotImage").modal("show");jQuery(function(){var image={};image=carousel4.showStripImage(0)});
carousel4.showImage=function(element){var sequence=jQuery(element).attr("data-sequence");image=carousel4.showStripImage(sequence-1)}};var refeshSelectedLots=function(lots,compareLotIdString,selectAllChecked){self.selectAllChecked=selectAllChecked;self.selectedLots=lots;self.compareLotIdString=compareLotIdString;self.$digest()};self.compareLots=function(){if(!self.selectAllChecked)if(self.selectedLots.length>1&&self.selectedLots.length<6){var url="/compareLots/"+self.compareLotIdString;backToLinkService.setBackToLink($location.url());
$location.url(url)}else addAlerts("danger","Select a minimum of 2 vehicles for comparison and a maximum of 5. Please try again.");else addAlerts("danger","Select a minimum of 2 vehicles for comparison and a maximum of 5. Please try again.")};var addToWatchList=function(lotNumber){if(userService.isAnonymous())$("#loginRegister").modal("show");else watchListService.addToWatchList(lotNumber,function(response){window.frames["resultsFrame"].postMessage("refreshWatchListLots","*")})};var removeFromWatchlist=
function(lotNumber){watchListService.removeFromWatchList(lotNumber,function(response){window.frames["resultsFrame"].postMessage("refreshWatchListLots","*")})};function createFilterObject(){var appliedFilters=_.groupBy(self.appliedFilters,function(item){return item.quickPickCode});var tempObj={};angular.forEach(appliedFilters,function(valueArr,key){tempObj[key]=[];for(var i=0;i<valueArr.length;i++)tempObj[key].push(valueArr[i].query)});tempObj.MISC=searchCriteria.MISC;return tempObj}self.addCheckedToWatchList=
function(){if(!userService.isAnonymous())if(self.selectAllChecked){if(self.totalRecords>99){addAlerts("danger",self.locale.messages["app.msg.lotsearch.add.max"]);return}var queryArr=[];queryArr.push(self.query);addAllToWatchList({query:["*"],filter:createFilterObject(),sort:["auction_date_utc asc"],page:0,size:1E5})}else{if(self.selectedLots.length==0){addAlerts("danger",self.locale.messages["app.msg.lotsearch.please.select"]);return}if(self.selectedLots.length>99){addAlerts("danger",self.locale.messages["app.msg.lotsearch.add.max"]);
return}watchListService.addAllCheckedToWatchList(self.selectedLots,function(response){addAlerts("success",self.locale.messages["app.msg.lotsearch.add.watchlist"]);window.frames["resultsFrame"].postMessage("refreshWatchListLots","*")},watchListError)}};var watchListError=function(response){if(!AppUtils.isUndefined(response.data.data))addAlerts("danger","Unable to add the following lots: "+response.data.data.toString());else addAlerts("danger","Error occurred while adding")};var addAllToWatchList=function(data){watchListService.addAllToWatchList(data,
function(response){addAlerts("success",self.locale.messages["app.msg.lotsearch.add.watchlist"])},watchListError,function(){window.frames["resultsFrame"].postMessage("refreshWatchListLots","*")})};self.showHideImages=function(flag){if(flag)window.frames["resultsFrame"].postMessage("showImages","*");else window.frames["resultsFrame"].postMessage("hideImages","*");stateSave()};var yardDetailsLoadedEvent=$rootScope.$on("yardDetailsLoaded",function(event,data){self.yardDetails=data});$scope.$on("$destroy",
function(){yardDetailsLoadedEvent()})}]);app.controller("noResultsController",["$scope","$location","searchText","$rootScope","urlService",function($scope,$location,searchText,$rootScope,urlService){var self=$scope;self.searchObj=searchText.getSearch();self.noResultsTemplateUrl=urlService.getNoResultsURL($location.url());console.log(self.searchObj);self.searchWithSpellCheck=function(searchText){$rootScope.$broadcast("search-again",{searchText:searchText})}}]);
app.service("searchText",[function(){var service=this;var search={};service.construct=function(text,spellChecks){search.searchText=text;search.spellChecks=spellChecks};service.getSearch=function(){var result={};result.searchText=search.searchText;result.spellChecks=search.spellChecks;_.defaults(result,{searchText:"",spellChecks:[]});return result}}]);
app.controller("compareLotsController",["$scope","$http","$location","dataServiceG2","$routeParams","$timeout","urlService","userService","config","appConfigService","backToLinkService","copartUser","localStorageService",function($scope,$http,$location,dataServiceG2,$routeParams,$timeout,urlService,userService,config,appConfigService,backToLinkService,copartUser,localStorageService){var self=$scope;var log=new Logger({name:"ServerSideDataTable",level:config.logLevel});self.dateFormat=copartUser.getUserConfig().displayPref.dateFormat.toUpperCase();
self.companyCode=copartUser.getUserConfig().companyCode;self.lotsToCompare=[];self.lotsToCompareIds="";self.loading=true;self.imageURL=appConfigService.getEnvConfigProps().imageBaseUrl;if(!_.isUndefined($routeParams.lotIdList)&&!_.isNull($routeParams.lotIdList)&&$routeParams.lotIdList.trim().length>0){self.lotsToCompare=$routeParams.lotIdList.split(",");self.lotsToCompareIds=$routeParams.lotIdList}self.backToLink=backToLinkService.getBackToLink();localStorageService.set("restore-search-state",true);
self.lotDetails=[];self.WatchList;self.watchListIds=[];self.isWatchList=false;self.images={};self.lotNumber;var init=function(){$(function(){$(".modal-content").draggable()});$(".carousel").each(function(){$(this).carousel({pause:true,interval:false})});if(!userService.isAnonymous()){getWatchListForBuyer();self.guestUser=false}else self.guestUser=true;self.closecount=0;self.len=self.lotsToCompare.length;dataServiceG2.getLotComparisionDetails(self.lotsToCompareIds,lotComparisionCallBack)};var lotComparisionCallBack=
function(response){if(response.data.data.lotDetails)self.lotDetails=_.values(response.data.data.lotDetails);self.loading=false};var lotCompareBidDataCallBack=function(response){self.lotDetails=response.data.data.lotDetails;self.loading=false};var getWatchListForBuyer=function(){$http({method:"GET",url:"/data/lots/watchList"}).then(function successCallback(response){if(_.isUndefined(self.watchList))self.watchList=response.data.data.watchList;else self.watchList=_.union(self.watchList,response.data.data.watchList)},
function errorCallback(response){})};self.removeFromCompare=function(event){console.log("Removing from compare..."+event.target);var target=angular.element(event.target);if(self.len-2!=self.closecount){target.closest(".lot-compare-content").hide(1E3);self.closecount++}else $("#CompareModal").modal("show")};self.addToWatchList=function(lotNumber){if(!userService.isAnonymous())$http({method:"GET",url:"/data/lots/addToWatchList/"+lotNumber}).then(function successCallback(response){if(response.data.returnCode==
1){var item={};if(self.isWatchList){var index=_.findIndex(self.watchList,function(lot){return lot.lotId==lotNumber});self.watchList.splice(index,1)}else{item.lotId=lotNumber;self.watchList.push(item)}}else log.error("Failed to add lot in watch list")},function errorCallback(response){log.error("Error: Failed to add lot in watch list")})};self.removeFromWatchList=function(lotNumber){if(!userService.isAnonymous())$http({method:"GET",url:"/data/lots/removeFromWatchList/"+lotNumber}).then(function successCallback(response){if(response.data.returnCode==
1)if(self.isWatchList){var item={};item.lotId=lotNumber;self.watchList.push(item)}else{var index=_.findIndex(self.watchList,function(lot){return lot.lotId==lotNumber});self.watchList.splice(index,1)}else log.error("Failed to removed lot from watch list")},function errorCallback(response){log.error("Error: Failed to add lot in watch list")})};self.isAlreadyAdded=function(lotNumber){var object=_.find(self.watchList,function(item){return item.lotId==lotNumber});if(object)if(self.isWatchList)return false;
else return true;else if(self.isWatchList)return true;else return false};self.showLotImages=function(lotId){console.log("Fetch lot images for..."+lotId);self.lotNumber=lotId;dataServiceG2.getLotImages($scope.lotNumber,function(response){if(response!=null){var imagesList=response.data.data.imagesList;self.fullSizeImages=imagesList.FULL_IMAGE;self.thumbNailImages=imagesList.THUMBNAIL_IMAGE}});loadImageViewer()};var loadImageViewer=function(){var slider=$(".bxslider").bxSlider({mode:"horizontal",pagerCustom:"#bx-pager",
nextSelector:"#lot-slider-next",prevSelector:"#lot-slider-prev",prevText:"",nextText:""});$("#lot-slider-next").click(function(){slider.goToNextSlide();return false});$("#lot-slider-prev").click(function(){slider.goToPrevSlide();return false});$(".bxslider img").wrap('\x3cspan style\x3d"display:inline-block"\x3e\x3c/span\x3e').css("display","block").parent().zoom({magnify:2})};$scope.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){loadImageViewer()});var highlightIcons=_.where(appConfigService.appConfig.highlightIcons,
{iconType:"H"});var validIconCodes=_.pluck(highlightIcons,"iconCode");self.iconCodesFilter=function(code){return validIconCodes.indexOf(code)>-1};self.inArray=function(item,array){return-1!==array.indexOf(item)};init()}]);
app.controller("auctionCalendarController",["$scope","searchCriteria","$locale","$http","$location","copartUser","copartUtils","auctionsCalendarService","dataServiceG2","userService",function($scope,searchCriteria,$locale,$http,$location,copartUser,copartUtils,auctionsCalendarService,dataServiceG2,userService){var self=$scope;self.auctionLists=null;self.error=null;self.isAnonymous=userService.isAnonymous();self.completeAuctionsList=[];self.liveAuctionsDisplay=[];self.closedAuctionsDisplay=[];self.laterAuctionsDisplay=
[];self.allWeeksHeader=[];self.laneSelected=null;self.wlWaiting=true;self.wlSpinner=true;self.laneDetails=null;self.locationDetail=[];self.todayAuctions=[];self.auction=null;self.dateFormat=copartUser.getUserConfig().dateFormat.toUpperCase();self.siteCode=copartUser.getUserConfig().siteCode;var timeZone=self.$parent.userConfig.selectedTimezone;var time=moment.tz(auctionsCalendarService.todaysAuctionDate,timeZone);self.offset=time.tz(timeZone).format("Z");self.abbr=time.tz(timeZone).zoneAbbr();$scope.hideTime=
false;self.TimesButton=false;$scope.showText="Show Times";if(self.siteCode!="CRTSUS"){$scope.showText="Hide Times";$scope.hideTime=true}$scope.toggleTimeDisplay=function(){$scope.hideTime=!$scope.hideTime;$scope.showText=$scope.hideTime?"Hide Times":"Show Times"};function GetFullName(weekDay){var days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];var day=days[weekDay];return day}self.addDaysToDate=function(inputDate,noOfDays){var newDate=moment(inputDate).add(noOfDays,"days").toDate();
return newDate};var fetchAuctionsForDay=function(date){var auctions=_.find(self.auctionList,function(val){return val.userTZAuctionDate==date});return auctions};self.groupAuctionsIntoSevenWeeks=function(auctionsList){var subGroupArray=[];var size=7;while(auctionsList.length>0)if(auctionsList.length>=7)subGroupArray.push(auctionsList.splice(0,size));else subGroupArray.push(auctionsList.splice(0,auctionsList.length));return subGroupArray};self.createAuctionCalendar=function(auctionsList){var startDayOfWeek=
auctionsCalendarService.startDayofWeek.toDate();var auctionsForMissingDay;var auctionsListLength=auctionsList.length;var eachWeekHeader=[];for(var index=0;index<=42;index++){var nextDay=self.addDaysToDate(startDayOfWeek,index);var weekDay=moment(nextDay).day();if(index!=0&&weekDay==1){self.allWeeksHeader.push(eachWeekHeader);eachWeekHeader=[];if(index==42)break}var nextDayFormatted=moment(nextDay).format(self.dateFormat);var auctionDate={auctionDate:nextDayFormatted,auctionDay:GetFullName(weekDay)};
eachWeekHeader.push(auctionDate);var auctionsForNextDay=fetchAuctionsForDay(nextDayFormatted);if(auctionsForNextDay)self.completeAuctionsList.push(auctionsForNextDay);else{auctionsForMissingDay={};auctionsForMissingDay.userTZAuctionDate=nextDayFormatted;auctionsForMissingDay.auctionDay=GetFullName(weekDay);auctionsForMissingDay.auctions=[];self.completeAuctionsList.push(auctionsForMissingDay)}}};self.fullWeekAuctions=function(inputAuctions,weekOfAuction){var fullWeekAuctions=[];var startDayOfWeek=
weekOfAuction*7;var presentWeek=auctionsCalendarService.startDayofWeek.toDate();var closedAuctionCheck=0;self.previousDayAuctionCheck=false;for(var i=startDayOfWeek;i<startDayOfWeek+7;i++){var nextDay=self.addDaysToDate(presentWeek,i);var timeZone=copartUser.getUserConfig().selectedTimezone;var time=moment.tz(auctionsCalendarService.todaysAuctionDate,timeZone);var offset=time.tz(timeZone).format("Z");var today=auctionsCalendarService.todaysAuctionDate.utcOffset(self.offset).format(self.dateFormat);
var nextDayFormatted=moment(nextDay).format(self.dateFormat);var flag=0;for(var j=0;j<inputAuctions.length;j++)if(nextDayFormatted==inputAuctions[j].userTZAuctionDate&&moment(nextDayFormatted,self.dateFormat)>=moment(today,self.dateFormat)){flag=1;closedAuctionCheck=1;fullWeekAuctions.push(inputAuctions[j])}if(flag==0){var weekDay=moment(nextDay).day();var auction={auctions:[],auctionDay:GetFullName(weekDay),userTZAuctionDate:nextDayFormatted};fullWeekAuctions.push(auction)}}if(closedAuctionCheck==
0)self.previousDayAuctionCheck=true;return fullWeekAuctions};var init=function(data){self.liveAuctionsDisplay=_.sortBy(data.todayAuctions.liveAuctions,function(o){return o.fullTime});self.closedAuctionsDisplay=_.sortBy(data.todayAuctions.endedAuctions,function(o){return o.fullTime});self.laterAuctionsDisplay=_.sortBy(data.todayAuctions.laterAuctions,function(o){return o.fullTime});self.auctionList=_.chain(data.allList).groupBy(function(num){return num.auctionDate.dateAsInt}).map(function(value,key){return{auctionKey:key,
userTZAuctionDate:moment(new Date(key.substring(0,4),parseInt(key.substring(4,6))-1,key.substring(6,8))).format(self.dateFormat),auctionDay:GetFullName(moment(new Date(key.substring(0,4),parseInt(key.substring(4,6))-1,key.substring(6,8))).day()),auctions:value}}).value();self.createAuctionCalendar(self.auctionList);self.groupedAuctionsList=self.groupAuctionsIntoSevenWeeks(self.completeAuctionsList);self.finalGroup=[];for(var i=0;i<self.groupedAuctionsList.length;i++){var subGroup=[];for(var j=0;j<
self.groupedAuctionsList[i].length;j++)for(var k=0;k<self.groupedAuctionsList[i][j].auctions.length;k++)subGroup.push(self.groupedAuctionsList[i][j].auctions[k]);self.finalGroup.push(subGroup)}self.groupByTime=[];for(var i=0;i<self.finalGroup.length;i++){self.auctionListByTime=_.chain(self.finalGroup[i]).groupBy(function(num){return num.fullTime}).map(function(value,key){return{auctionTime:value[0].startTime,fullTime:key,auctions:value}}).value();self.newSortedTimeAuctions=_.sortBy(self.auctionListByTime,
function(o){return parseInt(o.fullTime)});self.groupByTime.push(self.newSortedTimeAuctions)}for(var i=0;i<self.groupByTime.length;i++){self.groupByTime[i].weekHeader=self.allWeeksHeader[i];for(var j=0;j<self.groupByTime[i].length;j++){self.auctionListByWeek=_.chain(self.groupByTime[i][j].auctions).groupBy(function(num){return num.auctionDate.dateAsInt}).map(function(value,key){return{userTZAuctionDate:moment(new Date(key.substring(0,4),parseInt(key.substring(4,6))-1,key.substring(6,8))).format(self.dateFormat),
auctionDay:GetFullName(moment(new Date(key.substring(0,4),parseInt(key.substring(4,6))-1,key.substring(6,8))).day()),auction:value}}).value();var weekAuctions=self.fullWeekAuctions(self.auctionListByWeek,i);if(self.previousDayAuctionCheck==true)self.groupByTime[i][j].auctionTime="0";self.groupByTime[i][j].auctions=weekAuctions}}self.wlWaiting=false;self.TimesButton=true};auctionsCalendarService.getAllAuctionData().then(function(data){init(data)});$(function(){$('[rel\x3d"popover"]').popover({container:"body",
html:true,content:function(){var clone=$($(this).data("popover-content")).clone(true).removeClass("hide");return clone}}).click(function(e){e.preventDefault()})});self.selectedLane=function(laneInfo){self.laneSelected=self.auction.yard.number+"-"+laneInfo.lane};self.openModal=function(auction){self.auction=auction;self.laneDetails=auction.laneInfoList[0];self.selectedLane(self.laneDetails)};self.closeModal=function(id){copartUtils.closeModal(id)};self.validateDay=function(inputDate){var today=auctionsCalendarService.todaysAuctionDate.utcOffset(self.offset).format(self.dateFormat);
if(inputDate===today)return"today";else if(moment(inputDate,self.dateFormat)<moment(today,self.dateFormat))return"past";else return"future"};self.redirectSaleList=function(auction,liveAuction){if(auction){liveAuction=liveAuction==true?true:false;var auctionDate=String(auction.auctionDateSolr.dateAsInt);var date1=moment(new Date(auctionDate.substring(0,4),parseInt(auctionDate.substring(4,6))-1,auctionDate.substring(6,8)));var date2=date1.format("YYYY-MM-DD");var saleUrl="/saleListResult/"+auction.yard.number+
"/"+date2+"?location\x3d"+auction.yard.name+"\x26saleDate\x3d"+auction.currentSaleTimeEpoch+"\x26liveAuction\x3d"+liveAuction+"\x26from\x3d/auctionCalendar\x26yardNum\x3d"+auction.yard.number;if(auction.isLive)return saleUrl+"\x26lane\x3d"+self.laneSelected.split("-")[1];return saleUrl}}}]);
app.controller("auctionCalendarMapController",["$scope","$locale","$http","searchCriteria","$location","auctionsCalendarService","userService","copartUser",function($scope,$locale,$http,searchCriteria,$location,auctionsCalendarService,userService,copartUser){var self=$scope;self.searchCriteria=searchCriteria;self.auction=undefined;self.laneSelected=null;self.laneDetails=null;self.dateFormat=copartUser.getUserConfig().dateFormat.toUpperCase();var modalId="map-location-modal";var openModal=function(){$("#"+
modalId).modal({backdrop:false});$("#"+modalId).draggable({handle:".modal-dialog"})};var init=function(todaysAuction){self.liveAuctions=todaysAuction.liveAuctions;self.closedAuctions=todaysAuction.endedAuctions;self.futureAuctions=todaysAuction.laterAuctions;for(var i=0;i<self.liveAuctions.length;i++)if(self.liveAuctions[i].hasOwnProperty("yardDetails")){var date=self.liveAuctions[i].auctionDate.dateAsInt.toString();self.liveAuctions[i].auctionDate.formattedDate=moment(new Date(date.substring(0,4),
date.substring(4,6)-1,date.substring(6,8))).format(self.dateFormat);createMarker(self.liveAuctions[i],"../images/auctionmap-icons/green-50-smaller.png")}for(var i=0;i<self.futureAuctions.length;i++)if(self.futureAuctions[i].hasOwnProperty("yardDetails")){var date=self.futureAuctions[i].auctionDate.dateAsInt.toString();self.futureAuctions[i].auctionDate.formattedDate=moment(new Date(date.substring(0,4),date.substring(4,6)-1,date.substring(6,8))).format(self.dateFormat);createMarker(self.futureAuctions[i],
"../images/auctionmap-icons/blue-50-smaller.png")}if(self.liveAuctions.length>0)self.auction=self.liveAuctions[0];else if(self.futureAuctions.length>0)self.auction=self.futureAuctions[0];if(self.auction){self.laneDetails=self.auction.laneInfoList[0];self.selectedLane(self.laneDetails)}openModal()};auctionsCalendarService.getAllAuctionData().then(function(data){init(data.todayAuctions)});var latitude=userService.userConfig.auctionMapCoordinates!=undefined?userService.userConfig.auctionMapCoordinates.lat:
30;var longitude=userService.userConfig.auctionMapCoordinates!=undefined?userService.userConfig.auctionMapCoordinates["long"]:-78;var mapCenter=new google.maps.LatLng(latitude,longitude);var mapOptions={zoom:4,center:mapCenter,mapTypeId:google.maps.MapTypeId.TERRAIN};$scope.map=new google.maps.Map(document.getElementById("mapTest"),mapOptions);$scope.markers=[];var infoWindow=new google.maps.InfoWindow;var createMarker=function(auction,Icon){var marker=new google.maps.Marker({map:$scope.map,position:new google.maps.LatLng(auction.yardDetails.yardLatitude,
auction.yardDetails.yardLongitude),title:auction.yardDetails.yardName,icon:Icon});google.maps.event.addListener(marker,"click",function(){self.$apply(function(){self.auction=auction});openModal()});$scope.markers.push(marker)};$(window).resize(function(){var h=$(window).height(),offsetTop=60;$(".map").css("height",h-offsetTop);if($(window).width()<992)$("body").removeClass("modal-open")}).resize();$scope.openInfoWindow=function(e,selectedMarker){e.preventDefault();google.maps.event.trigger(selectedMarker,
"click")};self.selectedLane=function(laneInfo){self.laneSelected=self.auction.yard.number+"-"+laneInfo.lane};self.redirectSaleList=function(auction){var auctionDate=String(auction.auctionDate.dateAsInt);var date1=moment(new Date(auctionDate.substring(0,4),parseInt(auctionDate.substring(4,6))-1,auctionDate.substring(6,8))).format("MM/DD/YYYY");var date2=moment(date1).format("YYYY-MM-DD");$location.url("/saleListResult/"+auction.yard.number+"/"+date2+"?location\x3d"+auction.yard.name+"\x26saleDate\x3d"+
auction.currentSaleTimeEpoch+"\x26liveAuction\x3dfalse\x26from\x3d/auctionCalendar\x26yardNum\x3d"+auction.yard.number)}}]);
app.controller("dashBoardController2",["$rootScope","$timeout","$scope","$http","$compile","$locale","dataServiceG2","copartUser","saveSearchCriteria","$location",function($rootScope,$timeout,$scope,$http,$compile,$locale,dataServiceG2,copartUser,saveSearchCriteria,$location){var self=$scope;var auctionsCountPromise=null;self.liveAuctions=0;self.pwdDaysToExp=copartUser.getUserConfig().pwdDaysToExp;$scope.timeInMs=0;self.portletOrder=self.userConfig.displayPref.dashBoardDisplayOrder;console.log("Current Layout of dashboard.."+
self.portletOrder);self.showBuyingPower=true;arrangePortlets();angular.element(document.querySelector("#placeholder")).empty();self.onSearch=function(criteria){angular.extend(saveSearchCriteria.data,JSON.parse(criteria));$location.url("/lotSearchResults?fromSavedSearch\x3dtrue")};self.formatStringDate=function(date){var saleDate=moment(date,"YYYYMMDD");return saleDate.format(copartUser.getUserConfig().dateFormat.toUpperCase())};self.updateSalesCount=function(){dataServiceG2.updateAuctionCount(function(response){if(response){var payload=
response.data.data[0];if(!_.isUndefined(payload)&&!_.isNull(payload)){self.liveAuctions=payload.length;auctionsCountPromise=$timeout(function(){self.updateSalesCount()},30*1E3)}}else;})};function arrangePortlets(){if(!_.isUndefined(self.portletOrder)&&!_.isNull(self.portletOrder)&&self.portletOrder.trim().length>0){if(self.portletOrder.indexOf('"')>=0)self.portletOrder=self.portletOrder.replace(/"/g,"");var colData=self.portletOrder.split("|");_.each(colData,function(data){if(!_.isUndefined(data)&&
!_.isNull(data)&&data.trim().length>0){var colId=data.split("\x3d")[0];var colData;if(colId==="sortable-1")colData=data.split("\x3d")[1]+",banner1";else colData="banner2,"+data.split("\x3d")[1];var orderedDivArray=colData.split(",");fillColumns(colId,orderedDivArray)}})}}function fillColumns(colId,colDivArray){var colElem=angular.element(document.querySelector("#"+colId));_.each(colDivArray,function(divId){if(!_.isUndefined(divId)&&!_.isNull(divId)&&divId.trim().length>0)if(divId!="banner2")appendPortlets(colElem,
divId);else appendPortlets(colElem.parent(),divId,true)})}function appendPortlets(colElem,divId,before){var portlet=angular.element(document.querySelector("#"+divId));if(before)colElem.prepend(portlet);else colElem.append(portlet);if(divId!="banner1"||divId!="banner2")$compile(portlet)($scope);portlet.css("display","block")}self.init=function(){var dragStart,itemOffset;$(".connectedSortable").sortable({connectWith:".connectedSortable",opacity:"0.9",containment:$("#drag"),helper:"clone",revert:1E3,
start:function(e,ui){console.log("start drag..",ui.placeholder);ui.placeholder.height(ui.item.height());dragStart=setInterval(function(){itemOffset=ui.item.offset().top>ui.placeholder.offset().top?ui.item.offset().top-ui.placeholder.offset().top:ui.placeholder.offset().top-ui.item.offset().top;console.log("226::",ui.item.position(),ui.placeholder.position())},100)},stop:function(event,ui){clearInterval(dragStart);if(itemOffset>600)$(this).sortable("cancel");$(ui.item).find("h5").click();var sortorder=
"";$(".connectedSortable").each(function(){var itemorder=$(this).sortable("toArray");var columnId=$(this).attr("id");sortorder+=columnId+"\x3d"+itemorder.toString()+"|"});self.portletOrder=sortorder;_.debounce(saveDashboardLayout(),5E3,false)}}).disableSelection();function saveDashboardLayout(){$.ajax({type:"POST",dataType:"json",contentType:"application/json; charset\x3dutf-8",url:"/data/custDashDisplayOrder",data:JSON.stringify({"dashBoardDisplayOrder":JSON.stringify(self.portletOrder)}),success:function(result){if(result&&
result.returnCode===1)console.log("portlet order saved !")},error:function(){}})}setInterval(function(){$("#sortable-1").find(".dropdiv_table").removeClass("rightdivDroparea");$("#sortable-2").find(".dropdiv_table").addClass("rightdivDroparea")},100);$(".connectedSortable").mousedown(function(){$("body").css({"overflow":"inherit","overflow-x":"inherit"})});$(".connectedSortable").mouseup(function(){$("body").css({"overflow":"auto","overflow-x":"hidden"})});$("#static_img1").mousedown(function(e){e.preventDefault();
e.stopPropagation();return false})};self.init();$scope.$on("$destroy",function(){if(auctionsCountPromise)$timeout.cancel(auctionsCountPromise)})}]);
app.controller("timeModalController",["$scope","userService",function($scope,userService){$scope.popupToggle=false;$scope.popupTimezone=false;$scope.showFlag=false;angular.element("body").click(function(e){var elementClicked=$(e.target).parents("#languagehome");var timezoneClicked=$(e.target).parents("#timezonehome");var lagnZoneClicked=$(e.target).parents("#lang");if($scope.popupToggle){if(elementClicked.length>0||$(e.target).hasClass("langformat_div"))$scope.popupToggle=true;else $scope.popupToggle=
false;$scope.$apply()}if($scope.popupTimezone){if(timezoneClicked.length>0||$(e.target).hasClass("maintimezone_div"))$scope.popupTimezone=true;else $scope.popupTimezone=false;$scope.$apply()}if($scope.showFlag){if(lagnZoneClicked.length>0||$(e.target).hasClass("langSelectText"))$scope.showFlag=true;else $scope.showFlag=false;$scope.$apply()}});$scope.togglePopup=function(e){e.stopPropagation();console.log(userService.userConfig.selectedLang);$scope.selectedLang=userService.userConfig.selectedLang;
angular.element("#languagehome").css("display","block");$scope.popupToggle=!$scope.popupToggle;if($scope.popupTimezone||$scope.showFlag){$scope.popupTimezone=false;$scope.showFlag=false}};$scope.timePopup=function(e){e.stopPropagation();angular.element("#timezonehome").css("display","block");$scope.popupTimezone=!$scope.popupTimezone;if($scope.popupToggle||$scope.showFlag){$scope.popupToggle=false;$scope.showFlag=false}};$scope.showFlagDrop=function(e){e.stopPropagation();angular.element("#lang").css("display",
"block");$scope.showFlag=!$scope.showFlag;if($scope.popupTimezone||$scope.popupToggle){$scope.popupTimezone=false;$scope.popupToggle=false}}}]);app.controller("salesListController",["$scope","$compile",function($scope,$compile){var self=$scope;window.compileSalesList=function($el){var retn=$compile($el)($scope);self.$digest()}}]);
app.controller("paymentHistoryController",["$scope","$http","$location","$compile","$filter","dataServiceG2","backToLinkService","saveLotNumbersService","paymentService","copartUser","localStorageService","History","dataTableConfig",function($scope,$http,$location,$compile,$filter,dataServiceG2,backToLinkService,saveLotNumbersService,paymentService,copartUser,localStorageService,History,dataTableConfig){var self=$scope;var table=new ServersideDatatable_DB(saveLotNumbersService,dataTableConfig);self.query=
$location.search().query;self.searchText=self.query;var initBidderList=[{bidderNumber:0,displayName:"ALL"}];self.filterForm={};self.filterForm.bidder=initBidderList[0];if(_.isUndefined(self.query)||_.isNull(self.query)||self.query=="")self.query="*";self.locale=$scope.$parent.locale;self.noOfDays="30";self.siteCode=copartUser.getUserConfig().siteCode;self.selectedCurrency=copartUser.getUserConfig().currencyCode;var selectedTimezone=copartUser.getUserConfig().selectedTimezone;var date=moment().tz(selectedTimezone).format("YYYY MMMM DD");
self.exportFileName="PaymentsHistory_"+date+".csv";var refreshBidders=true;if(self.siteCode==="CPRTCA"||self.siteCode==="CRTSCA"){self.selectedCurrency="CAD";self.unSelectedCurrency="USD"}else if(self.siteCode==="CPRTUS"||self.siteCode==="CRTSUS"){self.selectedCurrency="USD";self.unSelectedCurrency="CAD"}var saleReceipt="Sale Receipt";self.yardDetails={};self.images={};self.selectedBidderNum="0";self.paymentType="P";self.fromPaymentHistory=true;self.showBidderColumn=false;self.backToLink=$location.url();
backToLinkService.setBackToLink(self.backToLink);backToLinkService.setBackToLinkText("payment.history.back.history");var defualtDateFormat=self.userConfig.displayPref.dateFormat.toUpperCase();var getBidderPaymentCounts=function(){dataServiceG2.getBidderPaymentCounts(function(responseData){self.bidderList=_.map(responseData,function(bidderInvoices){return{bidderId:bidderInvoices[0].bn,bidderName:bidderInvoices[0].bna,invoiceCount:bidderInvoices.length,displayName:bidderInvoices[0].bn+"-"+bidderInvoices[0].bna+
"("+bidderInvoices.length+")"}});self.bidderList=_.union(initBidderList,self.bidderList);self.filterForm.bidder=self.bidderList[0];jQuery("#paymentHistoryDataTable").DataTable().state.save()})};function checkIfFromDetails(){try{var lastRoute=History.lastRoute;if(lastRoute&&(lastRoute.indexOf("lot/")==0||lastRoute.indexOf("invoiceDetails/")==0))return true;else return false}catch(e){return false}}var state=false;var stateRestoreFromAnywhere=localStorageService.get("restore-search-state-from-anywhere");
localStorageService.remove("restore-search-state-from-anywhere");if(checkIfFromDetails()||$location.search().state=="restore"||stateRestoreFromAnywhere)state=localStorageService.get("restore-search-state");saveLotNumbersService.clearAll();self.showRecords=[{desc:"Last 30 days",code:"30"},{desc:"Last 60 days",code:"60"},{desc:"Last 90 days",code:"90"},{desc:"90-180 days ago",code:"180"},{desc:"180 - 365 days ago",code:"365"}];self.swapCurrency=function(){self.unSelectedCurrency=[self.selectedCurrency,
self.selectedCurrency=self.unSelectedCurrency][0];self.reloadPaymentTable(self.selectedBidderNum)};if(_.contains(self.userConfig.roles,"ROLE_BROKER"))self.showBidderColumn=true;self.showSaleReciptColumn=false;if(self.userConfig.companyCode=="COPARTUK")self.showSaleReciptColumn=true;self.reloadPaymentTable=function(bidder){self.selectedBidderNum=bidder;var temptable=jQuery("#paymentHistoryDataTable").DataTable();if(!self.selectedBidderNum){temptable.ajax.url("/data/payments/history/0/"+self.selectedCurrency+
"/"+self.noOfDays).load();self.selectedBidderNum=0}else temptable.ajax.url("/data/payments/history/"+self.selectedBidderNum+"/"+self.selectedCurrency+"/"+self.noOfDays).load()};var dataTableOptions={"pageLength":20,"columnDefs":[{"targets":[0,1,2,3,4,5,6,7,8,9,10,11,12,13],"data":null,"defaultContent":""},{"targets":[0],"orderable":false},{"targets":["bidderId"],"visible":self.showBidderColumn,"searchable":false},{"targets":["saleReceipt"],"visible":self.showSaleReciptColumn,"searchable":false},{className:"control",
orderable:false,targets:-1}],"lengthMenu":[[20,25,50,100],[20,25,50,100]],"stateSave":state,"stateRetrieveFunction":function(data){self.noOfDays=data.noOfDays;self.selectedBidderNum=data.selectedBidderNum;self.selectedCurrency=data.selectedCurrency;if(self.selectedCurrency=="CAD")self.unSelectedCurrency="USD";else if(self.selectedCurrency=="USD")self.unSelectedCurrency="CAD";self.hideImagesFlag=data.hideImagesFlag;self.bidderList=data.bidderList;self.filterForm.bidder=_.find(self.bidderList,function(bidder){return bidder.bidderId==
self.selectedBidderNum});console.log(self.filterForm.bidder);refreshBidders=false;self.reloadPaymentTable(self.selectedBidderNum)},"url":"/data/payments/history/"+self.selectedBidderNum+"/"+self.selectedCurrency+"/"+self.noOfDays,"containsFilters":false,"bPaginate":true,"backToTop":false,"pagingType":"full_numbers","fnRowCallback":function(nRow,aData,iDisplayIndex){jQuery(".nowrap",nRow).attr("nowrap","nowrap");return nRow},"columns":[{"mData":"imgp","render":function(data,type,row){var html="\x3cspan class\x3d''\x3e\x3c/span\x3e\x3cimg alt\x3d'image' height\x3d'72' width\x3d'96' class\x3d'' src\x3d'"+
row["imgp"]+"' error-image\x3e";var viewAllStr="\x3cbr\x3e\x3cdiv class\x3d'viewallphotos'\x3e\x3ca  ng-href\x3d'' ng-click\x3d\"checkYardExist("+row["yn"]+",'"+row["ln"]+"',true)\" class\x3d'image_viewer_link'  data-lotDesc\x3d'"+row["in"]+"' data-lot\x3d'"+row["in"]+"'\x3eView All Photos\x3c/a\x3e\x3c/div\x3e";return row["imgp"]?html+viewAllStr:html}},{"mData":"ind","render":function(data,type,row){var invoiceDate=moment(row["ind"].dateAsInt,"YYYYMMDD");return invoiceDate.format(defualtDateFormat)}},
{"mData":"bn"},{"mData":"itn","render":function(data,type,row){if(row["itn"]>0)return row["itn"];else return""}},{"mData":"ln","render":function(data,type,row,meta){if(row["ln"]==row["in"])return'\x3ca ng-href\x3d"" ng-click\x3d\'checkYardExist('+row["yn"]+',"'+row["ln"]+"\")'\x3e"+row["ln"]+"\x3c/a\x3e";else if(row["in"]>0)return row["in"];else return""}},{"mData":"ly","render":function(data,type,row){if(row["ly"]>0)return row["ly"];else return""}},{"mData":"lm"},{"mData":"lom"},{"mData":"yna","render":function(data,
type,row){var html="";if(row["yn"]==655||row["yn"]==700||row["yn"]==400)html=row["yna"];else html="\x3ca class\x3d'cursor-pointer' href\x3d'./locationDetail/"+row["yn"]+"' target\x3d'_blank'\x3e"+"\x3cspan\x3e"+row["yna"]+"\x3c/span\x3e\x3c/a\x3e";return html}},{"mData":"id","render":function(data,type,row){if(row["ln"]==row["in"])return'\x3ca ng-href\x3d"" ng-click\x3d\'checkYardExist('+row["yn"]+',"'+row["ln"]+"\")'\x3e"+row["id"]+"\x3c/a\x3e";else if(row["in"]>0)return row["id"];else return""}},
{"mData":"lly","render":function(data,type,row){if(row["lly"]==0||row["lly"]=="")return"-";else{var leftYardDate=moment(row["lly"],"YYYYMMDD");return leftYardDate.format(defualtDateFormat)}}},{"mData":"dp","render":function(data,type,row){var datePaid=moment(row["dp"].dateAsInt,"YYYYMMDD");return datePaid.format(defualtDateFormat)}},{"mData":"ia","render":function(data,type,row){var invoiceAmount=$filter("globalize_currency_using_code")(data,row["cc"],2);var invType=row["ln"]>0?"L":"M";if(row["iba"]&&
self.userConfig.companyCode=="COPARTUK"&&row["lly"]!=0)return'\x3ca href\x3d"./invoiceDetails/'+row["in"]+"/"+self.paymentType+"/"+row["cc"]+"/"+invType+"/"+row["ln"]+'"\x3e'+invoiceAmount+"\x3c/a\x3e";if(row["iba"]&&self.userConfig.companyCode=="COPART")return'\x3ca href\x3d"./invoiceDetails/'+row["in"]+"/"+self.paymentType+"/"+row["cc"]+"/"+invType+"/"+row["ln"]+'"\x3e'+invoiceAmount+"\x3c/a\x3e";else return invoiceAmount}},{"mData":"vin","render":function(data,type,row){var vin=row["vin"];if(copartUser.getUserConfig().companyCode==
"COPARTUK")vin=$filter("limitTo")(row["vin"],11,0);return vin}},{"mData":"in","render":function(data,type,row){if(self.siteCode==="CPRTCA"||self.siteCode==="CPRTUS")return"";else return'\x3ca href\x3d"./invoiceDetails/'+row["in"]+"/"+self.paymentType+"/"+row["cc"]+"/RECEIPT/"+row["ln"]+'"\x3e'+saleReceipt+"\x3c/a\x3e"}},{"mData":"","render":function(data,type,row){return""}}]};var datatable=table.initServerSideDataTable("#paymentHistoryDataTable",dataTableOptions,function(){self.setTotalInvoices();
self.compileDom("#paymentHistoryDataTable");if(refreshBidders)getBidderPaymentCounts()});datatable.on("stateSaveParams.dt",function(e,settings,data){data.noOfDays=self.noOfDays;data.noOfDays=self.noOfDays;data.selectedBidderNum=self.selectedBidderNum;data.bidder=self.filterForm.bidder;data.selectedCurrency=self.selectedCurrency;data.hideImagesFlag=self.hideImagesFlag;data.bidderList=self.bidderList});self.compileDom=function(table){var $dest=jQuery(table).find("tbody");var retn=$compile($dest)($scope);
self.$apply()};self.setRefreshBiddersFlag=function(flag){refreshBidders=flag};self.setTotalInvoices=function(){self.totalInvoices=0;var table=jQuery("#paymentHistoryDataTable").DataTable();self.totalInvoices=table.data().count()};self.hideImages=function(){var ttable=jQuery("#paymentHistoryDataTable").DataTable();var column=ttable.column(0);column.visible(!column.visible());var temptable=jQuery("#paymentHistoryDataTable").DataTable();if(!self.selectedBidderNum){temptable.ajax.url("/data/payments/history/0/"+
self.selectedCurrency+"/"+self.noOfDays).load();self.selectedBidderNum=0}else temptable.ajax.url("/data/payments/history/"+self.selectedBidderNum+"/"+self.selectedCurrency+"/"+self.noOfDays).load()};function storeNavigationInfo(){var info={backTo:"."+$location.url()};localStorageService.set("lot-navigation-info",info)}self.checkYardExist=function(yardNumber,lotNumber,viewAllPhotos){paymentService.checkYardBySiteCode(yardNumber).then(function(){storeNavigationInfo();var lotUrl="lot/"+lotNumber;if(viewAllPhotos)lotUrl+=
"/Photos";$location.url(lotUrl)},function(){paymentService.showYardNotExistModal()})};self.print=function(selector){jQuery(selector).css({display:"block",height:"auto",width:"auto",top:"0",left:"0",position:"absolute"}).print()}}]);"use strict";
function ServersideDatatable_DB(saveLotNumbersService,dataTableConfig){var self=this;self.selectedFilters=[];var MydataTableOptions;self.oPostData={};self.table=null;self.id="";self.staticFilteFormId="";self.detailsCookieName="toDetailServerSideCookie";self.cookieNameSuffix="cprt";self.log=new Logger({name:"ServerSide Datatable",level:"debug"});self.dataTableOptions;self.initServerSideDataTable=function(elementId,dataTableOptions,callback){self.id=elementId;dataTableOptions=dataTableOptions?dataTableOptions:
"{}";self.dataTableOptions=dataTableOptions;MydataTableOptions={"bProcessing":true,"responsive":{details:{type:"column",target:-1,renderer:function(api,rowIdx,columns){var data=$.map(columns,function(col,i){return col.hidden?'\x3cli data-dt-row\x3d"'+col.rowIndex+'" data-dt-column\x3d"'+col.columnIndex+'"\x3e'+'\x3cspan\x3e\x3cspan class\x3d"bold" data-uname\x3d"saleslistRegion"\x3e'+col.title+": "+'\x3c/span\x3e\x3cspan class\x3d"dtr-data"\x3e'+col.data+"\x3c/span\x3e\x3c/span\x3e"+"\x3c/li\x3e":
""}).join("");return data?$("\x3cul/\x3e").append(data):false}}},"autoWidth":dataTableOptions.recalculateTableWidth?false:true,"bSortClasses":!dataTableOptions.highlightColumn==false?false:true,"bServerSide":true,"jQueryUI":dataTableOptions.jQueryUI?dataTableOptions.jQueryUI:false,"columnDefs":dataTableOptions.columnDefs,"bFilter":dataTableOptions.bFilter==false?false:true,"bStateSave":true,"bPaginate":dataTableOptions.bPaginate==false?false:true,"stateLoadParams":function(oSettings,oData){if(dataTableOptions.stateSave){dataTableOptions.stateRetrieveFunction(oData);
return true}else return false},"iDisplayLength":dataTableOptions.pageLength?dataTableOptions.pageLength:"10","lengthMenu":dataTableOptions.lengthMenu?dataTableOptions.lengthMenu:[[10,25,50,100],[10,25,50,100]],"iDisplayStart":0,"deferLoading":dataTableOptions.deferLoading>=0?dataTableOptions.deferLoading:null,"order":dataTableOptions.order?dataTableOptions.order:[],"language":{"processing":"\x3cimg src\x3d'/images/icons/loader.gif'style\x3d'z-index:100000;'\x3e","emptyTable":dataTableOptions.noResultMessage?
dataTableOptions.noResultMessage:"No matching records found","infoEmpty":dataTableOptions.noResultInfoMessage?dataTableOptions.noResultInfoMessage:"Showing 0 to 0 of 0 entries","searchPlaceholder":"Search this list","zeroRecords":dataTableOptions.noResultMessage?dataTableOptions.noResultMessage:"No matching records found"},"ajax":{"url":dataTableOptions.url,"type":"POST","data":function(data){if(data.order[0]){data.sortOrder=data.order[0].dir;data.sortByColumnIndex=data.order[0].column}data.freshRequired=
self.oPostData["REFRESH"];data.filterCriteria=dataTableOptions.containsFilters==true?dataTableOptions.customFilterCriteria?dataTableOptions.customFilterCriteria:getFilterCriteria():"";data.readCriteriaFromSession=loadSaveState()==true?"Y":"N";data.searchText=data.search.value;if(typeof self.overrideDefaults=="function")self.overrideDefaults(data)},"error":function(jqXHR,status,errorThrown){if(jqXHR.responseText.indexOf("SessionExpiredLogin")>=0)jQuery("#sessionExpiredModal").modal({backdrop:"static",
keyboard:false});else{jQuery("#errorOccuredModal").modal({backdrop:"static",keyboard:false});self.log.error("Data table error:{} status:{}",errorThrown,status)}}},"fnInitComplete":function(oSettings,json){initSessionAndErrorDialogs();if(dataTableOptions.containsFilters)fetchFiltersData();if(dataTableOptions.containsStaticFilter)getStaticFiltersFromCookie();$(".dataTables_filter input").bind("input",function(e){this.value=this.value.replace(/[^a-z0-9\s]/gi,"")})},"fnDrawCallback":function(o){if(callback)callback();
var backToTop=dataTableOptions.backToTop==false?dataTableOptions.backToTop:true;if(backToTop){var oldStart=1;if(o._iDisplayStart!=oldStart){var targetOffset=jQuery(self.id).offset().top-300;jQuery("html,body").animate({scrollTop:targetOffset},500);oldStart=o._iDisplayStart}}},"aoColumns":dataTableOptions.columns,"fnRowCallback":dataTableOptions.fnRowCallback?dataTableOptions.fnRowCallback:null};if(dataTableConfig){var config=dataTableConfig.getConfig();if(config.dom)MydataTableOptions.dom=config.dom;
if(config.pagingType)MydataTableOptions.pagingType=config.pagingType}self.table=jQuery(self.id).on("xhr.dt",function(e,settings,json,xhr){if(json!=null&&!_.isEmpty(saveLotNumbersService))saveLotNumbersService.clearAll()}).dataTable(MydataTableOptions);return self.table};function fetchFiltersData(){var url=self.oPostData["FILTERS_URL"];jQuery.ajax({url:url,data:{},type:"GET",cache:false,dataType:"html",success:function(result,status,xhr){jQuery("#filtersPlaceHolder").html(result);setUpFiltersData();
jQuery("#filtersDiv").removeAttr("disabled");jQuery(".filterLoaders").remove()},error:function(xhtml,status,errorThrown){self.log.error("fetchFiltersData error:{} status:{}",errorThrown,status)}})}function setUpFiltersData(){setUpFilterDialog();initApplyFilterButton();closeFilterDialog();getFiltersFromCookie()}self.initGotoPageButton=function(){initGotoPageClick();jQuery("#btnGotoPageServerSide").click(function(){var strGotoPage=trimWS(jQuery("#gotopage").val());var varInvalidPageNumber="Page number entered is invalid.";
var integerFilter=/[^0-9]/;if(integerFilter.test(strGotoPage)||strGotoPage.length==0)showUserAlertMsg(varInvalidPageNumber);else{var oTable=jQuery("#paymentHistoryDataTable").DataTable();var oTableInfo=oTable.page.info();var intNumberOfPages=oTableInfo.pages;var intGotoPage=parseInt(strGotoPage);if(intGotoPage>0&&intGotoPage<=intNumberOfPages){var oTablePages=jQuery("#paymentHistoryDataTable").dataTable();oTablePages.fnPageChange(intGotoPage-1);jQuery("#gotopage").val("")}else{showUserAlertMsg(varInvalidPageNumber);
jQuery("#gotopage").focus()}}})};function initApplyFilterButton(){jQuery("#applyServerSideFilterButton").click(function(){filterResult();jQuery("#filterDialog").dialog("close")})}function closeFilterDialog(){jQuery("#filterModalCloseLnkServerSide").click(function(){var columnName=jQuery("#fltrColName").val();jQuery("input[type\x3d'checkbox'][name\x3d'"+columnName+"']").prop("checked",false);jQuery("input[type\x3d'radio'][name\x3d'"+columnName+"']").prop("checked",false);for(i=0;i<selectedFilters.length;i++)if(selectedFilters[i]){jQuery("input[type\x3d'checkbox'][id\x3d'"+
jQuery.trim(selectedFilters[i])+"']").prop("checked",true);jQuery("input[type\x3d'radio'][id\x3d'"+jQuery.trim(selectedFilters[i])+"']").prop("checked",true)}jQuery("#filterDialog").dialog("close")})}function initSessionAndErrorDialogs(){jQuery("body").on("click","#reloadPageButton",function(){location.reload()});jQuery("body").on("click","#errorOccuredModal",function(){jQuery("#errorOccuredModal").modal("hide")})}function getFilterCriteria(){var filterJSONString={filters:[]};var filterSelected=false;
selectedFilters.splice(0,selectedFilters.length);for(i=0;i<filtersName.length;i++){var filterName=filtersName[i].split("|");if(filterName[0]){var data=jQuery("input[type\x3dcheckbox][name\x3d'"+filterName[0]+"']:checked").map(function(){selectedFilters.push(this.value);return this.value}).get();if(data&&data.length>0){var jsonData={};jsonData.filterBy=filterName[0];jsonData.filterValue=data;filterJSONString.filters.push(jsonData);filterSelected=true;self.displayBreadCrumbs(filterName[0],function(){reloadTable()})}else jQuery("#"+
filterName[0]+"BreadCrumb").empty()}}if(selectedFilters.length==0)jQuery(".filter-wrap").hide();self.oPostData["FILTER_CRITERIA"]=JSON.stringify(filterJSONString);return self.oPostData["FILTER_CRITERIA"]}self.sort=function(column,sortOrder){self.table.fnSort([[column,sortOrder]])};self.reload=function(){filterResult()};self.reloadFiltersAndTable=function(){var temptable=jQuery(self.id).DataTable();temptable.ajax.reload(fetchFiltersData)};function filterResult(){var temptable=jQuery(self.id).DataTable();
temptable.ajax.reload()}self.saveFilterSelection=function(){if(saveFilterState){if(self.dataTableOptions.containsFilters)for(i=0;i<filtersName.length;i++){var filterName=filtersName[i].split("|");if(filterName[0]){var data=jQuery("input[type\x3dcheckbox][name\x3d'"+filterName[0]+"']:checked").map(function(){return this.value}).get().join("|");if(data)setCookie(filterName[0]+self.cookieNameSuffix,data)}}if(self.dataTableOptions.containsStaticFilter){var formData=jQuery("#"+self.staticFilteFormId).serialize();
setCookie(self.staticFilteFormId+self.cookieNameSuffix,formData)}setCookie(self.detailsCookieName+self.cookieNameSuffix,"true")}};function loadSaveState(){if("undefined"==typeof readDataFromCookie||!readDataFromCookie)return false;var toDetail=getCookie(self.detailsCookieName+self.cookieNameSuffix);if(toDetail)return true;else return false}function getStaticFiltersFromCookie(){var formData=getCookie(self.staticFilteFormId+self.cookieNameSuffix);jQuery("#"+self.staticFilteFormId).deserialize(formData);
deleteCookie(self.detailsCookieName+self.cookieNameSuffix,null);deleteCookie(self.staticFilteFormId+self.cookieNameSuffix,null)}function getFiltersFromCookie(){if(typeof readDataFromCookie!="undefined"&&readDataFromCookie){for(var counter=0;counter<filtersName.length;counter++){var columnName=filtersName[counter].split("|");if(columnName){var data=getCookie(columnName[0]+self.cookieNameSuffix);if(data){var ids=data.split("|");if(ids.length>0){for(i=0;i<ids.length;i++){jQuery('input:checkbox[name\x3d"'+
columnName[0]+'"][value\x3d"'+ids[i]+'"]').attr("checked","checked");self.displayBreadCrumbs(columnName[0],function(){reloadTable()})}jQuery("#fltrColName").val(columnName[0]);jQuery("#fltrColIndex").val(columnName[1]);deleteCookie(columnName[0]+self.cookieNameSuffix,null)}}}}deleteCookie(self.detailsCookieName+self.cookieNameSuffix,null)}else for(var counter=0;counter<filtersName.length;counter++){var columnName=filtersName[counter].split("|");if(columnName)deleteCookie(columnName[0]+self.cookieNameSuffix,
null);deleteCookie(self.detailsCookieName+self.cookieNameSuffix,null)}}self.displayBreadCrumbs=function(columnName,callback){jQuery("#"+columnName+"BreadCrumb").empty();jQuery("input[name\x3d'"+columnName+"']:checked").each(function(){jQuery(".filter-wrap").show();jQuery("#"+columnName+"BreadCrumb").append("\x3ca class\x3d'remove-filter'  onclick\x3d'return removeFilters(\""+this.id+'",'+jQuery("#"+this.name+"ColumnValue").val()+","+callback+",this)' href\x3d'#'\x3e"+jQuery(this).next().text()+"\x3cspan class\x3d'delete-filter'\x3e\x3c/span\x3e\x3c/a\x3e")})};
self.setRefresh=function(refresh){self.oPostData["REFRESH"]=refresh};self.setStaticFilteFormId=function(id){self.staticFilteFormId=id};self.setFilterURL=function(url){self.oPostData["FILTERS_URL"]=url}}var clearanceSelectedFilters;
function removeFilters(filterBy,columnIndex,callbackFunction,element){filterBy=document.getElementById(filterBy);var filterName="";if(filterBy!=undefined&&filterBy!=null){var columnFilterIndex=filterBy.value.split("_");filterName=filterBy.name;if(columnIndex=="-1")columnIndex=columnFilterIndex[1];clearanceSelectedFilters=jQuery.grep(clearanceSelectedFilters,function(value){return value!=filterBy.value})}jQuery(".filter-wrap").hide();jQuery("#filterRemovedText").hide();jQuery("input[name\x3d'"+filterBy.name+
"']:checked").each(function(){if(jQuery(this).next().text()==jQuery(element).text())jQuery(this).prop("checked",false)});selectedFilters=jQuery.grep(selectedFilters,function(value){return value!=filterBy.value});jQuery("input[type\x3dcheckbox]:checked").map(function(){showBreadCrumbs(this,columnIndex)});jQuery("input[type\x3dradio]:checked").map(function(){showBreadCrumbs(this,columnIndex)});if(callbackFunction){showBreadCrumbs(filterBy,columnIndex);callbackFunction()}else filterData(filterBy,columnIndex);
return false}
app.controller("savedSearchesController",["$scope","$http","$location","dataServiceG2","copartUser","saveSearchCriteria",function($scope,$http,$location,dataServiceG2,copartUser,saveSearchCriteria){var self=$scope;self.listOfSearches=null;self.saveSearchCriteria=saveSearchCriteria.data;var userRoles=copartUser.config.roles;if(!_.contains(userRoles,"ROLE_ANONYMOUS"))dataServiceG2.searchSavedSearches(function(result){self.listOfSearches=result.data;self.listOfSearches.sort(function(a,b){if(a.searchName.toLowerCase()<b.searchName.toLowerCase())return-1;
else if(a.searchName.toLowerCase()>b.searchName.toLowerCase())return 1;else return 0})});self.onDelete=function(id,index){dataServiceG2.deleteSavedSearch(id,function(){self.listOfSearches.splice(index,1)})},self.onSearch=function(criteria){angular.extend(saveSearchCriteria.data,JSON.parse(criteria));$location.url("/lotSearchResults?fromSavedSearch\x3dtrue\x26from\x3d/savedsearch")},self.onStartNewSearch=function(id){self.searchText="";$location.url("/vehicleFinder")};self.onRegister=function(id){$location.url("/doRegistration")};
self.emailSavedSearch=function(search){search.emailFlag=search.emailFlag=="Y"?"N":"Y";dataServiceG2.emailSavedSearch(search,function(response){if(response.data.returnCode==-1){search.emailFlag=search.emailFlag=="Y"?"N":"Y";$("#emailSavedSearchModal").modal()}})}}]);app.factory("saveSearchCriteria",function(){return{data:{}}});
app.controller("auctionDashboardController",["$scope","$http","$locale","$sce","$routeParams","copartUser","userService","$compile","$location",function($scope,$http,$locale,$sce,$routeParams,copartUser,userService,$compile,$location){var self=$scope;$scope.message="Look! I am an auctionDashboardController page.";self.siteCode=copartUser.getUserConfig().siteCode;self.auctionDetails=$location.search().auctionDetails;document.domain=copartUser.getUserConfig().siteDomain;$http({url:"/public/data/auctionDashboard",
method:"GET"}).success(function(response,status,headers,config){if(response.returnCode==1){document.domain=copartUser.getUserConfig().siteDomain;if(response.data.auctionDashboardURL.indexOf("?")>-1)self.auctionDashboardURL=response.data.auctionDashboardURL+"\x26siteLanguage\x3d"+userService.userConfig.selectedLang+"\x26appId\x3dg2";else self.auctionDashboardURL=response.data.auctionDashboardURL+"?siteLanguage\x3d"+userService.userConfig.selectedLang+"\x26appId\x3dg2";if(self.siteCode=="CRTSUS")self.auctionDashboardURL=
self.auctionDashboardURL+"\x26site\x3dct";if(!_.isUndefined(self.auctionDetails))self.auctionDashboardURL=self.auctionDashboardURL+"#"+self.auctionDetails;self.auctionDashboardURL=$sce.trustAsResourceUrl(self.auctionDashboardURL);self.auctionURL=self.siteCode?self.auctionDashboardURL+"\x26"+self.siteCode:self.auctionDashboardURL}else;}).error(function(response,status,headers,config){log.error("Error returned"+response)})}]);
app.controller("watchListPortletController",["$scope","$http","dataServiceG2","copartUser",function($scope,$http,dataServiceG2,copartUser){console.log("Inside WatchList Portlet Controller..");var self=$scope;self.watchList=[];self.wlWaiting=true;self.formattedDate=function(date){var saleDate=moment(date,"YYYYMMDD");return saleDate.format(copartUser.getUserConfig().dateFormat.toUpperCase())};$http.get("/data/lots/compactWatchList/").success(function(data){self.watchList=data.data.compactWatchList;
self.wlWaiting=false})}]);app.controller("openItemsPortletController",["$scope","$http","dataServiceG2",function($scope,$http,dataServiceG2){console.log("Inside open items Portlet Controller..");var self=$scope;self.openItemsList=[];self.oiWaiting=true;$http.get("/data/compactOpenItems/").success(function(data){self.openItemsList=data.data.compactOpenItems;self.oiWaiting=false;if(self.openItemsList);})}]);
app.controller("currentBidsPortletController",["$scope","$http","dataServiceG2",function($scope,$http,dataServiceG2){console.log("Inside current Bids Portlet Controller..");var self=$scope;self.currentBidsList=[];self.cbWaiting=true;$http.get("/data/compactCurrentBids/").success(function(data){self.currentBidsList=data.data.compactCurrentBids;self.cbWaiting=false})}]);
app.controller("savedSearchesPortletController",["$scope","$http","dataServiceG2",function($scope,$http,dataServiceG2){var self=$scope;self.savedSearchesList=[];self.ssWaiting=true;$http.get("/data/compactSavedSearches/").success(function(data){self.savedSearchesList=data.data.compactSavedSearches;self.ssWaiting=false})}]);
app.controller("paymentsDuePortletController",["$scope","$http","dataServiceG2",function($scope,$http,dataServiceG2){console.log("Inside payments Due Portlet Controller..");var self=$scope;self.paymentsDueList=[];self.pdWaiting=true;$http.get("/data/compactPaymentsDue/").success(function(data){self.paymentsDueList=data.data.compactPaymentsDue;self.pdWaiting=false})}]);
app.controller("buyingPowerController",["$scope","$http","dataServiceG2",function($scope,$http,dataServiceG2){console.log("Inside buying power Portlet Controller..");var self=$scope;self.openItemsList=[];self.oiWaiting=true;self.showBuyingPower=true;self.buyingPowerScale=[];if(_.contains(self.userConfig.roles,"ROLE_BASIC")){self.buyPowerLimit=1E3;self.buyPowerScaleLimit=5E3;self.buyPowerUsed=0;self.buyPowerAvail=Math.round(self.buyPowerLimit-self.buyPowerUsed);self.bpIndicator=Math.round(self.buyPowerLimit);
console.log("DEBUG: buying power limit %-"+self.bpIndicator);self.usedBPIndicator=0;if(self.buyPowerLimit){var n=self.buyPowerScaleLimit/10;for(var i=0;i<10;i++){var tuple=n*i;self.buyingPowerScale.push(tuple)}}console.log("DEBUG: buying power limit %-"+self.usedBPIndicator);var buyPowerPromise=$http.get("/data/buyer/buyingPower")}else self.showBuyingPower=false;if(buyPowerPromise!=undefined)buyPowerPromise.then(function(payload){if(payload.data.buyingPower){self.buyPowerLimit=payload.data.buyingPower.bidLimitAmount;
self.buyPowerUsed=payload.data.buyingPower.bidLimitAMount_Curr;if(self.buyPowerLimit){self.buyingPowerScale=[];var n=self.buyPowerLimit/10;if(self.buyPowerLimit<5E3)self.buyPowerScaleLimit=5E3;else if(self.buyPowerLimit<=1E4)self.buyPowerScaleLimit=2E4;else if(self.buyPowerLimit<=25E3)self.buyPowerScaleLimit=5E4;else if(self.buyPowerLimit<=5E4)self.buyPowerScaleLimit=75E3;else self.buyPowerScaleLimit=5E5;if(self.buyPowerLimit){var n=self.buyPowerScaleLimit/10;for(var i=1;i<11;i++){var ntuple=n*i;
var scale;if(ntuple%1E3==0)scale=ntuple/1E3+"K";else scale=(ntuple/1E3).toFixed(1)+"K";self.buyingPowerScale.push(scale)}}}self.bpIndicator=Math.round(self.buyPowerLimit/self.buyPowerScaleLimit*100);self.usedBPIndicator=Math.round(self.buyPowerUsed/self.buyPowerLimit*100);self.buyPowerAvail=Math.round(self.buyPowerLimit-self.buyPowerUsed)}console.log("buying power promise fulfilled,Size:")})}]);
app.controller("termsAndConditionsController",["$scope","$http","dataServiceG2","copartUser","$location","userService",function($scope,$http,dataServiceG2,copartUser,$location,userService){var self=$scope;self.userService=userService;self.acceptTermsAndConditions=function(){dataServiceG2.acceptTermsAndConditions(function(response){$location.path("/dashboard");var responseCode=response.data.errorMsg;var responseCodeDesc=response.returnCodeDesc;if(responseCode!=null&&responseCode.trim()!=""&&responseCodeDesc!=
null&&responseCodeDesc.trim()!="Success");})}}]);
app.controller("bidStatusLotsWonController",["$scope","$compile","dataServiceG2","$location","backToLinkService","saveLotNumbersService","appConfigService","localStorageService","History","copartUser","dataTableConfig","$filter",function($scope,$compile,dataServiceG2,$location,backToLinkService,saveLotNumbersService,appConfigService,localStorageService,History,copartUser,dataTableConfig,$filter){var self=$scope;self.locale=$scope.$parent.locale;var table=new ServersideDatatable_DB(saveLotNumbersService,
dataTableConfig);self.bidderList=null;self.selectedBidder=null;self.yardDetails={};self.images={};self.dateFormat=copartUser.getUserConfig().dateFormat.toUpperCase();self.timeRangeSelcted=null;var url="/data/bidStatus/lotsWon";self.backToLink=$location.url();backToLinkService.setBackToLink(self.backToLink);self.estimates={};if(copartUser.getUserConfig().displayPref.lotsWonPreference){self.showZipcodeColumn=copartUser.getUserConfig().displayPref.lotsWonPreference.showZipCodeColumn;self.showBidderColumn=
copartUser.getUserConfig().displayPref.lotsWonPreference.showBidderColumn;self.showLotLeftYardDateColumn=copartUser.getUserConfig().displayPref.lotsWonPreference.showLotLeftYardDateColumn}else{self.showLotLeftYardDateColumn=false;self.showZipcodeColumn=true;self.showBidderColumn=true}function checkIfFromDetails(){try{var lastRoute=History.lastRoute;if(lastRoute&&(lastRoute.indexOf("lot/")==0||lastRoute.indexOf("paymentsDue/")==0))return true;else return false}catch(e){return false}}self.storeNavigationInfo=
function(resultIndex){var info={backTo:"."+$location.url(),resultIndex:resultIndex};localStorageService.set("lot-navigation-info",info)};var state=false;var stateRestoreFromAnywhere=localStorageService.get("restore-search-state-from-anywhere");localStorageService.remove("restore-search-state-from-anywhere");if(checkIfFromDetails()||$location.search().state=="restore"||stateRestoreFromAnywhere)state=localStorageService.get("restore-search-state");self.loadDataTable=function(){saveLotNumbersService.clearAll();
var dataTableOptions={"pageLength":20,"columnDefs":[{"targets":[0,1,2,3,4,5,6,7,8,9,10,11,12,13],"data":null,"defaultContent":""},{"targets":[0,12,13],"orderable":false},{"targets":["lotswonzip"],"visible":self.showZipcodeColumn,"searchable":self.showZipcodeColumn},{"targets":["leftLocationDate"],"visible":self.showLotLeftYardDateColumn,"searchable":self.showLotLeftYardDateColumn},{"targets":["bidderId"],"visible":self.showBidderColumn,"searchable":self.showBidderColumn},{className:"control",orderable:false,
targets:-1}],"order":[[8,"desc"]],"lengthMenu":[[20,25,50,100],[20,25,50,100]],"url":url,"containsFilters":false,"fnRowCallback":function(nRow,aData,iDisplayIndex){jQuery(".nowrap",nRow).attr("nowrap","nowrap");return nRow},"stateSave":state,"stateRetrieveFunction":function(data){self.selectedBidder=data.selectedBidder;self.bidderList=data.bidderList;self.showTimeRanges=data.showTimeRanges;self.timeRangeSelcted=data.timeRangeSelcted;self.filterTable(self.selectedBidder)},"columns":[{"mData":"imgp",
"render":function(data,type,row,meta){if(!row.imageUrl||!row.imageUrl.trim())return"\x3cimg alt\x3d'image' height\x3d'72' width\x3d'96' class\x3d'' src\x3d'/images/testImages/no_photo.jpg'\x3e";var description=row["lotYear"]+" "+row["lotMake"]+" "+row["lotModel"];var backTo=self.backToLink;var resultIndex=meta.settings._iDisplayStart+meta.row;var totalRecords=meta.settings._iRecordsTotal;var imageDiv="\x3ca class\x3d'imgpath cursor-pointer' lot-id\x3d'"+row["lotNumber"]+"' lot-desc\x3d'"+description+
"' images\x3d'images' hide-watch-btn\x3dtrue modal-image-viewer "+" back-to\x3d"+backTo+" result-index\x3d"+resultIndex+" total-records\x3d"+totalRecords+"  flag\x3d1 auction-date\x3d'"+row["saleDate"].date+"'  \x3e"+"\x3cspan class\x3d'searchiconbtn searchiconbtnie'\x3e\x3c/span\x3e\x3cimg alt\x3d'image' height\x3d'72' width\x3d'96' class\x3d'' src\x3d'"+row["imageUrl"]+"'error-image\x3d'/images/testImages/no_photo.jpg'\x3e\x3cbr\x3e"+"\x3c/a\x3e";var viewAllPhotos="\x3cdiv class\x3d'viewallphotos'\x3e\x3ca href\x3d'./lotDetail/"+
row["lotNumber"]+"/Photos?backTo\x3d/lotsWon' class\x3d'image_viewer_link'  data-lotDesc\x3d'"+row["lotNumber"]+"' data-lot\x3d'"+row["lotNumber"]+"'\x3e"+self.locale.messages["counterman.searchResults.viewAllPhotos.label"]+"\x3c/a\x3e\x3c/div\x3e";var siteCatalystVal=""+"site-catalyst\x3d{'fname':'doTagDownloadAllImages','lotId':'"+row["lotNumber"].toString()+"'}";var downloadAllPhotosDiv="\x3cdiv class\x3d'viewallphotos'\x3e\x3ca ng-href\x3d'./public/data/lotImages/download/"+row["lotNumber"]+"' target\x3d'_self'"+
siteCatalystVal+"\x3e"+"\x3cspan\x3e"+self.locale.messages["lotswon.searchResults.downloadAllPhotos.label"]+"\x3c/span\x3e\x3c/a\x3e\x3c/div\x3e";imageDiv=imageDiv+viewAllPhotos;return imageDiv}},{"mData":"lotNumber","render":function(data,type,row,meta){row["backTo"]=self.backToLink;var resultIndex=meta.settings._iDisplayStart+meta.row;var totalRecords=meta.settings._iRecordsTotal;saveLotNumbersService.addLotNumber(row["lotNumber"]);var siteCatalystVal=""+"site-catalyst\x3d{'fname':'doTagDownloadAllImages','lotId':'"+
row["lotNumber"].toString()+"'}";var downloadAllPhotosDiv="\x3cdiv class\x3d'viewallphotos'\x3e\x3ca ng-href\x3d'/public/data/lotImages/download/"+row["lotNumber"]+"' target\x3d'_self'"+siteCatalystVal+"\x3e"+"\x3cspan\x3e"+self.locale.messages["lotswon.searchResults.downloadAllPhotos.label"]+"\x3c/span\x3e\x3c/a\x3e\x3c/div\x3e";var html="\x3ca href\x3d'/lotDetail/"+row["lotNumber"]+"?resultIndex\x3d"+resultIndex+"\x26totalRecords\x3d"+totalRecords+"\x26backTo\x3d"+self.backToLink+"\x26flag\x3d1'\x3e"+
row["lotNumber"]+"\x3c/a\x3e";if(row.imageUrl&&row.imageUrl.trim())html=html+downloadAllPhotosDiv;return html}},{"mData":"lotYear","render":function(data,type,row){self.lotyear=row["lotYear"];if(row["lotIcons"]){var iconCodes=_.intersection(row["lotIcons"],self.validIconCodes);var template="\x3cspan data-uname\x3d'lotsearchLotcenturyyear'\x3e"+row["lotYear"]+"\x3c/span\x3e\x3cbr\x3e";return self.generateIconTemplate(template,iconCodes)}return row["lotYear"]}},{"mData":"lotMake"},{"mData":"lotModel"},
{"mData":"location","render":function(data,type,row){var html="\x3ca class\x3d'cursor-pointer' href\x3d'/locationDetail/"+row["yardNumber"]+"' target\x3d'_blank'\x3e"+"\x3cspan\x3e"+row["yardName"]+"\x3c/span\x3e\x3c/a\x3e";return html}},{"mData":"vin","render":function(data,type,row){var vin=row["vin"];if(copartUser.getUserConfig().companyCode=="COPARTUK")vin=$filter("limitTo")(row["vin"],11,0);return vin}},{"mData":"bidderNumber"},{"mData":"saleDateStr","render":function(data,type,row){var saleDateFormatted=
row["saleDateStr"];if(saleDateFormatted&&saleDateFormatted.dateAsInt!=0)return moment(saleDateFormatted).format(self.dateFormat)}},{"mData":"lotLeftYardDate","render":function(data,type,row){var lotLeftYardDate=row["lotLeftYardDate"];if(lotLeftYardDate&&lotLeftYardDate.dateAsInt!=0){var leftFacilityDate=moment(lotLeftYardDate.dateAsInt,"YYYYMMDD");return leftFacilityDate.format(self.dateFormat)}else return""}},{"mData":"docType"},{"mData":"damageType","render":function(data,type,row){return row["damageType"].toTitleCase()}},
{"mData":"totalAmt","render":function(data,type,row){var html=$filter("globalize_currency_using_code")(row["totalAmt"],row["currency"].code,2)+"\x3cbr/\x3e";if(row["paymentStatus"]!="Paid")html+="\x3ca href\x3d'./paymentsDue' class\x3d'btn btn-primary'\x3e Pay Now\x3c/a\x3e";else html+="\x3cspan\x3e"+row["paymentStatus"]+"\x3c/span\x3e";return html}},{"mData":"dp","render":function(data,type,row){if(row["ln"]==row["id"])return"\x3cspan  request-Type\x3d'QUOTE' lot-id\x3d'"+row["lotNumber"]+"'  estimates\x3d'estimates' transportaion-estimates\x3e";
else return""}},{"mData":"","render":function(data,type,row){return""}}]};var datatable=table.initServerSideDataTable("#serverSideDataTable",dataTableOptions,function(){self.compileDom("#serverSideDataTable")});datatable.on("stateSaveParams.dt",function(e,settings,data){data.selectedBidder=self.selectedBidder;data.bidderList=self.bidderList;data.showTimeRanges=self.showTimeRanges;data.timeRangeSelcted=self.timeRangeSelcted});dataServiceG2.getBidderStatusList(function(responseData){console.log(responseData);
if(responseData.returnCode==-1)log.error("Error");else self.bidderList=responseData.data})};self.compileDom=function(table){var $dest=jQuery(table).find("tbody");var retn=$compile($dest)($scope);self.$apply()};self.filterTable=function(bidder){self.selectedBidder=bidder;console.log("calling filtering"+bidder);self.reloadTable()};self.reloadTable=function(){var temptable=jQuery("#serverSideDataTable").DataTable();temptable.ajax.url("/data/bidStatus/lotsWon").load()};self.stateFilter=function(item){return item.type===
"USA"||item.type==="CAN"};table.overrideDefaults=function(data){if(!self.timeRangeSelcted)self.timeRangeSelcted=self.showTimeRanges[0];data.fromDate=self.timeRangeSelcted.fromDate;data.toDate=self.timeRangeSelcted.toDate;var filterJSONString={filters:[]};var bidderFilter={};if(self.selectedBidder){bidderFilter.filterBy="bidderNumber";bidderFilter.filterValue=[self.selectedBidder];filterJSONString.filters.push(bidderFilter)}data.filterCriteria=JSON.stringify(filterJSONString)};var highlightIcons=_.where(appConfigService.appConfig.highlightIcons,
{iconType:"H"});self.validIconCodes=_.pluck(highlightIcons,"iconCode");self.generateIconTemplate=function(template,iconCodes){template=template+'\x3cspan copart-vehicle-iconss class\x3d" highlighticon"\x3e ';for(var i=0;i<iconCodes.length;i++){var code=iconCodes[i];template+='\x3ca lot-highlights-tool-tip fragment-id\x3d"'+code+'" class\x3d"icon-tooltip" data-placement\x3d"auto right" data-toggle\x3d"popover" data-container\x3d".lots-won"\x3e'+'\x3cspan class\x3d"vehicleicon"\x3e\x3cimg src\x3d"../images/global/highlightIcons-'+
appInit.regionCode+'.png" class\x3d"lotIcon-'+code+' bid-icon-img"\x3e\x3c/span\x3e\x3c/a\x3e'}template=template+"\x3c/span\x3e";return template};self.csvUrl="/bidStatusLotsWon/exportCsv";var selectedTimezone=self.userConfig.selectedTimezone;var date=moment().tz(selectedTimezone).format("YYYY MMMM DD");self.exportFileName="LotsWon_"+date+".csv";self.download=function(){dataServiceG2.downloadCSV(csvUrl,null)}}]);
app.controller("bidStatusLotsLostController",["$scope","$compile","dataServiceG2","$location","backToLinkService","searchCriteria","saveLotNumbersService","appConfigService","localStorageService","History","dataTableConfig","$filter","copartUser",function($scope,$compile,dataServiceG2,$location,backToLinkService,searchCriteria,saveLotNumbersService,appConfigService,localStorageService,History,dataTableConfig,$filter,copartUser){var self=$scope;var table=new ServersideDatatable_DB(saveLotNumbersService,
dataTableConfig);self.searchCriteria=searchCriteria;self.bidderList=null;self.selectedBidder=null;self.yardDetails={};self.images={};self.dateFormat=copartUser.getUserConfig().displayPref.dateFormat.toUpperCase();self.timeRangeSelcted=null;var url="/data/bidStatus/lotsLost";self.backToLink=$location.url();var rowDataStore={};backToLinkService.setBackToLink(self.backToLink);var selectedTimezone=copartUser.getUserConfig().selectedTimezone;self.date=moment().tz(selectedTimezone).format("YYYY MMMM DD");
self.csvUrl="/lotsLost/CSVView";self.exportFileName="LotsLost_"+self.date+".csv";if(copartUser.getUserConfig().displayPref.lotsLostPreference)self.showOdometerColumn=copartUser.getUserConfig().displayPref.lotsLostPreference.showOdometerColumn;else self.showOdometerColumn=true;function checkIfFromDetails(){try{var lastRoute=History.lastRoute;if(lastRoute&&lastRoute.indexOf("lot/")==0)return true;else return false}catch(e){return false}}var state=false;var stateRestoreFromAnywhere=localStorageService.get("restore-search-state-from-anywhere");
localStorageService.remove("restore-search-state-from-anywhere");if(checkIfFromDetails()||$location.search().state=="restore"||stateRestoreFromAnywhere)state=localStorageService.get("restore-search-state");self.storeNavigationInfo=function(resultIndex){var info={backTo:"."+$location.url(),resultIndex:resultIndex};localStorageService.set("lot-navigation-info",info)};self.loadDataTable=function(){saveLotNumbersService.clearAll();var dataTableOptions={"pageLength":20,"columnDefs":[{"targets":[0,1,2,
3,4,5,6,7,8,9,10,11],"data":null,"defaultContent":""},{"targets":[0,11],"orderable":false},{"targets":["odometer"],"visible":self.showOdometerColumn,"searchable":self.showOdometerColumn},{className:"control",orderable:false,targets:-1}],"lengthMenu":[[20,25,50,100],[20,25,50,100]],"url":url,"containsFilters":false,"fnRowCallback":function(nRow,aData,iDisplayIndex){jQuery(".nowrap",nRow).attr("nowrap","nowrap");return nRow},"stateSave":state,"stateRetrieveFunction":function(data){self.selectedBidder=
data.selectedBidder;self.bidderList=data.bidderList;self.showTimeRanges=data.showTimeRanges;self.timeRangeSelcted=data.timeRangeSelcted;self.filterTable(self.selectedBidder)},"columns":[{"mData":"imgp","render":function(data,type,row,meta){var description=row["lotYear"]+" "+row["lotMake"]+" "+row["lotModel"];var backTo=self.backToLink;var resultIndex=saveLotNumbersService.getResultIndex(row.lotNumber);var totalRecords=saveLotNumbersService.getListLength();return"\x3ca class\x3d'imgpath cursor-pointer' lot-id\x3d'"+
row["lotNumber"]+"' lot-desc\x3d'"+description+"' images\x3d'images' current-bid\x3d'"+row["myBid"]+"' hide-watch-btn\x3dtrue modal-image-viewer "+" back-to\x3d"+backTo+" result-index\x3d"+resultIndex+" total-records\x3d"+totalRecords+" flag\x3d1 auction-date\x3d'"+row["saleDate"].date+"'  \x3e"+"\x3cspan class\x3d'searchiconbtn searchiconbtnie'\x3e\x3c/span\x3e\x3cimg alt\x3d'image' height\x3d'72' width\x3d'96' class\x3d'' src\x3d'"+row["imageUrl"]+"'\x3e\x3cbr\x3e"+"\x3c/a\x3e"+"\x3cdiv class\x3d'viewallphotos'\x3e\x3ca href\x3d'./lot/"+
row["lotNumber"]+"/Photos' ng-click\x3d'storeNavigationInfo("+resultIndex+")' class\x3d'image_viewer_link'  data-lotDesc\x3d'"+row["lotNumber"]+"' data-lot\x3d'"+row["lotNumber"]+"'\x3e"+self.locale.messages["counterman.searchResults.viewAllPhotos.label"]+"\x3c/a\x3e\x3c/div\x3e"}},{"mData":"lotNumber","render":function(data,type,row,meta){var resultIndex=saveLotNumbersService.getResultIndex(row.lotNumber);rowDataStore[row["lotNumber"]]=row;saveLotNumbersService.addLotNumber(row["lotNumber"]);return"\x3ca href\x3d'./lot/"+
row["lotNumber"]+"' ng-click\x3d'storeNavigationInfo("+resultIndex+")'\x3e"+row["lotNumber"]}},{"mData":"lotyear","render":function(data,type,row){if(row["lotIcons"]){var iconCodes=_.intersection(row["lotIcons"],self.validIconCodes);var template="\x3cspan data-uname\x3d'lotsearchLotcenturyyear'\x3e"+row["lotYear"]+"\x3c/span\x3e\x3cbr\x3e";return self.generateIconTemplate(template,iconCodes)}return row["lotYear"]}},{"mData":"lotMake","render":function(data,type,row){return row["lotMake"]}},{"mData":"lotModel",
"render":function(data,type,row){return row["lotModel"]}},{"mData":"yardName","render":function(data,type,row){var html="\x3ca class\x3d'cursor-pointer' href\x3d'./locationDetail/"+row["yardNumber"]+"' target\x3d'_blank'\x3e"+"\x3cspan\x3e"+row["yardName"]+"\x3c/span\x3e\x3c/a\x3e \x3cbr/\x3e";return html}},{"mData":"saleDateStr","render":function(data,type,row){var saleDateFormatted=row["saleDateStr"];return moment(saleDateFormatted).format(self.dateFormat)}},{"mData":"odometerReading"},{"mData":"docType"},
{"mData":"damageType","render":function(data,type,row){return row["damageType"].toTitleCase()}},{"mData":"actualCostOfVehicle","render":function(data,type,row){return $filter("globalize_currency_using_code")(row["actualCostOfVehicle"],row["currency"]["code"],2)}},{"mData":"myBid","render":function(data,type,row){var html="\x3cspan class\x3d'btn btn-danger'\x3e"+row["bidStatus"]+"\x3c/span\x3e\x3cbr/\x3e\x3cspan\x3eMy Last Bid:\x3c/span\x3e"+$filter("globalize_currency_using_code")(row["myBid"],row["currency"]["code"],
2)+"\x3cbr/\x3e"+"\x3ca ng-click\x3d'search("+row["lotNumber"]+")'\x3eFind Similar Vehicles\x3c/a\x3e";return html}},{"mData":"","render":function(data,type,row){return""}}]};var datatable=table.initServerSideDataTable("#serverSideDataTable",dataTableOptions,function(){self.compileDom("#serverSideDataTable")});datatable.on("stateSaveParams.dt",function(e,settings,data){data.selectedBidder=self.selectedBidder;data.bidderList=self.bidderList;data.showTimeRanges=self.showTimeRanges;data.timeRangeSelcted=
self.timeRangeSelcted});datatable.on("responsive-display.dt",function(e,datatable,row){$compile(row.child())(self)});dataServiceG2.getBidderStatusList(function(responseData){console.log(responseData);if(responseData.returnCode==-1)log.error("Error");else self.bidderList=responseData.data})};self.compileDom=function(table){var $dest=jQuery(table).find("tbody");var retn=$compile($dest)($scope);self.$apply()};self.reloadTable=function(){var temptable=jQuery("#serverSideDataTable").DataTable();temptable.ajax.url("/data/bidStatus/lotsLost").load()};
table.overrideDefaults=function(data){if(!self.timeRangeSelcted)self.timeRangeSelcted=self.showTimeRanges[0];data.fromDate=self.timeRangeSelcted.fromDate;data.toDate=self.timeRangeSelcted.toDate;var filterJSONString={filters:[]};var bidderFilter={};if(self.selectedBidder){bidderFilter.filterBy="bidderNumber";bidderFilter.filterValue=[self.selectedBidder];filterJSONString.filters.push(bidderFilter)}data.filterCriteria=JSON.stringify(filterJSONString)};self.search=function(lotNumber){var displayStr=
[];var lot=rowDataStore[lotNumber];if(!_.isUndefined(lot)||!_.isEmpty(lot)){if(lot.lotMake){self.searchCriteria.MISC.push("lot_make_desc:"+lot.lotMake.toUpperCase());displayStr.push(lot.lotMake)}if(lot.lotModel){self.searchCriteria.MISC.push("lot_model_desc:"+lot.lotModel.toUpperCase());displayStr.push(lot.lotModel)}if(lot.lotYear){displayStr.push(lot.lotYear);self.searchCriteria.MISC.push("lot_year:"+lot.lotYear)}displayStr=displayStr.join(",");$location.url("/vehicleFinderSearch?displayStr\x3d"+
displayStr+"\x26from\x3d"+$location.url())}};self.filterTable=function(bidder){self.selectedBidder=bidder;console.log("calling filtering"+bidder);self.reloadTable()};var highlightIcons=_.where(appConfigService.appConfig.highlightIcons,{iconType:"H"});self.validIconCodes=_.pluck(highlightIcons,"iconCode");self.generateIconTemplate=function(template,iconCodes){template=template+'\x3cspan copart-vehicle-iconss class\x3d" highlighticon "\x3e ';for(var i=0;i<iconCodes.length;i++){var code=iconCodes[i];
template+='\x3ca lot-highlights-tool-tip fragment-id\x3d"'+code+'" class\x3d"icon-tooltip" data-placement\x3d"auto right" data-toggle\x3d"popover" data-container\x3d".lots-lost"\x3e'+'\x3cspan class\x3d"vehicleicon"\x3e\x3cimg src\x3d"../images/global/highlightIcons-'+appInit.regionCode+'.png" class\x3d"lotIcon-'+code+' bid-icon-img"\x3e\x3c/span\x3e\x3c/a\x3e'}template=template+"\x3c/span\x3e";return template}}]);
app.controller("vehicleFinderController",["$scope","searchCriteria","$timeout","$location","$filter","dataServiceG2","$interpolate","$q","urlStore","localStorageService","userService","appConfigService","urlService","geocodingService",function($scope,searchCriteria,$timeout,$location,$filter,dataServiceG2,$interpolate,$q,urlStore,localStorageService,userService,appConfigService,urlService,geocodingService){var self=$scope;self.parentScope=$scope.$parent;var locale=$scope.$parent.locale;var redoSearch=
false;if(self.parentScope.cleanUp){self.parentScope.cleanUp();redoSearch=true}self.form={};self.form.zip=userService.userConfig.buyerZip;self.searchCriteria=searchCriteria;var quickPickCountUpdate=null;self.vehicleFinderQuickPicks=new QuickPicks;self.showLocation=true;self.defaultLocation={};var categoryMap=[];self.alerts=[];self.errors={zipCode:false,vin:false};var formName="vehicle-finder-form";var defaultVehicleType=userService.userConfig.siteCode=="CRTSUS"?"C":"V";self.siteCode=userService.userConfig.siteCode;
appConfigService.getLocationsListBySite(function(response){self.yardLocations=response;if(!_.isEmpty(self.selectedYard)&&_.isEmpty(self.defaultLocation))self.form.yardLocation=_.find(self.yardLocations,function(item){if(item.yardName===self.selectedYard.yardName)return item})});self.vehicleFinderLocations=function(){dataServiceG2.getYardLocations(function(response){self.yardLocations=response.data})};var addAlerts=function(type,msg){self.alerts.push({msg:msg,type:type})};self.closeAlert=function(index){self.alerts.splice(index,
1)};self.search=function(form){var displayStr=[];if(form.vehicleMake){var vehicleMake=_.find(appConfigService.getAppConfig().vehicleMakes,{code:form.vehicleMake,type:form.vehicleType});self.searchCriteria.MISC.push("lot_make_code:"+vehicleMake.code+"+OR+lot_make_desc:"+vehicleMake.description);displayStr.push(vehicleMake.description)}if(form.model&&form.model!=="All Models"&&form.model!=="ALL MODELS"){self.searchCriteria.MISC.push("lot_model_group:"+form.model);displayStr.push(form.model)}if(form.category){self.searchCriteria.MISC.push(categoryMap[form.category]);
displayStr.push(form.category)}if(form.vehicleType)self.searchCriteria.MISC.push("vehicle_type_code:VEHTYPE_"+form.vehicleType);if(form.yardLocation&&form.searchBy=="locations"){self.searchCriteria.MISC.push("yard_number:"+form.yardLocation.yardNumber);displayStr.push(form.yardLocation.yardName)}else if(!_.isEmpty(self.defaultLocation)&&!self.showLocation){self.searchCriteria.MISC.push("yard_number:"+self.defaultLocation.yardNumber);displayStr.push(self.defaultLocation.yardName)}if(form.state&&form.searchBy==
"state"){self.searchCriteria.MISC.push("location_state:"+form.state);displayStr.push(form.state)}if(form.fromYear||form.toYear){var yearRngObject={};_.defaults(yearRngObject,{fromYear:"*",toYear:"*"});if(form.fromYear)yearRngObject.fromYear=form.fromYear;if(form.toYear)yearRngObject.toYear=form.toYear;if(form.fromYear&&form.toYear&&form.fromYear>form.toYear){addAlerts("danger","From year cannot be after To year");return}var yearQueryStr=$interpolate("[{{fromYear}} TO {{toYear}}]")(yearRngObject);
displayStr.push(yearQueryStr);self.searchCriteria.MISC.push("lot_year:"+yearQueryStr)}if(form.searchBy=="zip")if(!AppUtils.isUndefined(form.zip)&&form.zip!=""){self.errors.zipCode=false;geocodingService.getCoordinatesForZip(form.zip,function(retData){var zipObject={};_.defaults(zipObject,{latitude:"*",longitude:"*",miles:9999});zipObject.latitude=retData.latitude;zipObject.longitude=retData.longitude;if(form.miles)zipObject.miles=form.miles;var zipQuery=$interpolate("{!geofilt pt\x3d{{latitude}},{{longitude}} sfield\x3dyard_location d\x3d{{miles}}}")(zipObject);
self.searchCriteria.MISC.push(encodeURIComponent(zipQuery));self.searchCriteria.sortByZip=true;self.searchCriteria.buyerEnteredZip=form.zip;self.searchCriteria.milesAway=zipObject.miles;displayStr.push(form.zip);displayStr=displayStr.join(",");localStorageService.set(formName,form);var queryString=redoSearch?displayStr:displayStr+"\x26from\x3d"+$location.url();$location.url("/vehicleFinderSearch?displayStr\x3d"+queryString)})}else self.errors.zipCode=true;else{displayStr=displayStr.join(",");localStorageService.set(formName,
form);var queryString=redoSearch?displayStr:displayStr+"\x26from\x3d"+$location.url();$location.url("/vehicleFinderSearch?displayStr\x3d"+queryString)}};self.searchQuickPicks=function(query){self.searchCriteria.MISC.push(query);return true};self.searchByLotNumber=function(){var lotNumber=self.lotNumber;if(_.isEmpty(lotNumber))alert(locale.messages["app.label.vehicleFinder.error.lookUpLot.empty"]);else if(lotNumber.trim().length<3||lotNumber.trim().length>10||_.isNaN(lotNumber-0))alert(locale.messages["app.label.vehicleFinder.error.lookUpLot.invalid"]);
else $location.url(urlStore.lotDetailUrl+lotNumber)};var getLotByVin=function(searchQuery){var lotSearchArr=[];lotSearchArr.push("ps_vin_number:"+searchQuery);var searchCriteria={MISC:lotSearchArr};self.searchCriteria.MISC=lotSearchArr;dataServiceG2.getLotsByLotNumber({filter:searchCriteria},function(response){try{if(!_.isUndefined(response.data.data.results.content)&&response.data.data.results.content.length==1){var lot=response.data.data.results.content[0];$location.url(urlService.lotDetailUrl+
lot.ln)}else{var displayStr=[];displayStr.push(self.vin);displayStr=displayStr.join(",");$location.url("/vehicleFinderSearch?displayStr\x3d"+displayStr+"\x26from\x3d"+$location.url())}}catch(e){self.searchCriteria.MISC=[];console.log("Error fetchign lot by lot number"+e)}})};self.searchByVINNumber=function(){self.errors.vin=false;self.vin=self.form.vin;if(!self.vin||self.vin.length!=17||!/^(?=.*[0-9])(?=.*[a-zA-Z])([a-zA-Z0-9]+)$/.test(self.vin))self.errors.vin=true;else getLotByVin(self.vin)};self.getModels=
function(){self.modelList=$filter("filter")(self.appConfig.vehicleMakeandModels,{type:self.form.vehicleMake})};var retrieveForm=function(){var previousForm=localStorageService.get(formName);if(previousForm!==undefined&&previousForm!=null){self.form.vehicleType=previousForm.vehicleType;self.form.fromYear=previousForm.fromYear;self.form.toYear=previousForm.toYear;self.form.vehicleMake=previousForm.vehicleMake;self.form.model=previousForm.model;self.form.searchBy=previousForm.searchBy;self.selectedYard=
previousForm.yardLocation;self.form.state=previousForm.state;self.form.zip=previousForm.zip;self.form.miles=previousForm.miles}else{self.form.vehicleType=defaultVehicleType;self.form.fromYear=self.appConfig.searchYears[11].code!==undefined?self.appConfig.searchYears[11].code:"2006";self.form.toYear=self.appConfig.searchYears[0].code!==undefined?self.appConfig.searchYears[0].code:"2017";self.form.searchBy="locations";self.form.miles=self.appConfig.zipMiles[0].description}self.getModels()};self.$on("ngRepeatFinished",
function(ngRepeatFinishedEvent){self.form.vehicleType=self.appConfig.vehicleTypes[0].code});var quickPicks=function(){categoryMap=[];dataServiceG2.getQuickPicks("HOME",function(quickPicks){var category=quickPicks.category;_.each(category,function(cat){categoryMap[cat.itemName]=cat.searchQuery})})};self.init=function(){self.searchCriteria.MISC=[];retrieveForm();quickPicks()};self.init();$scope.$on("$destroy",function(){if(quickPickCountUpdate)$timeout.cancel(quickPickCountUpdate)})}]);
app.controller("lotDetailsController",["$rootScope","$scope","$location","dataServiceG2","$routeParams","$timeout","urlService","$q","userService","$locale","$filter","config","watchListService","appConfigService","staticLotDetails","dateFilter","searchCriteria","copartUser","trimFilter","$sce","auctionsCalendarService","bidService","siteCatalyst","$window","$route",function($rootScope,$scope,$location,dataServiceG2,$routeParams,$timeout,urlService,$q,userService,$locale,$filter,config,watchListService,
appConfigService,staticLotDetails,dateFilter,searchCriteria,copartUser,trimFilter,$sce,auctionsCalendarService,bidService,siteCatalyst,$window,$route){var self=$scope;var staticLotDetailsPromise=staticLotDetails;self.addBidLimitInquiryVO={};self.estimates={};self.iconDesc="";self.showWatchList=false;self.showConditionReportButton=false;self.showConditionReportLink=false;if(staticLotDetailsPromise&&staticLotDetailsPromise.returnCode==1&&staticLotDetailsPromise.data.lotDetails){self.lotNumber=$routeParams.lotId;
self.lotExists=true;self.lotDetails=staticLotDetailsPromise.data.lotDetails;self.csvUrl="/data/export/downloadLotDetails?lotNumber\x3d"+self.lotDetails.ln;if($route.current.params.showAllPhotos){$route.current.$$route.titleKey="app.lotPhotos.title";$route.current.$$route.descKey="app.lotPhotos.description"}else{$route.current.$$route.titleKey="app.lotdetails.title";$route.current.$$route.descKey="app.lotdetails.description"}$rootScope.$emit("meta-args-update",{year:self.lotDetails.lcy,make:self.lotDetails.mkn,
model:self.lotDetails.lm,bodyStyle:self.lotDetails.bstl,yardName:self.lotDetails.yn});self.lotDetails.lotId=self.lotNumber;if(self.lotDetails.offFlg){var offSiteYardSuccessCallBack=function(response){if(response)self.lotDetails.offsiteYard=response.data.data.offSiteYard};dataServiceG2.getOffisteYard(self.lotNumber,offSiteYardSuccessCallBack)}self.marketGuideUrl="/marketGuide/"+self.lotNumber+"/"+trimFilter(self.lotDetails.fv)}else{self.lotExists=false;return}self.searchCriteria=searchCriteria;self.userConfig=
self.$parent.userConfig;self.buyerStatus=self.$parent.userConfig.buyerStatus;self.lotFullDesc=trimFilter(self.lotDetails.lcy)+" "+trimFilter(self.lotDetails.mkn)+" "+trimFilter(self.lotDetails.lm);if($location.search().showflag&&$location.search().showflag=="true")$("#market-purchase-success").modal("show");watchListService.setWatchListDefinition($location.url());self.showAllPhotos=$routeParams.showAllPhotos;if(self.showAllPhotos&&(self.showAllPhotos.toUpperCase()=="ALL"||self.showAllPhotos.toUpperCase()==
"PHOTOS"))self.showRegularView=false;else self.showRegularView=true;self.yardDetails={};self.destZipLatitude=null;self.destZipLongitude=null;self.imageURL=appConfigService.getEnvConfigProps().imageBaseUrl;self.urlProtocol=urlService.getURLProtocol();self.locale=$scope.$parent.locale;self.loadingBidDetails=true;self.siteCode=copartUser.getUserConfig().siteCode;self.roles=copartUser.config.roles;self.showBuyItNow=false;self.showCounterBidInline=false;self.showPrelimBidInline=false;self.showPrelimBidInline=
false;self.showBidInfo=true;self.alreadyPurchasedPayNow=false;self.purchasedNowPayLater=false;self.bidIncrements=bidService.getBidIncrements();self.marketGuideAvailableForALot="N";self.autoCheckSubscriptrionInfo=null;self.autoGuidePurchased=null;self.marketGuide=null;self.lotIconCodes=null;self.showAutoCheck="N";self.showInstaVin="N";var currentUrl=$location.absUrl();self.isAnonymous=userService.isAnonymous();var log=new Logger({name:"LotDetailsController",level:config.logLevel});self.saleDateFormat=
"EEE. MMM d, yyyy";self.saleTimeFormat="hh:mm a";self.timeZoneAbbr=copartUser.getUserTimzoneAbbr();var bidInquiryVO={};self.validateDate=function(inputDate){if(!inputDate)return false;var date=new Date(inputDate);return angular.isDate(date)};self.openRegularView=function(){self.showRegularView=true};self.showAllPhotosView=function(event){try{s.products=";"+self.lotNumber;self.$parent.doTagPageView("lotphotos")}catch(e){log.error("site catalyst page view lotphotos call unsuccessful")}if(!event.ctrlKey){self.showRegularView=
false;event.stopPropagation();event.preventDefault()}};var getDynamicLotDetails=function(){dataServiceG2.getDynamicLotDetails(self.lotNumber,lotDetailsDymicSuccessCallBack)};var init=function(){getLotImages();getDynamicLotDetails();retrieveLotIconCodes();getLotIconObjects();getLotVideo()};self.getConditionalReport=function(){var successCallBack=function(response){try{if(response.data&&response.data.data.conditionalReport){self.coditionalReportUrl=response.data.data.conditionalReport;var newWin=window.open(self.coditionalReportUrl);
if(!newWin||newWin.closed||typeof newWin.closed=="undefined")alert("Pop-ups are disabled, please enable to open the condition report in a new window.")}}catch(error){log.error(error)}};dataServiceG2.getConditionalReportForLot(self.lotNumber,successCallBack)};var getLotVideo=function(){var successCallBack=function(response){try{if(response.data&&response.data.data.lotVideo[0].url)self.videoUrl=$sce.trustAsResourceUrl(response.data.data.lotVideo[0].url)}catch(error){log.error(error)}};dataServiceG2.getLotVideo(self.lotNumber,
successCallBack)};self.getPreviousLot=function(){lotDetailNavigationService.getPreviousLot(self)};self.getNextLot=function(){lotDetailNavigationService.getNextLot(self)};var generateSaleDate=function(){if(self.dynamiclotDetails.futureSale!="Y"&&self.validateDate(self.lotDetails.ad)){self.displaySaleDate=moment.utc(self.lotDetails.ad).tz(userService.userConfig.selectedTimezone).format("ddd. MMM DD, YYYY");self.displaySaleTime=moment.utc(self.lotDetails.ad).tz(userService.userConfig.selectedTimezone).format("hh:mm A zz");
if(self.dynamiclotDetails.liveBid!="S")calculateTimeDifference(self.lotDetails.ad)}};var calculateTimeDifference=function(saleDateTime){var currDate=moment().utc();if(self.dynamiclotDetails.liveBid=="Y"){self.displayTimeLeftForSale="Live!";return}if(currDate.isAfter(moment.utc(saleDateTime)))return;self.showAddToCalendar=true;self.outLookStartDate=moment(saleDateTime).format("YYYY-MM-DDTHH:mm");self.outLookEndDate=moment(self.outLookStartDate).add(30,"minutes").format("YYYY-MM-DDTHH:mm");self.outLookSubject=
self.lotFullDesc;self.outLookUrl=$location.host();self.displayTimeLeftForSale=auctionsCalendarService.timeToAuction(saleDateTime)};var lotDetailsDymicSuccessCallBack=function(response){self.loadingBidDetails=false;try{if(response.data.returnCode==-1)self.dynamicLotDetailsError=response.data.data.errorObject;else{self.dynamiclotDetails=response.data.data.lotDetails;if(self.dynamiclotDetails.saleStatus!="Sold"&&self.dynamiclotDetails.saleStatus!="SOLD_PENDING_TITLE"&&self.dynamiclotDetails.saleStatus!=
"SOLD")self.showWatchList=true;if(self.dynamiclotDetails.buyTodayFlag=="Y"||self.dynamiclotDetails.buyTodayFlag=="B")self.buyTodayBid=self.dynamiclotDetails.buyTodayBid;else self.buyTodayBid=self.dynamiclotDetails.currentBid;self.loadingsaleEndInfo=false;generateSaleDate();setReviveParams()}}catch(e){log.error(e)}};self.onCalculate=function(){var estimate=[];estimate.push(trimFilter(self.lotDetails.zip));estimate.push(trimFilter(self.lotDetails.zipTo));estimate.push(trimFilter(self.lotDetails.mkn));
estimate.push(trimFilter(self.lotDetails.lm));estimate.push(self.lotDetails.lcy);estimate.push(trimFilter(self.lotDetails.fv));estimate.push(true);dataServiceG2.getDeliveryEstimate(estimate,function(response){if(response.returnCode==1&&response.data.estimate.amount){self.amount=response.data.estimate.amount;self.showAmount=true}else self.displayError=true})};self.viewMaps=function(){var address=self.estimates.newZipCode;var geocoder=new google.maps.Geocoder;geocoder.geocode({"address":address},function(results,
status){if(status==google.maps.GeocoderStatus.OK){self.destZipLatitude=results[0].geometry.location.lat();self.destZipLongitude=results[0].geometry.location.lng()}else log.error("Geocode was not successful for the following reason: "+status);window.open("http://maps.google.com/maps?saddr\x3d"+self.lotDetails.lat+","+self.lotDetails["long"]+"\x26daddr\x3d"+self.destZipLatitude+","+self.destZipLongitude)})};var getAutoCheckSubscriptionInfo=function(){dataServiceG2.getAutoCheckSubscriptionInfo(function(response){if(response.returnCode==
1)self.autoCheckSubscriptrionInfo=response.data.autoCheckSubscriptioninfo;else log.error(" AutoCheckSubscription Info is not available for lot "+self.lotNumber+"as the Response is"+response.returnCode)})};self.purchaseSubscriptionForAutoGuide=function(){var autoCheckSubscrptionInquiryVO={"expirationDate":self.autoCheckSubscriptrionInfo.expirationDate,"purchasePrice":self.autoCheckSubscriptrionInfo.purchasePrice};dataServiceG2.createAutoCheckSubscriptionRequest(autoCheckSubscrptionInquiryVO,function(response){if(response.returnCode==
1){var batchNumber=response.data.autoCheckSubscriptionRequest.batchNumber;var requestParam={};requestParam.LOT_NUMBER=self.lotNumber;requestParam.GATEWAY_URL_KEY="AUTO_CHECK";requestParam.pciCallBackBaseUrl="lotDetail/"+self.lotNumber;requestParam.cancelCallBackUrl="lotDetail/"+self.lotNumber;requestParam.successCallBackURL="lotDetail/"+self.lotNumber;dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=trimFilter(response.data.pciURL);else log.error("Error in Gateway")})}else log.error(" AutoCheckSubscription Request denied  as the Response is"+
response.returnCode)})};self.purchaseSubscriptionForMarketGuide=function(){var marketGuideInquiryVO={"lotId":self.lotNumber,"price":self.marketGuide.price};dataServiceG2.createMGuidePurchaseRequest(marketGuideInquiryVO,function(response){if(response.returnCode==1){var batchNumber=response.data.marketGuide.batchNumber;var requestParam={};requestParam.transactionId=batchNumber;requestParam.GATEWAY_URL_KEY="MARKET_GUIDE";requestParam.cancelCallBackUrl="lot/"+self.lotNumber;requestParam.successCallBackURL=
"lot/"+self.lotNumber+"?showflag\x3dtrue";dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=trimFilter(response.data.pciURL);else log.error("Error in Gateway")})}else log.error(" Market Guide Purchase Request denied  as the Response is"+response.returnCode)})};self.openMarketGuide=function(){if(!userService.isAnonymous())dataServiceG2.getMarketGuideDetails(self.lotNumber,function(response){if(response.returnCode==1){self.marketGuide=response.data.marketGuide;
if(self.marketGuide.marketGuidePurchased=="Y")$location.url("/marketGuide/"+self.lotNumber+"/"+trimFilter(self.lotDetails.fv));else $("#marketGuideReport").modal("show")}else log.error(" Market Guide Purchase Information  denied for "+self.lotNumber+" as the Response is"+response.returnCode)})};self.openAutoCheckGuide=function(){getAutoCheckSubscriptionInfo();if(!userService.isAnonymous())dataServiceG2.autoCheckPurchasedOrNot(function(response){if(response.returnCode==1){self.autoGuidePurchased=response.data.checkForAutoCheckReport;
if(containsElementInArray(self.roles,"ROLE_BROKER_BIDDER"))$("#bidderUnderBuyerMessage").modal("show");else if(self.autoGuidePurchased.autoGuidePurchased=="Y")$("#autocheckDisclaimerReport").modal("show");else $("#autocheckReport").modal("show")}else log.error(" Auto Guide not available  "+self.lotNumber+" as the Response is"+response.returnCode)})};self.requestAutoCheckKey=function(){$("#autocheckDisclaimerReport").modal("hide");var autoCheckWindow=window.open("","_blank");autoCheckWindow.document.write("Loading report...");
var autoCheckKeyVO={"mode":"A","key_in":"0","vin_in":trimFilter(self.lotDetails.fv)};dataServiceG2.createAutoCheckKeyFile(autoCheckKeyVO,function(response){if(response.returnCode==1)autoCheckWindow.location.href=response.data.autocheckURL+response.data.createAutoCheckKeyFile.key_out;else log.error(" Autocheck Key generation Error"+response.returnCode)})};var retrieveLotIconCodes=function(){dataServiceG2.retrieveLotIconCodes(self.lotNumber,function(response){if(response.returnCode==1){if(response.data.lotIconCodes.iconCodes)self.lotIconCodes=
response.data.lotIconCodes.iconCodes.trim().split("|");if(_.contains(self.lotIconCodes,"IV"))self.showInstaVin="Y";if(_.contains(self.lotIconCodes,"AUTOCHECK")||_.contains(self.lotIconCodes,"AUTOCHECKP"))self.showAutoCheck="Y";if(_.contains(self.lotIconCodes,"MKT_GUIDE")||_.contains(self.lotIconCodes,"MKT_GUIDEP"))self.marketGuideAvailableForALot="Y";if(_.contains(self.lotIconCodes,"CR"))self.showConditionReportButton=true;var sellerIconsArray=_.where(self.appConfig.highlightIcons,{iconType:"P"});
self.sellerIconObj=_.find(sellerIconsArray,function(obj){return this.keys.indexOf(obj.iconCode)>-1},{"keys":self.lotIconCodes})}else log.error("Error in fetching lot icon codes")})};self.addToWatchList=watchListService.addToWatchList;self.isAlreadyAdded=watchListService.isAlreadyAdded;self.removeFromWatchList=watchListService.removeFromWatchList;self.openCounterBidCnfrmModal=function(actionType){if(!userService.isAnonymous()){self.counterBidErrorMsg="";if(actionType=="acceptSellerMin"){self.successBid=
self.dynamiclotDetails.minBid;self.submitBid=self.acceptSellerMininimumBid}if(actionType=="keepCurrentBid"){self.successBid=self.dynamiclotDetails.currentBid;self.submitBid=self.confirmKeepCurrentBid}if(actionType=="counterBid"){if(!self.dynamiclotDetails.counterBidAmount||parseInt(self.dynamiclotDetails.counterBidAmount)<0){self.counterBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.valid.amount");return}else if(parseInt(self.dynamiclotDetails.counterBidAmount)<parseInt(self.dynamiclotDetails.currentBid)||
parseInt(self.dynamiclotDetails.counterBidAmount)<parseInt(self.dynamiclotDetails.currentBid)+parseInt(self.dynamiclotDetails.bidIncrement)){var validBid=parseInt(self.dynamiclotDetails.currentBid)+parseInt(self.dynamiclotDetails.bidIncrement);self.counterBidErrorMsg=self.locale.getMessage("lotdetail.error.not.lower.than")+" "+validBid;return}self.successBid=self.dynamiclotDetails.counterBidAmount;self.submitBid=self.confrimCounterBid}self.showCounterBidInline=true;self.showBidInfo=false}};self.cancelCounterBidInlineModal=
function(){self.showBidInfo=true;self.showCounterBidInline=false;self.counterBidErrorMsg=""};var closeBidModal=function(id){self.loadingBidDetails=true;if($("#"+id).is(":visible"))$("#"+id).modal("hide")};var counterBidSuccessCallBack=function(response){self.cancelCounterBidInlineModal();if(response.returnCode==1)$("#bidCnfrmSuccessModal").modal("show");else{var lotReturnCode=response.data.errorObject;if(lotReturnCode.code.trim()=="WB84013"){$("#counterBidErrorModal").modal("show");getDynamicLotDetails();
return}else if(self.locale.messages["lotdetail.error.code."+lotReturnCode.code.trim()])self.bidErrorMsg=self.locale.getMessage("lotdetail.error.code."+lotReturnCode.code.trim());else self.bidErrorMsg=lotReturnCode.message;$("#bidErrorModal").modal("show")}getDynamicLotDetails()};self.invokeCounterBidService=function(bidInquiryVO,callBack){self.loadingBidDetails=true;dataServiceG2.confirmCounterBid(bidInquiryVO,callBack)};self.confrimCounterBid=function(){bidInquiryVO={};bidInquiryVO.eventType="counterBid";
bidInquiryVO.lotId=self.lotNumber;bidInquiryVO.maxBid=self.dynamiclotDetails.counterBidAmount;self.invokeCounterBidService(bidInquiryVO,counterBidSuccessCallBack)};self.confirmKeepCurrentBid=function(){bidInquiryVO={};bidInquiryVO.eventType="keepCurrentBid";bidInquiryVO.lotId=self.lotNumber;bidInquiryVO.bidAmount=self.dynamiclotDetails.currentBid;self.invokeCounterBidService(bidInquiryVO,counterBidSuccessCallBack)};self.acceptSellerMininimumBid=function(){bidInquiryVO={};bidInquiryVO.eventType="acceptSellerMin";
bidInquiryVO.lotId=self.lotNumber;bidInquiryVO.minBid=self.dynamiclotDetails.minBid;self.invokeCounterBidService(bidInquiryVO,counterBidSuccessCallBack)};function incrementValue(bidValue,incrementValue){bidValue=parseInt(bidValue);incrementValue=parseInt(incrementValue);var baseValue=self.dynamiclotDetails.currentBid+incrementValue;if((bidValue+incrementValue)%incrementValue==0)return bidValue+incrementValue<=9999999?bidValue+incrementValue<baseValue?baseValue:bidValue+incrementValue:9999999;var incrementFactor=
Math.abs(incrementValue-bidValue%incrementValue);return bidValue+incrementFactor<=9999999?bidValue+incrementFactor<baseValue?baseValue:bidValue+incrementFactor:9999999}self.increment=function(event){if(event!==undefined&&event=="counterbid")self.dynamiclotDetails.bidAmount=self.dynamiclotDetails.counterBidAmount;if(self.dynamiclotDetails.bidAmount==""||self.dynamiclotDetails.bidAmount==undefined)if(self.dynamiclotDetails.currentBid<=0)self.dynamiclotDetails.bidAmount=incrementValue(self.dynamiclotDetails.currentBid,
self.dynamiclotDetails.bidIncrement);else self.dynamiclotDetails.bidAmount=incrementValue(self.dynamiclotDetails.currentBid,bidService.getBidIncrement(self.dynamiclotDetails.currentBid));else if(self.dynamiclotDetails.currentBid<=0)self.dynamiclotDetails.bidAmount=incrementValue(self.dynamiclotDetails.bidAmount,self.dynamiclotDetails.bidIncrement);else self.dynamiclotDetails.bidAmount=incrementValue(self.dynamiclotDetails.bidAmount,bidService.getBidIncrement(self.dynamiclotDetails.currentBid));if(event!==
undefined&&event=="counterbid")self.dynamiclotDetails.counterBidAmount=self.dynamiclotDetails.bidAmount};function decrementValue(bidValue,decrementValue){bidValue=parseInt(bidValue);decrementValue=parseInt(decrementValue);var baseValue=self.dynamiclotDetails.currentBid+decrementValue;if((bidValue-decrementValue)%decrementValue==0)return bidValue-decrementValue>baseValue?bidValue-decrementValue:baseValue;var decrementFactor=Math.abs(decrementValue-bidValue%decrementValue);return bidValue-decrementValue+
decrementFactor>baseValue?bidValue-decrementValue+decrementFactor:baseValue}self.decrement=function(event){if(event!==undefined&&event=="counterbid")self.dynamiclotDetails.bidAmount=self.dynamiclotDetails.counterBidAmount;if(self.dynamiclotDetails.bidAmount==""||self.dynamiclotDetails.bidAmount==undefined)if(self.dynamiclotDetails.currentBid<=0)self.dynamiclotDetails.bidAmount=decrementValue(self.dynamiclotDetails.currentBid,self.dynamiclotDetails.bidIncrement);else self.dynamiclotDetails.bidAmount=
decrementValue(self.dynamiclotDetails.currentBid,bidService.getBidIncrement(self.dynamiclotDetails.currentBid));else if(self.dynamiclotDetails.currentBid<=0)self.dynamiclotDetails.bidAmount=decrementValue(self.dynamiclotDetails.bidAmount,self.dynamiclotDetails.bidIncrement);else self.dynamiclotDetails.bidAmount=decrementValue(self.dynamiclotDetails.bidAmount,bidService.getBidIncrement(self.dynamiclotDetails.currentBid));if(event!==undefined&&event=="counterbid")self.dynamiclotDetails.counterBidAmount=
self.dynamiclotDetails.bidAmount};self.openPrelimBidModal=function(){self.clearBidFieldsErrorMsg="";if(!userService.isAnonymous()){self.startingBidErrorMsg="";self.maxBidErrorMsg="";if(!self.dynamiclotDetails.bidAmount||parseInt(self.dynamiclotDetails.bidAmount)<0)self.startingBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.valid.amount");if(!self.dynamiclotDetails.maximumBid||parseInt(self.dynamiclotDetails.maximumBid)<0)self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.valid.amount");
if(self.startingBidErrorMsg||self.maxBidErrorMsg)return;if(parseInt(self.dynamiclotDetails.bidAmount)<parseInt(self.dynamiclotDetails.bidIncrement))self.startingBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.enter.mimimum")+" "+self.dynamiclotDetails.bidIncrement;if(parseInt(self.dynamiclotDetails.maximumBid)<parseInt(self.dynamiclotDetails.bidAmount))self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.maxbid.less.than.startbid");if(!self.startingBidErrorMsg&&!self.maxBidErrorMsg){self.showPrelimBidInline=
true;self.showBidInfo=false}}};self.openIncreaseBidModal=function(){self.clearBidFieldsErrorMsg="";if(!userService.isAnonymous()){self.maxBidErrorMsg="";if(!self.dynamiclotDetails.bidAmount||parseInt(self.dynamiclotDetails.bidAmount)<0){self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.valid.amount");return}var currentMaxBid=parseInt(self.dynamiclotDetails.maxBid)>parseInt(self.dynamiclotDetails.currentBid)?self.dynamiclotDetails.maxBid:self.dynamiclotDetails.currentBid;var validBid=
parseInt(currentMaxBid)+parseInt(self.dynamiclotDetails.bidIncrement);if(parseInt(self.dynamiclotDetails.bidAmount)<validBid)self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.enter.mimimum")+" "+validBid;if(!self.maxBidErrorMsg){self.showIncreaseBidInline=true;self.showBidInfo=false}}};self.openMakeAnOfferInline=function(){self.clearBidFieldsErrorMsg="";if($("#makeAnOfferBtn").hasClass("action-disable-btn")){self.clearBidFieldsErrorMsg=self.locale.getMessage("lotdetail.error.label.toSelect.makeOffer")+
self.locale.getMessage("lotdetail.error.clear.bidFields");return}if(!userService.isAnonymous()){self.showMakeAnOfferInline=true;self.maxBidErrorMsg="";self.showBidInfo=false}};self.closeMakeAnOfferModal=function(){self.maxBidErrorMsg="";self.showMakeAnOfferInline=false;self.showBidInfo=true};self.submitMakeAnOffer=function(){self.maxBidErrorMsg="";if(!self.dynamiclotDetails.offerBidAmount||parseInt(self.dynamiclotDetails.offerBidAmount)<=0){self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.valid.amount");
return}var successCallBack=function(response){if(response.success){self.closeMakeAnOfferModal();$("#makeAnOfrSuccessModal").modal("show");getDynamicLotDetails()}else{self.openMakeAnOfferInline();self.loadingBidDetails=false;var errorObject=response.errorObject;if(!errorObject)return;if(errorObject.errorCode&&errorObject.errorCode.trim()==self.locale.getMessage("lotdetail.error.code.licenceRequired"))self.maxBidErrorMsg=self.locale.getMessage("lotdetail.bidInfo.alerts.dueTo.licensing");else self.maxBidErrorMsg=
getBidErrorMessage(errorObject)}};self.loadingBidDetails=true;self.successBid=self.dynamiclotDetails.offerBidAmount;bidInquiryVO={};bidInquiryVO.lotId=self.lotNumber;bidInquiryVO.bidAmount=self.dynamiclotDetails.offerBidAmount;dataServiceG2.submitMakeAnOffer(bidInquiryVO,successCallBack)};self.cancelPrelimBidInline=function(){self.maxBidErrorMsg="";self.showPrelimBidInline=false;self.showBidInfo=true};self.cancelIncreaseBidInline=function(){self.maxBidErrorMsg="";self.showIncreaseBidInline=false;
self.showBidInfo=true};self.cancelMisTypedBidInline=function(){self.maxBidErrorMsg="";self.showMisTypedBidInline=false;self.showBidInfo=true};var isLicenceRequired=function(errorCode){if(errorCode==self.locale.getMessage("lotdetail.error.code.licenceRequired")){$("#licenceRequiredModal").modal("show");return true}};var isIncBuyingPwrRequired=function(errorCode){if(errorCode==self.locale.getMessage("lotdetail.error.code.increase.buying.power")){self.bidderUnderBroker=copartUser.hasRoleAccess("ROLE_BROKER_BIDDER")||
copartUser.hasRoleAccess("ROLE_BIDDER");$("#pciRedirectionModal").modal("show");return true}};var getBidErrorMessage=function(errorObj){if(!errorObj)return;var errorCode=errorObj.errorCode?errorObj.errorCode.trim():"";if(self.locale.messages["lotdetail.error.code."+errorCode])return self.locale.getMessage("lotdetail.error.code."+errorCode,errorObj.outLowerBid,errorObj.outHigherBid);else return errorObj.errorMessage};var prelimBidSuccessCallBack=function(response,callBack){self.maxBidErrorMsg="";self.cancelPrelimBidInline();
self.cancelIncreaseBidInline();self.cancelMisTypedBidInline();if(response.returnCode==1){if(response.data.result.lots[self.lotNumber]){var lotReturnCode=response.data.result.lots[self.lotNumber];if(lotReturnCode&&lotReturnCode.errorCode){var errorCode=lotReturnCode.errorCode?lotReturnCode.errorCode.trim():"";self.failureBidInquiryVO=bidInquiryVO;if(isLicenceRequired(errorCode)||isIncBuyingPwrRequired(errorCode)){self.loadingBidDetails=false;return}self.bidErrorMsg=getBidErrorMessage(lotReturnCode);
$("#bidErrorModal").modal("show");if(callBack)callBack()}}else{$("#bidCnfrmSuccessModal").modal("show");try{lm.Omniture.doTagPrelimBid(userService.userConfig.buyerNumber,bidInquiryVO.lotId,bidInquiryVO.maxBid,bidInquiryVO.bidAmount)}catch(e){log.debug("Error executing site catalyst call")}}getDynamicLotDetails()}};self.invokePrelimBidService=function(bidInquiryVO,misTypedBidErrorCallBack){self.loadingBidDetails=true;var bidInquiryVOArray=[];bidInquiryVOArray.push(bidInquiryVO);dataServiceG2.prelimBidForLot(bidInquiryVOArray,
prelimBidSuccessCallBack,misTypedBidErrorCallBack)};self.increaseBidForLot=function(){self.successBid=self.dynamiclotDetails.bidAmount;bidInquiryVO={};bidInquiryVO.lotId=self.lotNumber;bidInquiryVO.bidAmount=self.dynamiclotDetails.bidAmount;bidInquiryVO.startingBid=self.dynamiclotDetails.bidAmount;bidInquiryVO.maxBid=self.dynamiclotDetails.bidAmount;bidInquiryVO.oneMoreIncrement=self.dynamiclotDetails.oneMoreIncrement?"Y":"N";self.invokePrelimBidService(bidInquiryVO,null)};self.prelimBidForLot=function(){self.successBid=
self.dynamiclotDetails.bidAmount;bidInquiryVO={};bidInquiryVO.lotId=self.lotNumber;bidInquiryVO.bidAmount=self.dynamiclotDetails.bidAmount;bidInquiryVO.startingBid=self.dynamiclotDetails.bidAmount;bidInquiryVO.maxBid=self.dynamiclotDetails.maximumBid;bidInquiryVO.oneMoreIncrement=self.dynamiclotDetails.oneMoreIncrement?"Y":"N";self.invokePrelimBidService(bidInquiryVO,null)};self.openMisTypedModal=function(){self.showMisTypedBidInline=true;self.maxBidErrorMsg="";self.showBidInfo=false};self.sumbitBidForMistypedBid=
function(){if(!userService.isAnonymous())if(!self.dynamiclotDetails.misTypedMaxbid||self.dynamiclotDetails.misTypedMaxbid<0)self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.valid.amount");else if(parseInt(self.dynamiclotDetails.misTypedMaxbid)<parseInt(self.dynamiclotDetails.currentBid))self.maxBidErrorMsg=self.locale.getMessage("lotdetail.error.bid.enter.mimimum")+" "+self.dynamiclotDetails.currentBid;else if(parseInt(self.dynamiclotDetails.misTypedMaxbid)>=parseInt(self.dynamiclotDetails.maxBid))self.maxBidErrorMsg=
self.locale.getMessage("lotdetail.error.bid.should.be.less.than.previous");else{bidInquiryVO={};bidInquiryVO.eventType="misTypedBid";bidInquiryVO.lotId=self.lotNumber;bidInquiryVO.bidAmount=self.dynamiclotDetails.misTypedMaxbid;self.successBid=self.dynamiclotDetails.misTypedMaxbid;lm.Omniture.doTagMistypedbidSuccess(userService.userConfig.buyerNumber,self.lotNumber);self.invokePrelimBidService(bidInquiryVO,function(){if(self.maxBidErrorMsg){self.showMisTypedBidInline=true;self.showBidInfo=false}})}};
self.confirmBuyItNowPurchase=function(){if(self.dynamiclotDetails.buyTodayBid>0&&(self.dynamiclotDetails.buyTodayFlag==="Y"||self.dynamiclotDetails.buyTodayFlag=="B")){bidInquiryVO={};bidInquiryVO.lotId=self.lotNumber;bidInquiryVO.bidAmount=self.dynamiclotDetails.buyTodayBid;bidInquiryVO.yardNumber=self.lotDetails.ynumb;dataServiceG2.confirmBuyItNowPurchase(bidInquiryVO,function(response){if(response.returnCode==1){log.info(" Purchase successfull lot:"+bidInquiryVO.lotId+" for amt:"+bidInquiryVO.bidAmount);
self.loadingsaleEndInfo=true;$("#buyitnowModal").modal("show");self.purchaseSuccess=true;try{lm.Omniture.doTagBuyItNowConfirm(userService.getUserConfig().buyerNumber,bidInquiryVO.lotId,bidInquiryVO.bidAmount)}catch(e){}}else{log.info(" Purchase unsuccessful for lot:"+bidInquiryVO.lotId+" for amt:"+bidInquiryVO.bidAmount);var errorCode=response.data&&response.data.errorCode?response.data.errorCode.trim():"";if(isLicenceRequired(errorCode)||isIncBuyingPwrRequired(errorCode))return;$("#buyitnowModal").modal("show");
self.purchaseSuccess=false;self.buyItNowError=getBidErrorMessage(response.data)}})}};self.closePurchaseModal=function(){if(self.purchaseSuccess){getDynamicLotDetails();self.purchasedNowPayLater=true;self.showBuyItNow=false;self.showBidInfo=false;self.alreadyPurchasedPayNow=false}else{self.showBuyItNow=false;self.showBidInfo=true;self.alreadyPurchasedPayNow=false;self.purchasedNowPayLater=false}};self.payForBuyItNow=function(){$("#purchase-success").removeClass("fade").modal("hide");var url="/paymentsDue";
log.info(" payForBuyItNow ROUTE URL:"+url);$location.url(url)};self.disableBuyItNow=function(){if(!self.isAnonymous&&(self.dynamiclotDetails.bidAmount||self.dynamiclotDetails.maximumBid))return"action-disable-btn";self.clearBidFieldsErrorMsg="";return"btn-black"};self.toggleBuyItToday=function(){self.clearBidFieldsErrorMsg="";if($("#buyItNowBtn").hasClass("action-disable-btn")){self.clearBidFieldsErrorMsg=self.locale.getMessage("lotdetail.error.label.toSelect.buyItNow")+self.locale.getMessage("lotdetail.error.clear.bidFields");
return}if(!userService.isAnonymous())if(self.showBuyItNow){self.showBuyItNow=false;self.showBidInfo=true;self.alreadyPurchasedPayNow=false;self.purchasedNowPayLater=false}else{self.showBuyItNow=true;self.showBidInfo=false;self.alreadyPurchasedPayNow=false;self.purchasedNowPayLater=false}try{siteCatalyst.addToQueue("doTagBuyItNowClick",{});siteCatalyst.executeCall("doTagBuyItNowClick")}catch(e){}};self.openFutureSaleModal=function(){$("#futureSaleModal").modal("show")};self.getLocationHours=function(startTime,
endTime,showLocationHoursFlag){if(showLocationHoursFlag)return dateFilter(startTime,self.saleTimeFormat)+" - "+dateFilter(endTime,self.saleTimeFormat);else return self.locale.getMessage("app.label.not.available")};self.viewInventory=function(){var displayStr=[];if(self.lotDetails.mkn){self.searchCriteria.MISC.push("lot_make_desc:"+self.lotDetails.mkn);displayStr.push(self.lotDetails.mkn)}if(self.lotDetails.lm){self.searchCriteria.MISC.push("lot_model_desc:"+self.lotDetails.lm);displayStr.push(self.lotDetails.lm)}if(self.lotDetails.lcy){displayStr.push(self.lotDetails.lcy);
self.searchCriteria.MISC.push("lot_year:"+self.lotDetails.lcy)}displayStr=displayStr.join(",");$location.url("/vehicleFinderSearch?displayStr\x3d"+displayStr)};var getLotIconObjects=function(){self.iconCodesObjArray=[];var showHighlightIconsArray=_.where(self.appConfig.highlightIcons,{iconType:"H"});var sellerHighlightIconsArray=_.where(self.appConfig.highlightIcons,{iconType:"S"});_.each(self.lotDetails.lic,function(iconCodeObj){_.find(showHighlightIconsArray,function(obj){if(obj.iconCode==iconCodeObj){self.iconCodesObjArray.push(obj);
return true}});self.seller=self.seller||_.find(sellerHighlightIconsArray,{iconCode:iconCodeObj})})};self.getEpicVinURL=function(){_.find(self.appConfig.highlightIcons,function(obj){if(obj.iconCode=="IV"){var siteCatalystVal={};siteCatalystVal.fname="doTagInstaVin";siteCatalystVal.lotId=self.lotNumber;siteCatalyst.addToQueue("doTagInstaVin",siteCatalystVal);siteCatalyst.executeCall("doTagInstaVin");window.open(obj.onClickURL.toString().replace("${FULL_VIN}",trimFilter(self.lotDetails.fv)))}})};self.toolTipForTtlDesc=
function(){var searchDesc="TITLE_LONG_DESC."+trimFilter(self.lotDetails.stt)+"."+trimFilter(self.lotDetails.ts);var searchDescObj=_.find(self.appConfig.titleLongDescription,function(obj){if(obj.code==searchDesc)return true});return searchDescObj&&searchDescObj.description?searchDescObj.description:trimFilter(self.lotDetails.ts)+" "+trimFilter(self.lotDetails.td)};self.openAsIsModal=function(){self.fetchAsIsCmsContent=true;$("#bidInfoAsIsModal").modal("show")};self.increaseBuyingPower=function(){var currentBidInquiry=
{};currentBidInquiry.lotNumber=self.lotNumber;currentBidInquiry.yardNumber=self.lotDetails.ynumb;currentBidInquiry.auctionDate="0";currentBidInquiry.bidAmount=self.failureBidInquiryVO.maxBid;dataServiceG2.getCurrentBidDetails(currentBidInquiry,function(bidResponse){if(bidResponse.returnCode==1){self.requiredDeposit=bidResponse.data.currentBidDetails.requiredDeposit;self.currentDeposit=bidResponse.data.currentBidDetails.currentDepositBal;self.addBidLimitInquiryVO.lotNumber=self.lotNumber;self.addBidLimitInquiryVO.buyingPower=
currentBidInquiry.bidAmount;self.addBidLimitInquiryVO.depositAmount=self.requiredDeposit==null?0:self.requiredDeposit;dataServiceG2.increaseBuyingPower(self.addBidLimitInquiryVO,function(response){if(response.returnCode==1){var batchNumber=response.data.batchNumber;var requestParam={};requestParam.transactionId=batchNumber;requestParam.GATEWAY_URL_KEY="ADD_DEPOSIT";requestParam.cancelCallBackUrl="lot/"+self.lotNumber;requestParam.successCallBackURL="lot/"+self.lotNumber;requestParam.pciCallBackUrl=
$location.absUrl();requestParam.pciCallBackBaseUrl=$location.absUrl();requestParam.currentBidAmount=self.dynamiclotDetails.currentBid;requestParam.currentBidCount=self.dynamiclotDetails.currentBid;requestParam.currentDeposit=self.currentDeposit;requestParam.maxBid=self.dynamiclotDetails.maximumBid;requestParam.requiredDeposit=self.requiredDeposit;requestParam.pciCallBackEventId="valBid";requestParam.pciCallBackExecution="els3";dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==
1)$window.location.href=trimFilter(response.data.pciURL);else log.error("Error in Gateway")},"data/payments/setPciParamForBidding")}})}else{log.error("Error increasing bid-limit");$("#pciRedirectionModal").modal("hide");$("#PCIerrorOccured").modal("show");return}})};self.upgradeMember=function(){var requestParam={};requestParam.GATEWAY_URL_KEY="UPGRADE_MEMBERSHIP";requestParam.cookieValue=$location.path()+"?reAuthn\x3dtrue";dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==
1)$window.location.href=response.data.pciURL.trim();else log.error("Error in Gateway")})};var getLotImages=function(){dataServiceG2.getLotImages($scope.lotNumber,function(response){if(response!=null){var imagesList=response.data.data.imagesList;$scope.fullSizeImages=imagesList.FULL_IMAGE;$scope.thumbNailImages=imagesList.THUMBNAIL_IMAGE}},self.lotDetails)};var setReviveParams=function(){self.reviveappendurl="\x26lotid\x3d"+self.lotNumber+"\x26yardlocation\x3d"+self.lotDetails.yn+"\x26categoryid\x3d"+
self.lotDetails.bstl+"\x26name\x3d"+self.lotFullDesc+"\x26odometer\x3d"+self.lotDetails.orr+"\x26make\x3d"+self.lotDetails.mkn+"\x26model\x3d"+self.lotDetails.lm+"\x26year\x3d"+self.lotDetails.lcy+"\x26color\x3d"+self.lotDetails.clr+"\x26drive\x3d"+self.lotDetails.drv+"\x26keys\x3d"+self.lotDetails.hk+"\x26bodystyle\x3d"+self.lotDetails.bstl+"\x26fuel\x3d"+self.lotDetails.ft+"\x26saletype\x3ds1\x26"+"\x26buyitnow\x3d "+(self.dynamiclotDetails.buyTodayFlag=="Y"||false)+"\x26salestatus\x3d"+self.locale.messages["lotdetail.bidStatus."+
self.dynamiclotDetails.bidStatus]+"\x26acv\x3d"+self.lotDetails.la+"\x26repaircost\x3d "+self.lotDetails.rc+"\x26saledate\x3d"+dateFilter(self.dynamiclotDetails.saleDate.date,self.saleDateFormat)+"\x26website\x3dwww.copart.com\x26_wco_replace\x3dDefault Content"};self.stateFilter=function(item){return item.type==="USA"||item.type==="CAN"};var checkConditionalReportLink=function(){try{if(self.lotDetails.vehTypDesc=="AUTOMOBILE"&&self.siteCode=="CPRTUS"&&self.lotDetails.lic.indexOf("SITE-CT")==-1&&
self.lotDetails.locCountry!="CAN"&&!self.lotDetails.offFlg&&!_.contains(self.lotIconCodes,"VIX"))self.showConditionReportLink=true}catch(e){log.error("error which computing conditional report link flag"+e)}};var containsElementInArray=function(inputArray,value){for(var index=0;index<inputArray.length;index++)if(inputArray[index]===value)return true;return false};init();self.bidIncrementGuidelinesModal=function(){$("#bidIncrementGuidelinesModal").modal("show")};self.lotDescriptionModal=function(){$("#lotDescriptionModal").modal("show")};
self.showAdditionalLotNotes=function(){var successCallBack=function(response){self.additionalLotNotes=response.lotNotes};dataServiceG2.getAdditionalLotNotes(self.lotNumber,successCallBack);$("#showAdditionalLotNotes").modal("show")}}]);
app.controller("locationsListController",["$scope","$http","$locale","dataServiceG2","localStorageService","$location","userService",function($scope,$http,$locale,dataServiceG2,localStorageService,$location,userService){var self=$scope;self.locationsList=null;self.location={};self.usaAvailable=true;self.regions=[];self.location.primaryCountry="usa";self.location.selectedRegion="NORTH_AMERICA";self.location.primaryContinent="NORTH_AMERICA";self.userConfig=userService.userConfig;localStorageService.remove("_continentVal");
self.isAnonymous=userService.isAnonymous();var deviceAgent=navigator.userAgent.toLowerCase();var ipad=deviceAgent.match(/(ipad)/);var iphone=deviceAgent.match(/(iphone)/);self.init=function(){getRegionList()};var getRegionList=function(){dataServiceG2.getRegions(function(response){self.regions=response.data.continents;self.location.selectedRegion=$location.search().region||response.data.primaryContinent;self.location.primaryCountry=response.data.primaryCountry;self.getYardLocations(self.location.selectedRegion)})};
self.getYardLocations=function(continent){self.countryList=[];if(continent==self.location.primaryContinent)if(self.location.primaryCountry=="can")self.countryList.push(self.location.primaryCountry);else self.countryList.push("usa");if(continent=="NORTH_AMERICA"){self.finalList=[];dataServiceG2.getLocationsList(continent,function(response){var countries=response.data.countries;for(var countryCode in countries){self.yardStates=_.chain(countries[countryCode]).groupBy("yardStateName").map(function(value1,
key1){return{yardStateName:key1.toUpperCase(),yardNumbers:_.chain(value1).groupBy("yardName").map(function(value2,key2){return{yardNumber:value2[0].yardNumber,openNewTab:value2[0].openNewTab,baseUrl:value2[0].baseUrl,yardName:_.pluck(value2,"yardName").toString(),yardCity:key2}}).value()}}).value();self.yardStates=_.sortBy(self.yardStates,function(num){return num.yardStateName});var listOfStates=[];var lengthOfStates=self.yardStates.length;self.finalList[countryCode]={};self.countryList.push(countryCode);
self.finalList[countryCode].list=self.yardStates;if(countryCode=="can"){self.finalList[countryCode].rowClass=[];self.finalList[countryCode].regionClass=[];if(iphone||ipad)self.finalList[countryCode].cellClass=[""];else self.finalList[countryCode].cellClass=["col-sm-12 loc-layout can-list"];self.finalList[countryCode].countryName=self.locale.messages["locations.label.CANADA"]}else{self.finalList[countryCode].rowClass=["state-location"];self.finalList[countryCode].regionClass=["location-region","north-america"];
if(iphone||ipad)self.finalList[countryCode].cellClass=[];else self.finalList[countryCode].cellClass=["col-sm-12 loc-layout"];self.finalList[countryCode].countryName=self.locale.messages["locations.label.US"]}if(iphone)self.finalList[countryCode].cellStyle={"float":"left","width":"100%"};else if(ipad)self.finalList[countryCode].cellStyle={"float":"left","width":"20%"}}self.countryList=_.uniq(self.countryList)})}else if(continent=="EUROPE"||continent=="MIDDLE_EAST")dataServiceG2.getLocationsList(continent,
function(response){var countries=response.data.countries;self.otherCountries=[];for(var countryCode in countries){var countryList=_.chain(countries[countryCode]).groupBy("yardName").map(function(value1,key1){return{yardName:key1,yardNumber:value1[0].yardNumber}}).value();var sortedCountryList=_.sortBy(countryList,function(num){return num.yardName});self.otherCountries[countryCode]=sortedCountryList}});self.stateVisible=function(){self.showState=!showState}};self.init()}]);
app.controller("locationDetailController",["$scope","$http","$locale","$routeParams","dataServiceG2","auctionsCalendarService","localStorageService","$rootScope","$filter","copartUser","userService",function($scope,$http,$locale,$routeParams,dataServiceG2,auctionsCalendarService,localStorageService,$rootScope,$filter,copartUser,userService){var self=$scope;self.yardNumber=$routeParams.yardNumber;self.locationDetail=null;self.saleTime=null;self.userConfig=copartUser.getUserConfig();self.timeZoneAbbr=
moment().tz(self.userConfig.selectedTimezone).format("z");self.locDetParentFragment="Content/us/en/locations/location-"+self.yardNumber+".html";self.isAnonymous=userService.isAnonymous();var yardNumberArray=[2,9,10,11,12,41,47,50,54,57,59,61,68,97];if(yardNumberArray.indexOf(parseInt(self.yardNumber))>-1)self.displayAdYard=true;auctionsCalendarService.todayAuctionsByYard(self.yardNumber).then(function(auctionList){self.todaysAuctionList=auctionList;self.liveAuctionList=_.filter(self.todaysAuctionList,
function(num){return num.closedFlag=="I"});self.laterAuctionList=_.filter(self.todaysAuctionList,function(num){return num.closedFlag=="N"})});auctionsCalendarService.laterAuctionsByYard(self.yardNumber).then(function(auctionList){self.upcomingAuctionList=auctionList});dataServiceG2.getLocationDetail(self.yardNumber,function(response){self.locationDetail=response.data;if("IRL"==self.locationDetail.yardCountryCode){self.locationDetail.yardZip="R14 YK37";self.locationDetail.yardMailingZip="R14 YK37"}self.navigationAddress=
self.locationDetail.yardAddress1+" "+self.locationDetail.yardAddress2+" "+self.locationDetail.yardCity+" "+self.locationDetail.yardStateName+" "+self.locationDetail.yardZip;if("ARE"==self.locationDetail.yardCountryCode||"BHR"==self.locationDetail.yardCountryCode||"OMN"==self.locationDetail.yardCountryCode)self.navigationAddress="Copart "+self.locationDetail.yardCity+" "+self.locationDetail.yardStateName;$rootScope.$emit("location-fetched",self.locationDetail);self.saleTime=self.locationDetail.saleTime.toString();
self.saleTimeDisplay=$filter("convert24hrsTo12hrs")(self.saleTime);localStorageService.set("_continentVal",self.locationDetail.yardContinentCode);var yardName;try{yardName=appInit.regionCode!="us"?self.locationDetail.yardName:self.locationDetail.yardName.substring(5,self.locationDetail.yardName.length);yardName=yardName+" "+self.locationDetail.yardMailingStateName}catch(e){console.log(e)}$rootScope.$emit("meta-args-update",{yardName:yardName,yardAddress:self.locationDetail.yardAddress1+", "+self.locationDetail.yardCity+
", "+self.locationDetail.yardMailingStateName})});auctionsCalendarService.getLanesListForLiveYard(self.yardNumber).then(function(laneList){self.liveAuctionLaneList=laneList})}]);
app.controller("VehicleAlertsController",["$scope","dataServiceG2","vehicleFactory","$routeParams","$location",function($scope,dataServiceG2,vehicleFactory,$routeParams,$location){var self=$scope;self.locale=$scope.$parent.locale;self.vehicleAlertVO=new VehicleAlertVO;self.invalidYears=false;self.isError=null;self.signupStatus="fillDetails";self.wlWaiting=false;self.formSubmitted=false;self.disableMake=true;self.functionality=$routeParams.subscribe;self.init=function(){self.vehicleAlertVO.typeOfVehicle=
"V";self.vehicleAlertVO.yearFrom=self.appConfig.searchYears[11].code!==undefined?self.appConfig.searchYears[11].code:"2006";self.vehicleAlertVO.yearTo=self.appConfig.searchYears[0].code!==undefined?self.appConfig.searchYears[0].code:"2017";self.vehicleAlertVO.frequency="Daily"};if(self.functionality=="UnSubscribeVehicleAlert"){self.signupStatus="inProgress";self.wlWaiting=true;var subscriberKey=$location.search().SubscriberKey;dataServiceG2.unsubscribeVehicleAlerts(subscriberKey,function(response){var responseCode=
response.errorMsg;var responseCodeDesc=response.returnCodeDesc;if(response.returnCodeDesc!=="undefined"&&response.returnCodeDesc=="Success"){self.signupStatus="fillDetails";self.isError=false;self.errorDesc=self.locale.getMessage("app.vehicle.signup.alert.successMsg")}else{self.signupStatus="Failure";self.isError=true;self.errorDesc=self.locale.getMessage("app.vehicle.signup.alert.failureMsg")}self.wlWaiting=false})}else if(self.functionality=="EditVehicleAlert"){self.signupStatus="inProgress";self.wlWaiting=
true;var subscriberKey=$location.search().SubscriberKey;dataServiceG2.editVehicleAlerts(subscriberKey,function(response){var responseCode=response.errorMsg;var responseCodeDesc=response.returnCodeDesc;if(response.returnCodeDesc!=="undefined"&&response.returnCodeDesc=="Success"){self.vehicleAlertVO=response.data.vehicleAlerts;if(self.vehicleAlertVO.makeOfVehicle!==undefined&&self.vehicleAlertVO.makeOfVehicle!=="")self.disableMake=false;self.signupStatus="fillDetails";self.isError=false;self.errorDesc=
self.locale.getMessage("app.vehicle.signup.alert.successMsg")}else{self.signupStatus="Failure";self.isError=true;self.errorDesc=self.locale.getMessage("app.vehicle.signup.alert.failureMsg")}self.wlWaiting=false})}self.signUpForAlerts=function(){if(!validateForm()){self.formSubmitted=true;return}self.signupStatus="inProgress";self.wlWaiting=true;dataServiceG2.signUpForVehicleAlerts(self.vehicleAlertVO,function(response){var responseCode=response.errorMsg;var responseCodeDesc=response.returnCodeDesc;
if(response.returnCodeDesc!=="undefined"&&response.returnCodeDesc=="Success"){self.signupStatus="Success";self.isError=false;self.errorDesc=self.locale.getMessage("app.vehicle.signup.alert.successMsg")}else{self.signupStatus="Failure";self.isError=true;self.errorDesc=self.locale.getMessage("app.vehicle.signup.alert.failureMsg")}self.wlWaiting=false})};function validateForm(){if(self.vehicleAlertVO.typeOfVehicle==undefined||self.vehicleAlertVO.makeOfVehicle==undefined||self.vehicleAlertVO.yearFrom==
undefined||self.vehicleAlertVO.yearTo==undefined||self.vehicleAlertVO.firstName==undefined||self.vehicleAlertVO.lastName==undefined||self.vehicleAlertVO.email==undefined)return false;return true}self.clickMe=function(){self.vehicleAlertVO.yearFrom=self.appConfig.searchYears[11].code};self.validateYears=function(form){if(self.vehicleAlertVO.yearFrom>self.vehicleAlertVO.yearTo){self.invalidYears=true;$scope.vehicleAlertsForm.yearFrom.$setValidity("invalid",false)}else{$scope.vehicleAlertsForm.yearFrom.$setValidity("invalid",
true);self.invalidYears=false}};$scope.greaterThan=function(prop,val){return function(item){return item.code>val}};$scope.lessThan=function(prop,val){return function(item){return item.code<val}};self.init();self.getModels=function(appConfig){}}]);
app.controller("paymentsDueController",["$scope","$http","$location","dataServiceG2","$compile","$filter","$route","copartUser","appConfigService","backToLinkService","saveLotNumbersService","paymentService","dataTableConfig","$window","localStorageService","$timeout","siteCatalyst",function($scope,$http,$location,dataServiceG2,$compile,$filter,$route,copartUser,appConfigService,backToLinkService,saveLotNumbersService,paymentService,dataTableConfig,$window,localStorageService,$timeout,siteCatalyst){var self=
$scope;self.selectedCurrency=copartUser.getUserConfig().currencyCode;self.selectedInvoices={};self.siteCode=copartUser.getUserConfig().siteCode;self.isPayOnline=copartUser.getUserConfig().isPayOnline;if(self.siteCode==="CPRTCA"){self.selectedCurrency="CAD";self.otherCurrency="USD"}else if(self.siteCode==="CPRTUS"){self.selectedCurrency="USD";self.otherCurrency="CAD"}var selectedTimezone=copartUser.getUserConfig().selectedTimezone;var date=moment().tz(selectedTimezone).format("YYYY MMMM DD");self.exportFileName=
"PaymentsDue_"+date+".csv";self.table="#paymentDueDataTable";self.totalDues=-1;self.showInvoiceConfirmation=false;self.showInvoiceProcessing=false;self.locale=$scope.$parent.locale;self.loadedFirstTime=false;self.showBidderColumn=false;self.showCheckboxColumn=false;self.yardDetails={};self.disabledPaymentButton=true;self.disabledRemoveButton=true;self.paymentConfirmButtonStatus=false;self.selectedEstimate=null;self.bidders={};self.images={};self.ccmaxLimit=appConfigService.getAppConfig().ccMaxLimit[0].code;
self.backToLink=$location.url();backToLinkService.setBackToLink(self.backToLink);backToLinkService.setBackToLinkText("paymentdue.invoice.backurl.text");self.buyerForCCPay=0;self.estimates={};self.availableFundAmount=[];self.currentEstimatesList=[];self.wuMaxLimit=0;self.wuInvoiceCount=0;self.showImage=localStorageService.get("show-image")!=null?localStorageService.get("show-image"):false;var wuLimitRemaining=0;var wuEndPointUrl="";var wuServiceId="";var wuClientId="";var showWUInfoPopUp=true;if(_.contains(self.userConfig.roles,
"ROLE_BROKER")||_.contains(self.userConfig.roles,"ROLE_MASTER"))self.showBidderColumn=true;if(copartUser.getUserConfig().siteCode!="CPRTMEA"&&copartUser.getUserConfig().siteCode!="CPRTIE")self.showCheckboxColumn=true;self.estimates.selectedCurrency=self.selectedCurrency;self.init=function(refreshData){dataServiceG2.loadPaymentDueData(self.selectedCurrency,function(result){if(result.returnCode==1){var paymentTypesList=result.data.paymentTypesList;self.preferredPaymentType=result.data.preferredPaymentType;
self.setInitData(result);_.each(paymentTypesList,function(paymentMethod){if(paymentMethod.paymentType=="U"){paymentMethod.paymentDesc=self.locale.messages["paymentDue.paymentType."+paymentMethod.paymentType]+" "+paymentMethod.buyerNumber+"-"+paymentMethod.buyerName;self.availableFundAmount[paymentMethod.buyerNumber]=paymentMethod.availableFund}else paymentMethod.paymentDesc=self.locale.messages["paymentDue.paymentType."+paymentMethod.paymentType]});self.paymentTypesList=paymentTypesList;if(!self.selectedPaymentMethod){var preferredPaymentType=
_.filter(self.paymentTypesList,function(item){return item.paymentType===result.data.preferredPaymentType.code&&item.buyerNumber===result.data.preferredPaymentType.type});self.selectedPaymentMethod=preferredPaymentType.length>0?preferredPaymentType[0]:self.paymentTypesList[0]}else{var selectedPaymentType=_.filter(self.paymentTypesList,function(item){return item.paymentType===self.selectedPaymentMethod.paymentType&&item.buyerNumber===self.selectedPaymentMethod.buyerNumber});self.selectedPaymentMethod=
selectedPaymentType[0]}var paymentType=$location.search().paymentMethod;var currency=$location.search().currency;if(paymentType){var selectedPaymentType=_.filter(self.paymentTypesList,function(item){return item.paymentType===paymentType});self.selectedPaymentMethod=selectedPaymentType[0]}if(!self.selectedPaymentMethod)self.selectedPaymentMethod=self.preferredPaymentType;if(self.paymentTypesList&&self.paymentTypesList.length==0){self.availableFundAmount[self.userConfig.buyerNumber]=0;self.noAvailableFundAmountError=
true;self.selectedPaymentMethod.buyerNumber=self.userConfig.buyerNumber;self.errorMessage="paymentdue.noAvailableFundAmount.Error";if(self.siteCode=="CPRTMEA"||self.siteCode=="CPRTIE")self.showErrorMessage=false;else self.showErrorMessage=true}self.enablePayAllButton();self.estimates.selectedPaymentMethod=self.selectedPaymentMethod.paymentType;if(result.data.epayTermAndConditions=="Y")$("#epayTermAndCond").modal("show");if(!refreshData){self.loadInvoices();self.initInvoiceConfirmDatatable()}else self.reloadPaymentTable(self.selectedPaymentMethod)}else{var error=
self.locale.messages[result.data.errorObject];if(error)self.errorMessage=result.data.errorObject;else self.errorMessage="error.proc.defaultMessage";self.showErrorMessage=true}})};self.init(false);self.setInitData=function(result){self.epayFundsLimit=result.data.epayFundsLimit;self.epayFundsLimitCalculation=self.epayFundsLimit;self.wuMaxLimit=result.data.wuMaxLimit;wuLimitRemaining=result.data.wuMaxLimit;wuEndPointUrl=result.data.wuEndPointUrl;wuServiceId=result.data.wuServiceId;wuClientId=result.data.wuClientId;
wuServiceId=result.data.wuServiceId};self.acceptEpayTerms=function(){dataServiceG2.acceptEpayTerms(function(result){if(result.returnCode==1){$("#epayTermAndCond").modal("hide");self.init(true)}else self.showEpayErrorMessage=true})};self.getPaymentLimit=function(paymentLimit){var table=$(self.table).dataTable();jQuery(table.fnGetNodes()).find(":checkbox:checked").each(function(){var rowIndex=table.fnGetPosition(jQuery(this).closest("tr")[0]);var aData=table.fnGetData(rowIndex);paymentLimit=paymentLimit-
aData.amountDue});return paymentLimit};self.payAllInvoices=function(){$("#chkSelectAll").prop("checked",true);self.selectAllCheckBox();var invoicesSelected=$(".invoiceId:checked").size();if(invoicesSelected>=1)self.confirmInvoices()};self.enablePayAllButton=function(){self.disabledPayAllButton=self.selectedPaymentMethod.paymentType=="U"?false:true};self.selectAllCheckBox=function(){var checked_status=$("#chkSelectAll").is(":checked");$(".invoiceId").not(":disabled").prop("checked",checked_status);
if(self.selectedPaymentMethod.paymentType=="P")if(checked_status){$(".invoiceId").not(":disabled").each(function(){var value=this.checked?$(this).data("item"):"";$(".invoiceId").not(".invoiceId[data-item\x3d"+value+"]").attr("disabled",true);$(".invoiceId").not(".invoiceId[data-item\x3d"+value+"]").prop("checked",false);return false});self.ccmaxLimit=self.getPaymentLimit(self.ccmaxLimit);if(self.ccmaxLimit<=0)$("#paymentLimit").modal("show")}else{self.ccmaxLimit=appConfigService.getAppConfig().ccMaxLimit[0].code;
self.ccmaxLimit=self.getPaymentLimit(self.ccmaxLimit)}if(self.selectedPaymentMethod.paymentType=="G")if(checked_status){var selectedInvoiceCount=$(".invoiceId:checked").size();if(selectedInvoiceCount>15){$("#westernUnionInvoice").modal("show");return}wuLimitRemaining=self.getPaymentLimit(self.wuMaxLimit);if(wuLimitRemaining<=0)$("#paymentLimit").modal("show")}else wuLimitRemaining=self.getPaymentLimit(self.wuMaxLimit);self.enablePaymentButton()};self.selectAllCheckBoxPayConfirm=function(lotNumber){var checked_status=
$("#chkSelectAllPayConfirm").is(":checked");$(".invoiceIdPayConfirm").not(":disabled").prop("checked",checked_status)};self.initInvoiceConfirmDatatable=function(){var oTableDest=$("#paymentDueConfirmTable").dataTable({"iDisplayLength":1E4,"bLengthChange":false,"bFilter":false,"aaSorting":[[0,"asc"]],"responsive":{details:{type:"column",target:-1,renderer:function(api,rowIdx,columns){var data=$.map(columns,function(col,i){return col.hidden?'\x3cli data-dt-row\x3d"'+col.rowIndex+'" data-dt-column\x3d"'+
col.columnIndex+'"\x3e'+'\x3cspan\x3e\x3cspan class\x3d"bold" data-uname\x3d"saleslistRegion"\x3e'+col.title+": "+'\x3c/span\x3e\x3cspan class\x3d"dtr-data"\x3e'+col.data+"\x3c/span\x3e\x3c/span\x3e"+"\x3c/li\x3e":""}).join("");return data?$("\x3cul/\x3e").append(data):false}}},"columnDefs":[{className:"control",orderable:false,targets:-1},{"targets":[0,1,2,3,4,5],"data":null,"defaultContent":""}],"oLanguage":{"sZeroRecords":"No matching records found"},"columns":[{"mData":"saleDate","render":function(data,
type,row){var saleDate=moment(row["saleDate"],"YYYYMMDD");var defualtDateFormat=self.userConfig.dateFormat.toUpperCase();return saleDate.format(defualtDateFormat)}},{"mData":"id","sClass":"nowrap"},{"mData":"yardName","render":function(data,type,row){if(row["yn"]==655||row["yn"]==700||row["yn"]==400)return row["yname"];var html="\x3ca class\x3d'cursor-pointer' href\x3d'./locationDetail/"+row["yn"]+"' target\x3d'_blank'\x3e"+"\x3cspan\x3e"+row["yname"]+"\x3c/span\x3e\x3c/a\x3e";return html}},{"mData":"description"},
{"mData":"lfd","render":function(data,type,row){var lfd=row["lfd"];if(lfd&&lfd>0){var leftFacilityDate=moment(lfd,"YYYYMMDD");var defualtDateFormat=self.userConfig.displayPref.dateFormat.toUpperCase();return leftFacilityDate.format(defualtDateFormat)}else return""}},{"mData":"amountDue","sClass":"nowrap","name":"amountDue","render":function(data,type,row){var invoiceAmount=$filter("globalize_currency_using_code")(data,self.selectedCurrency,2);return invoiceAmount}},{"mData":"id","render":function(data,
type,row){if(row["amountDue"]>0&&!row["pastDue"])return'\x3cinput  class\x3d"invoiceIdPayConfirm" type\x3d"checkbox" value\x3d"'+row["id"]+'" ng-change\x3d"updateRemoveButton()" ng-model\x3d"selectedInvoices['+row["id"]+']"\x3e';else return'\x3cinput  type\x3d"checkbox" style\x3d"display:none" value\x3d"'+row["id"]+'"\x3e'}},{"mData":"id","render":function(data,type,row){return""}}]})};self.updateRemoveButton=function(){var table=$("#paymentDueConfirmTable").dataTable();var selectedItems=jQuery(table.fnGetNodes()).find(":checkbox:checked").length;
if(selectedItems>0)self.disabledRemoveButton=false;else self.disabledRemoveButton=true};self.resetDefaultValues=function(){self.epayFundsLimitCalculation=self.epayFundsLimit;self.ccmaxLimit=appConfigService.getAppConfig().ccMaxLimit[0].code;wuLimitRemaining=self.getPaymentLimit(self.wuMaxLimit)};self.changeCurrency=function(){self.otherCurrency=[self.selectedCurrency,self.selectedCurrency=self.otherCurrency][0];self.init(true)};var table=new ServersideDatatable_DB(saveLotNumbersService,dataTableConfig);
self.loadInvoices=function(){var backto=self.backToLink;saveLotNumbersService.clearAll();var dataTableOptions={"pageLength":1E4,"backToTop":false,"recalculateTableWidth":true,"columnDefs":[{"targets":[0,1,2,3,4,5,6,7,8,9,10,11],"data":null,"defaultContent":""},{"targets":["imagePath","id","transport"],"orderable":false},{"targets":["id"],"visible":self.showCheckboxColumn,"searchable":false},{"targets":["bidderId"],"visible":self.showBidderColumn,"searchable":false},{"targets":["imagePath"],"visible":false,
"searchable":false},{"targets":["transport"],"visible":false,"searchable":false},{className:"control",orderable:false,targets:-1}],"lengthMenu":[[20,25,50,100],[20,25,50,100]],"url":"/data/payments/getDueInvoiceList/"+self.selectedPaymentMethod.paymentType+"/"+self.selectedCurrency,"containsFilters":false,"columns":[{"mData":"id","render":function(data,type,row){return self.applyPaymentRules(row)}},{"mData":"imgp","sClass":"compile","name":"imagePath","render":function(data,type,row,meta){var imgLink=
row["imgp"];if(row["imgp"]&&row["imgp"].trim()!=""&&row["lotNumber"]>0){var resultIndex=saveLotNumbersService.getResultIndex(row["lotNumber"]);var link="";link="\x3ca class\x3d'imgpath cursor-pointer' lot-id\x3d'"+row["lotNumber"]+"' lot-desc\x3d'"+row["description"]+"' images\x3d'images' "+"hide-watch-btn\x3dtrue modal-image-viewer result-index\x3d"+resultIndex+" check-yard-exist\x3dtrue yard-number\x3d'"+row.yn+"'\x3e"+"\x3cspan class\x3d'searchiconbtn'\x3e\x3c/span\x3e\x3cimg alt\x3d'image' height\x3d'72' width\x3d'96' class\x3d'img-icon' src\x3d'/images/testImages/no_photo.jpg'  o-data-src\x3d '"+
imgLink+"'error-image\x3d'/images/testImages/no_photo.jpg'\x3e\x3c/a\x3e\x3cbr\x3e";link+="\x3cdiv class\x3d'viewallphotos'\x3e\x3ca ng-href\x3d'' ng-click\x3d\"checkYardExist("+row["yn"]+",'"+row.lotNumber+"',"+resultIndex+",true)\" class\x3d'image_viewer_link'  data-lotDesc\x3d'"+row["lotNumber"]+"' data-lot\x3d'"+row["lotNumber"]+"'\x3e"+self.locale.messages["counterman.searchResults.viewAllPhotos.label"]+"\x3c/a\x3e\x3c/div\x3e";return link}else return"\x3cimg alt\x3d'image' height\x3d'72' width\x3d'96' class\x3d'' src\x3d '/images/testImages/no_photo.jpg'\x3e\x3c/a\x3e"}},
{"mData":"saleDate","sClass":"nowrap","render":function(data,type,row){var saleDate=moment(row["saleDate"],"YYYYMMDD");var defualtDateFormat=self.userConfig.dateFormat.toUpperCase();return saleDate.format(defualtDateFormat)}},{"mData":"bid"},{"mData":"itemNumber","sClass":"nowrap","render":function(data,type,row){return row["itemNumber"]>0?row["itemNumber"]:""}},{"mData":"lotNumber","sClass":"nowrap","render":function(data,type,row,meta){var resultIndex=saveLotNumbersService.getResultIndex(row["lotNumber"]);
if(row["lotNumber"]>0){saveLotNumbersService.addLotNumber(row["lotNumber"]);return'\x3ca class\x3d"lotNumberAnchor" ng-href\x3d"" ng-click\x3d\'checkYardExist('+row["yn"]+',"'+row["lotNumber"]+'",'+resultIndex+")'\x3e"+row["id"]+"\x3c/a\x3e"}else return row["id"]}},{"mData":"yardName","render":function(data,type,row){var html="";if(row["yn"]==655||row["yn"]==700||row["yn"]==400)html=row["yname"];else html="\x3ca class\x3d'cursor-pointer' href\x3d'./locationDetail/"+row["yn"]+"' target\x3d'_blank'\x3e"+
"\x3cspan\x3e"+row["yname"]+"\x3c/span\x3e\x3c/a\x3e";return html}},{"mData":"description"},{"mData":"vin","render":function(data,type,row){var vin=row["vin"];if(copartUser.getUserConfig().companyCode=="COPARTUK")vin=$filter("limitTo")(row["vin"],11,0);return vin}},{"mData":"ownerTitleType"},{"mData":"bidAmount","render":function(data,type,row){var bidAmount=$filter("globalize_currency_using_code")(data,row["cur"],2);return bidAmount}},{"mData":"invoiceAmount","render":function(data,type,row){var invoiceAmount=
$filter("globalize_currency_using_code")(data,row["cur"],2);var payType=self.selectedPaymentMethod.paymentType;var invType=self.userConfig.companyCode=="COPART"?"INVOICE":"RECEIPT";if(payType==undefined)payType="P";var invoiceNumber=row["lotNumber"]==0?row["id"]:row["lotNumber"];if(row["description"].toUpperCase().indexOf("RELIST")>=0)invoiceNumber=row["id"];return'\x3ca ng-href\x3d"./invoiceDetails/'+invoiceNumber+"/"+payType+"/"+row["cur"].trim()+"/"+invType+"/"+row["lotNumber"]+'"\x3e'+invoiceAmount+
"\x3c/a\x3e"}},{"mData":"amountDue","name":"amountDue","render":function(data,type,row){var due=$filter("globalize_currency_using_code")(data,row["cur"],2);return due}},{"mData":"lfd","render":function(data,type,row){var lfd=row["lfd"];if(lfd&&lfd>0){var leftFacilityDate=moment(lfd,"YYYYMMDD");var defualtDateFormat=self.userConfig.displayPref.dateFormat.toUpperCase();return leftFacilityDate.format(defualtDateFormat)}else return""}},{"mData":"lly","name":"transport","sClass":"compileEstimates","render":function(data,
type,row){if(row["lotNumber"]==row["id"])return"\x3cspan  request-Type\x3d'QUOTE' lot-id\x3d'"+row["lotNumber"]+"'  invoice-id\x3d'"+row["id"]+"' estimates\x3d'estimates' current-estimates-List\x3d'currentEstimatesList'  transportaion-estimates\x3e";else return""}},{"mData":"","render":function(data,type,row){return""}}]};table.initServerSideDataTable(self.table,dataTableOptions,function(){self.setTotalInvoices(self.table);self.setBrokerBidders();self.compileDom(self.table);self.showWesturnUnionInfo()})};
self.setBrokerBidders=function(){if(!self.loadedFirstTime){var oTable=$(self.table).DataTable();var data=oTable.rows().data();var bidders=_.groupBy(data,function(value){return value.bid});self.bidderList=_.map(bidders,function(group){return{bidderId:group[0].bid,bidderName:group[0].bname,invoiceCount:group.length}});self.loadedFirstTime=true}};self.compileDom=function(table){var $dest=jQuery(table).find("tbody");var retn=$compile($dest)($scope);$scope.safeApply();self.enablePaymentButton();if(self.selectedPaymentMethod.paymentType==
"P"||self.selectedPaymentMethod.paymentType=="G"){$(".invoiceId:checkbox:checked").each(function(){var value=this.checked?$(this).data("item"):"";$(".invoiceId").not(".invoiceId[data-item\x3d"+value+"]").attr("disabled",true)});self.ccmaxLimit=self.getPaymentLimit(self.ccmaxLimit);wuLimitRemaining=self.getPaymentLimit(self.wuMaxLimit)}jQuery("#paymentDueDataTable").on("order.dt",function(){self.resetDefaultValues()}).DataTable();if(self.showImage){$("#hideImg").attr("checked",true);self.showImages()}jQuery("#paymentDueDataTable").on("search.dt",
function(){self.resetDefaultValues()}).DataTable();if(self.showImage){$("#hideImg").attr("checked",true);self.showImages()}};self.applyPaymentRules=function(row){if(row["amountDue"]>0){var checked=false;var disabled=true;var visible=true;var showCheckBox=true;var fundingStatus="";if(row["fundingStatus"]&&row["fundingStatus"].trim().length)if(self.selectedPaymentMethod.paymentType=="F"){showCheckBox=false;fundingStatus=row["fundingStatus"]}if(self.selectedPaymentMethod.paymentType=="O")if(self.epayFundsLimitCalculation>
0&&self.epayFundsLimitCalculation>=row["amountDue"])if(row["pastDue"]){checked=true;visible=true;disabled=true;self.epayFundsLimitCalculation=self.epayFundsLimitCalculation-row["amountDue"]}else{checked=false;visible=true;disabled=false}else if(row["pastDue"]){visible=false;checked=false;disabled=true}else{visible=true;disabled=true;checked=false}if(self.selectedPaymentMethod.paymentType=="F")if(row["pastDue"]){checked=true;disabled=true}else{checked=false;disabled=false}else if(self.selectedPaymentMethod.paymentType==
"U"){var buyerNumber=self.selectedPaymentMethod.buyerNumber;if(buyerNumber==row["bid"])if(row["pastDue"]){var checked=true;var disabled=true}else{if(row["lotNumber"]<=0)checked=true;else checked=false;disabled=false}else{checked=false;disabled=true;visible=false}}else if(self.noAvailableFundAmountError)if(row["pastDue"]){var checked=true;var disabled=true}else{checked=false;disabled=true}else if(self.selectedPaymentMethod.paymentType=="P"||self.selectedPaymentMethod.paymentType=="G"){if(row["pastDue"]){checked=
true;disabled=true;if(self.buyerForCCPay==0)self.buyerForCCPay=row["bid"];if(self.selectedPaymentMethod.paymentType=="G")self.wuInvoiceCount++}else{checked=false;disabled=false}if(self.buyerForCCPay&&self.buyerForCCPay!=row["bid"]){disabled=true;checked=false}}if(showCheckBox){var hidden=visible==true?"":"style\x3ddisplay:none";return'\x3cinput class\x3d"invoiceId" id\x3d"'+row["id"]+'"'+'ng-click\x3d"enablePaymentButton(false); checkPaymentLimits('+row["id"]+","+row["amountDue"]+');"'+'data-item\x3d"'+
row["bid"]+'" type\x3d"checkbox" value\x3d"'+row["id"]+'" ng-checked\x3d"'+checked+'"  ng-disabled\x3d"'+disabled+'"'+hidden+"\x3e"}else return'\x3ca ng-href\x3d"" ng-click\x3d"showDSCPaymentStatus(\''+fundingStatus+"')\"\x3e"+fundingStatus+"\x3c/a\x3e"}else return""};self.showDSCPaymentStatus=function(status){self.fundingStatus=status.trim();$("#fundingStatus").modal("toggle")};self.checkPaymentLimits=function(checkBoxId,amount){if(self.selectedPaymentMethod.paymentType=="P"||self.selectedPaymentMethod.paymentType==
"G"){var table=$(self.table).DataTable();$(self.table+" tbody").unbind("click").on("click","tr",function(){var seletedRow=table.row(this).data();var seletedBidder=seletedRow.bid;table.rows().eq(0).each(function(index){var row=table.row(index);var data=row.data();if(seletedBidder!=data.bid)$("#"+data.id).attr("disabled",true);else if(!data.pastDue)$("#"+data.id).attr("disabled",false)});var invoicesSelected=$(".invoiceId:checked").size();if(invoicesSelected<1)$(".invoiceId").attr("disabled",false)});
if(self.selectedPaymentMethod.paymentType=="P"){if(jQuery("#"+checkBoxId).is(":checked"))self.ccmaxLimit=self.ccmaxLimit-amount;else self.ccmaxLimit=self.ccmaxLimit+amount;if(self.ccmaxLimit<=0){$("#"+checkBoxId).prop("checked",false);self.ccmaxLimit=self.ccmaxLimit+amount;$("#paymentLimit").modal("show")}}if(self.selectedPaymentMethod.paymentType=="G"){var selectedInvoiceCount=$(".invoiceId:checked").size();if(jQuery("#"+checkBoxId).is(":checked"))wuLimitRemaining=wuLimitRemaining-amount;else wuLimitRemaining=
wuLimitRemaining+amount;if(wuLimitRemaining<=0||selectedInvoiceCount>15){$("#"+checkBoxId).prop("checked",false);wuLimitRemaining=wuLimitRemaining+amount;if(selectedInvoiceCount>15)$("#westernUnionInvoice").modal("show");else $("#paymentLimit").modal("show")}}}if(self.selectedPaymentMethod.paymentType=="O"){if(jQuery("#"+checkBoxId).is(":checked"))self.epayFundsLimitCalculation=self.epayFundsLimitCalculation-amount;else self.epayFundsLimitCalculation=self.epayFundsLimitCalculation+amount;if(self.epayFundsLimitCalculation<=
0){$("#"+checkBoxId).prop("checked",false);self.epayFundsLimitCalculation=self.epayFundsLimitCalculation+amount;$("#paymentLimit").modal("show")}}};self.setTotalInvoices=function(tableId){self.totalDues=0;self.totalInvoices=0;var oTable=$(tableId).DataTable();oTable.column("amountDue:name").data().each(function(value,index){self.totalDues+=value});self.totalDues=$filter("globalize_currency_using_code")(self.totalDues,self.selectedCurrency,2);self.totalInvoices=oTable.data().count()};self.confirmInvoices=
function(){omnitureCallWesternUnion("doTagPaymentStartedWU",self.selectedPaymentMethod.paymentType);if(self.wuInvoiceCount>15){$("#westernUnionInvoicePastDue").modal("show");return}self.paymentConfirmButtonStatus=false;var table=$(self.table).dataTable();$("#chkSelectAllPayConfirm").prop("checked",false);var paymentDueConfirmTable="#paymentDueConfirmTable";var oTableDest=$(paymentDueConfirmTable).DataTable();oTableDest.clear().draw();jQuery(table.fnGetNodes()).find(":checkbox:checked").each(function(){var rowIndex=
table.fnGetPosition(jQuery(this).closest("tr")[0]);var aData=table.fnGetData(rowIndex);oTableDest.row.add(aData)});oTableDest.draw();self.compileDomByClassName(".invoiceIdPayConfirm");self.setTotalInvoices(paymentDueConfirmTable);self.checkPartialPayment();self.showInvoiceConfirmation=true;$timeout(function(){oTableDest.columns.adjust().responsive.recalc()},0)};self.checkPartialPayment=function(){if(self.selectedPaymentMethod.paymentType=="U"){var funds=self.selectedPaymentMethod.availableFund;var fundsMessageFlag=
false;var table=$("#paymentDueConfirmTable").DataTable();self.showPartialPaymentMessage=false;table.rows().eq(0).each(function(index){var row=table.row(index);var data=row.data();funds=funds-data.amountDue;if(funds<0&&!fundsMessageFlag){fundsMessageFlag=true;self.showPartialPaymentMessageText=self.locale.getMessage("availableFund.partialPayment.message",data.id);self.showPartialPaymentMessage=true}})}};self.removeSelectedInvoices=function(){var table=$("#paymentDueConfirmTable").dataTable();jQuery(table.fnGetNodes()).find(":checkbox:checked").each(function(){table.fnDeleteRow($(this).parents("tr")[0],
false)});table.fnDraw();self.setTotalInvoices(paymentDueConfirmTable);self.enablePaymentConfirmButton();self.checkPartialPayment()};self.backPaymentDue=function(){var table=$(self.table).dataTable();self.setTotalInvoices(table);self.showInvoiceConfirmation=false;$("#chkSelectAll").prop("checked",false);self.selectAllCheckBox()};self.paySeletedInvoices=function(){omnitureCallWesternUnion("doTagSubmitPaymentWU",self.selectedPaymentMethod.paymentType);if(self.selectedPaymentMethod.paymentType=="G")self.payUsingWU();
else{self.showInvoiceProcessing=true;var table=$("#paymentDueConfirmTable").dataTable();var ids=jQuery(table.fnGetNodes()).find(":checkbox").map(function(){return this.value}).get().join(",");var payInvoicesParam={};payInvoicesParam.invoiceIds=ids;payInvoicesParam.paymentType=self.selectedPaymentMethod.paymentType;payInvoicesParam.invoiceTotal=Number(self.totalDues.replace(/[^0-9\.]+/g,""));try{var lotIds=ids.split(",");for(var i=0;i<lotIds.length;i++)lm.Omniture.doTagSelectedForPayment(lotIds[i],
self.userConfig.buyerNumber,payInvoicesParam.invoiceTotal)}catch(e){console.log("site catalyst call failed")}dataServiceG2.paySelectedInvoices(payInvoicesParam,function(result){if(result.returnCode==1){var transactionId=result.data.transactionId;if(self.selectedPaymentMethod.paymentType=="P"){var requestParam={};requestParam.transactionId=transactionId;requestParam.GATEWAY_URL_KEY="PAYMENT_DUE";requestParam.cancelCallBackUrl="paymentsDue";requestParam.successCallBackURL="paidInvoicesList/"+transactionId;
dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=response.data.pciURL.trim();else console.log("error")})}else $location.url("/paidInvoicesList/"+transactionId)}})}};self.payUsingWU=function(){var table=$("#paymentDueConfirmTable").dataTable();dataServiceG2.getContactInfo(function(response){self.accountInfoVO=response.data.contactInfoList;var servicesIds=wuServiceId.split(",");var xmldata="\x3cpaymentInformation\x3e\x3cclientId\x3e"+wuClientId+
"\x3c/clientId\x3e\x3clocale\x3een_GB\x3c/locale\x3e\x3cbuyer\x3e\x3cid\x3e"+self.userConfig.buyerNumber+"\x3c/id\x3e\x3cfirstName\x3e"+self.accountInfoVO.firstName+"\x3c/firstName\x3e\x3clastName\x3e"+self.accountInfoVO.lastName+"\x3c/lastName\x3e\x3caddress\x3e"+self.accountInfoVO.physicalAddressLine1+"\x3c/address\x3e\x3ccity\x3e"+self.accountInfoVO.city+"\x3c/city\x3e\x3cstate\x3e"+self.accountInfoVO.state+"\x3c/state\x3e\x3czip\x3e"+self.accountInfoVO.zip1+"\x3c/zip\x3e\x3ccountry\x3e"+self.accountInfoVO.country+
"\x3c/country\x3e\x3cemail\x3e"+self.accountInfoVO.email+"\x3c/email\x3e";jQuery(table.fnGetNodes()).find(":checkbox").each(function(index){var rowIndex=table.fnGetPosition(jQuery(this).closest("tr")[0]);var aData=table.fnGetData(rowIndex);xmldata=xmldata+"\x3ccustomField\x3e"+aData.id+"\x3c/customField\x3e"});xmldata=xmldata+"\x3c/buyer\x3e";jQuery(table.fnGetNodes()).find(":checkbox").each(function(index){var rowIndex=table.fnGetPosition(jQuery(this).closest("tr")[0]);var aData=table.fnGetData(rowIndex);
console.log(aData);xmldata=xmldata+"\x3cservice\x3e\x3cid\x3e"+servicesIds[index]+"\x3c/id\x3e\x3camount\x3e"+aData.amountDue+"\x3c/amount\x3e\x3c/service\x3e"});xmldata=xmldata+"\x3c/paymentInformation\x3e";console.log(xmldata);$("#payload").val(xmldata);var form=document.getElementById("PaymentAllowedForm");form.action=wuEndPointUrl;form.submit()})};self.reloadPaymentTable=function(paymentMethod){self.selectedPaymentMethod=paymentMethod;self.estimates.selectedPaymentMethod=paymentMethod.paymentType;
self.estimates.selectedScope=undefined;omnitureCallWesternUnion("doTagPaymentSelectedWU",self.selectedPaymentMethod.paymentType);var table=jQuery(self.table).DataTable();table.clear();table.ajax.url("/data/payments/getDueInvoiceList/"+self.selectedPaymentMethod.paymentType+"/"+self.selectedCurrency).load(self.resetDefaultValues(),false);$("#chkSelectAll").prop("checked",false);self.showWesturnUnionInfo();self.enablePayAllButton()};self.showWesturnUnionInfo=function(){if(self.selectedPaymentMethod.paymentType==
"G")if(showWUInfoPopUp){$("#westernUnionInfo").modal("show");showWUInfoPopUp=false}};self.print=function(){window.print()};table.overrideDefaults=function(data){if(self.bidders.bidder){var filterJSONString={filters:[]};var jsonData={};jsonData.filterBy="bidderId";jsonData.filterValue=[self.bidders.bidder];filterJSONString.filters.push(jsonData);data.filterCriteria=JSON.stringify(filterJSONString)}};self.showImages=function(){var ttable=jQuery(self.table).DataTable();var column=ttable.column("imagePath:name");
column.visible(!column.visible());if(jQuery("#hideImg").is(":checked")==false){self.showImage=false;localStorageService.set("show-image",false)}else self.showImage=true;if(self.showImage){localStorageService.set("show-image",true);var rows=ttable.rows({page:"current"}).nodes();for(var i=0;i<rows.length;i++){var image=jQuery(".img-icon",rows[i]);image.attr("src",image.attr("o-data-src"))}self.compileDomByClassName(".compile")}};self.showDelieveryEstimates=function(){var ttable=jQuery(self.table).DataTable();
var column=ttable.column("transport:name");column.visible(!column.visible());if(jQuery("#hideEstimates").is(":checked"))self.compileDomByClassName(".compileEstimates")};self.compileDomByClassName=function(className){$(className).each(function(){var value=$(this);var retn=$compile(value)($scope);self.safeApply()})};self.payAllUK=function(fromRequest){var requestParam={};requestParam.GATEWAY_URL_KEY="PAY_ALL_UK";dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=
response.data.pciURL.trim();else log.error("Error in Gateway")})};self.enablePaymentButton=function(applyChanges){var invoicesSelected=$(".invoiceId:checked").size();self.disabledPaymentButton=invoicesSelected>0?false:true;if(self.selectedPaymentMethod.paymentType=="O")if(self.epayFundsLimit<1)self.disabledPaymentButton=true;if(self.selectedPaymentMethod.paymentType=="P")if(self.ccmaxLimit<=0)self.disabledPaymentButton=true;if(self.selectedPaymentMethod.paymentType=="G")if(wuLimitRemaining<=0)self.disabledPaymentButton=
true;if(self.selectedCurrency=="CAD"){self.disabledPaymentButton=true;$(".invoiceId").attr("disabled",true)}if(self.noAvailableFundAmountError)self.disabledPaymentButton=true;if(!applyChanges&&applyChanges!=false)$scope.safeApply()};$scope.safeApply=function(fn){var phase=this.$root.$$phase;if(phase=="$apply"||phase=="$digest"){if(fn&&typeof fn==="function")fn()}else this.$apply(fn)};self.enablePaymentConfirmButton=function(){var table=$("#paymentDueConfirmTable").dataTable();var numberOfInvoices=
table.fnSettings().fnRecordsTotal();self.paymentConfirmButtonStatus=numberOfInvoices>0?false:true};$(self.table).on("click.dtr",function(e){var retn=$compile($(e.target).parent().next().find(".child"))($scope);self.$digest()});self.stateFilter=function(item){return item.type==="USA"||item.type==="CAN"};function storeNavigationInfo(resultIndex){var info={backTo:"."+$location.url(),resultIndex:resultIndex};localStorageService.set("lot-navigation-info",info)}self.checkYardExist=function(yardNumber,lotNumber,
resultIndex,viewAllPhotos){paymentService.checkYardBySiteCode(yardNumber).then(function(){storeNavigationInfo(resultIndex);var lotUrl="lot/"+lotNumber;if(viewAllPhotos)lotUrl+="/Photos";$location.url(lotUrl)},function(){paymentService.showYardNotExistModal()})};self.isUKSite=function(){var userConfig=copartUser.getUserConfig();return userConfig.siteCode=="CPRTUK"};function omnitureCallWesternUnion(eventName,paymentMethodType){if(paymentMethodType=="G"){var siteCatalystVal={};siteCatalystVal.fname=
eventName;siteCatalyst.addToQueue(eventName,siteCatalystVal);siteCatalyst.executeCall(eventName)}}self.redirect=function(){var url=$location.absUrl();var path=$location.path();url=url.replace(path,"");$window.location.href=url}}]);
app.controller("invoiceDetailsController",["$scope","$http","$location","dataServiceG2","$filter","$routeParams","backToLinkService","localStorageService","$timeout","copartUser",function($scope,$http,$location,dataServiceG2,$filter,$routeParams,backToLinkService,localStorageService,$timeout,copartUser){var self=$scope;self.locale=$scope.$parent.locale;self.invoiceId=$routeParams.invoiceId;self.paymentType=$routeParams.paymentType;self.selectedCurrency=$routeParams.selectedCurrency;self.invoiceType=
$routeParams.invoiceType==null?"":$routeParams.invoiceType;self.lotNumber=$routeParams.lotNumber==null?"":$routeParams.lotNumber;self.emailConfirmMessage=false;self.fromPaymentHistory=$routeParams.fromPaymentHistory;self.showInvoiceLoadingProcessing=false;self.backToLink=backToLinkService.getBackToLink();self.backToLinkText=backToLinkService.getBackToLinkText();self.init=function(){self.showInvoiceLoadingProcessing=true;var invoiceDetailsParam={};invoiceDetailsParam.invoiceId=self.invoiceId;invoiceDetailsParam.paymentType=
self.paymentType;invoiceDetailsParam.selectedCurrency=self.selectedCurrency;invoiceDetailsParam.invoiceType=self.invoiceType;invoiceDetailsParam.lotNumber=self.lotNumber;dataServiceG2.invoiceDetails(invoiceDetailsParam,function(result){self.showInvoiceLoadingProcessing=false;self.invoiceDetails=result.data.invoiceDetails;var documentId=result.data.documentId;if(documentId!=null&&documentId!="0"){self.invoiceId=documentId;self.invoiceType="VAT"}self.email=result.data.email?result.data.email.trim():
"";$timeout(function(){if($(window).width()<800)$("pre").contents().unwrap().wrap('\x3cdiv class\x3d"pre"/\x3e');else $("div.pre").contents().unwrap().wrap("\x3cpre /\x3e")},0)})};self.restore=function(){localStorageService.set("restore-search-state",true)};self.emailInvoice=function(){self.emailConfirmMessage=true;var emailInvoiceParam={};emailInvoiceParam.invoiceNumber=self.invoiceId;emailInvoiceParam.invoiceType=self.invoiceType;emailInvoiceParam.lotNumber=self.lotNumber;emailInvoiceParam.emailAddress=
self.email;dataServiceG2.emailInvoice(emailInvoiceParam,function(result){self.emailSend=result.returnCode==1?true:false;self.emailError=!self.emailSend})};$("#emailInvoice").on("hidden.bs.modal",function(){self.emailConfirmMessage=false;self.$apply()});self.print=function(){window.print()};self.init()}]);
app.controller("todaysAuctionController",["$scope","$http","$locale","$sce","$routeParams","initData","copartUser","userService","$compile","$location","$timeout","$cookies","dataServiceG2","auctionsCalendarService",function($scope,$http,$locale,$sce,$routeParams,initData,copartUser,userService,$compile,$location,$timeout,$cookies,dataServiceG2,auctionsCalendarService){var self=$scope;self.siteCode=copartUser.getUserConfig().siteCode;self.data={};var formatDate=function(date){if(date){var year=date.substr(0,
4);var month=date.substr(4,2);var day=date.substr(6,2);return year+"-"+month+"-"+day}};var formatSaleDate=function(date){if(date){var year=date.substr(0,4);var month=date.substr(4,2);var day=date.substr(6,2);return month+"/"+day+"/"+year}};self.joinLiveAuction=function(auction){$location.url("/auctionDashboard?auctionDetails\x3d"+auction.yardNumber+"-"+auction.lane)};self.viewSaleList=function(auction,liveAuction){var date=formatDate(auction.auctionDate.dateAsString);var dateFormat=formatSaleDate(auction.auctionDate.dateAsString);
return"./saleListResult/"+auction.yardNumber+"/"+date+"/"+auction.lane+"?location\x3d"+auction.yardName+"\x26saleDate\x3d"+auction.saleUtcDateTime+"\x26liveAuction\x3d"+liveAuction+"\x26from\x3dtodaysAuction"};self.viewAllLanesSalesList=function(auction,liveAuction){var date=formatDate(auction.auctionDate.dateAsString);var dateFormat=formatSaleDate(auction.auctionDate.dateAsString);return"./saleListResult/"+auction.yardNumber+"/"+date+"?location\x3d"+auction.yardName+"\x26saleDate\x3d"+auction.saleUtcDateTime+
"\x26liveAuction\x3d"+liveAuction+"\x26from\x3dtodaysAuction"};self.init=function(){var timeZonePrefStr=$cookies.get("copartTimezonePref");var url="/public/data/todaysAuctions?appId\x3dg2\x26copartTimezonePref\x3d"+timeZonePrefStr;self.loadingSearchResults=true;dataServiceG2.getTodayAuctionData(url,function(response){self.data.liveAuctions=response.data.saleList.liveSales;self.data.laterTodaysAuctions=response.data.saleList.laterSales;self.loadingSearchResults=false;if(null==self.data.liveAuctions||
self.data.liveAuctions.length==0)$timeout(function(){self.initializeDatatable("#auctionLiveNow-datatable")},0);else try{auctionsCalendarService.getAllAuctionData().then(function(data){_.each(data.todayAuctions.laterAuctions,function(auction){_.each(self.data.liveAuctions,function(liveAuction){if(auction.yard.number==liveAuction.yardNumber){auction.isLive=true;auction.closedFlag="I"}})});auctionsCalendarService.reGroupAuctions()})}catch(e){}if(null==self.data.laterTodaysAuctions||self.data.laterTodaysAuctions.length==
0)$timeout(function(){self.initializeDatatable("#auctionLaterToday-datatable")},0)})}();self.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){var id=null;if(!$.fn.DataTable.isDataTable("#auctionLiveNow-datatable")&&self.data.liveAuctions.length>0)id="#auctionLiveNow-datatable";else if(self.data.laterTodaysAuctions.length>0)id="#auctionLaterToday-datatable";if(null!=id)self.initializeDatatable(id)});self.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){var El1=angular.element(document.querySelector("#modal-join-auction #auctionLiveNow-datatable_wrapper .row:first-child \x3e div:first-child"));
El1.removeClass("col-sm-6");El1.addClass("col-sm-12");var El2=angular.element(document.querySelector("#modal-join-auction #auctionLaterToday-datatable_wrapper .row:first-child \x3e div:first-child"));El2.removeClass("col-sm-6");El2.addClass("col-sm-12");var El3=angular.element(document.querySelector("#modal-join-auction #auctionLiveNow-datatable_wrapper .row:first-child \x3e div:nth-child(2)"));El3.removeClass("col-sm-6");El3.addClass("col-sm-12");var El3=angular.element(document.querySelector("#modal-join-auction #auctionLaterToday-datatable_wrapper .row:first-child \x3e div:nth-child(2)"));
El3.removeClass("col-sm-6");El3.addClass("col-sm-12")});self.initializeDatatable=function(id){if(!$.fn.DataTable.isDataTable(id))self.id=$(id).DataTable({"bPaginate":false,"responsive":{details:{type:"column",target:-1}},"aaSorting":[],"language":{"emptyTable":"There are no auctions available at this time","searchPlaceholder":"Search this list"},"columnDefs":[{className:"control",orderable:false,targets:-1},{"bSortable":false,"aTargets":["sorting_disabled"]}]});else self.id.draw()}}]);
app.controller("paidInvoiceListController",["$scope","$http","$location","dataServiceG2","$filter","$routeParams",function($scope,$http,$location,dataServiceG2,$filter,$routeParams){var self=$scope;self.transactionId=$routeParams.transactionId;self.init=function(){var requestParam={};requestParam.transactionId=self.transactionId;dataServiceG2.paidInvoicesList(requestParam,function(result){if(result.returnCode==1){self.invoiceList=result.data.invoicesList;self.invoiceData=result.data.invoiceData;if(result.data.failedInvoices&&
result.data.failedInvoices.length>0)self.failedInvoices=result.data.failedInvoices.join(",");self.transactionDate=result.data.transactionDate}})};self.init()}]);
app.controller("saleReceiptController",["$scope","$http","$location","dataServiceG2","$filter","$routeParams","backToLinkService",function($scope,$http,$location,dataServiceG2,$filter,$routeParams,backToLinkService){var self=$scope;self.locale=$scope.$parent.locale;self.invoiceId=$routeParams.invoiceId;self.fromPaymentHistory=$routeParams.fromPaymentHistory;self.showSaleReceiptLoadingProcessing=false;self.backToLink=backToLinkService.getBackToLink();self.backToLinkText=backToLinkService.getBackToLinkText();
self.init=function(){self.showSaleReceiptLoadingProcessing=true;var saleReceiptParam={};saleReceiptParam.invoiceId=self.invoiceId;dataServiceG2.saleReceipt(saleReceiptParam,function(result){self.showSaleReceiptLoadingProcessing=false;self.saleReceiptDetails=result.data.saleReceiptDetails})};self.print=function(){window.print()};self.init()}]);
app.controller("registrationController",["$scope","$location","$http","$locale","$filter","dataServiceG2","appConfigService","copartUser","$q",function($scope,$location,$http,$locale,$filter,dataServiceG2,appConfigService,copartUser,$q){var self=$scope;self.personalDetails={country:{culture:"AMERICA_US"},firstName:"",lastName:"",email:"",confirmEmail:"",companyName:"",address:"",addressLine2:"",stateOrProvince:"",city:"",zipOrPostalCode:"",phoneNumber:"",phoneExtension:"",termsAndConditions:false,
physicalZip5:"",physicalZip4:""};self.cultureTemplateUrl="/public/fetchDirective.html?directive\x3dregistration/addressCultureTemplate";self.irelandCounties=["Co. Carlow","Co. Cavan","Co. Clare","Co. Cork","Co. Donegal","Co. Dublin","Co. Galway","Co. Kerry","Co. Kildare","Co. Kilkenny","Co. Laois","Co. Leitrim","Co. Limerick","Co. Longford","Co. Louth","Co. Mayo","Co. Meath","Co. Monaghan","Co. Offaly","Co. Roscommon","Co. Sligo","Co. Tipperary","Co. Waterford","Co. Westmeath","Co. Wexford","Co. Wicklow"];
self.errors={emailAlreadyExist:false,cityStateZipConbinationInvalid:false,termsAndCondtionsNotSelected:false,phoneNumber:false,specialChars:false,zipCode:false};self.validateFunc=function(errorCode){switch(errorCode){case "email.already.exists":self.errors.emailAlreadyExist=true;break;case "city.zip.combination.invalid":self.errors.cityStateZipConbinationInvalid=true;break}};self.submitTellUsAboutYouForm=function(isValid){if(self.errors.phoneNumber)return;jQuery("#registrationSubmitbutton").prop("disabled",
true);var isValidNumber=$('[name\x3d"phoneNumber"]').intlTelInput("isValidNumber");if(!self.validateZip(self.personalDetails.zipOrPostalCode))self.errors.zipCode=true;if(isValid&&self.personalDetails.termsAndConditions&&self.personalDetails.phoneNumber&&isValidNumber&&self.validateZip(self.personalDetails.zipOrPostalCode)){self.errors.zipCode=false;self.errors.emailAlreadyExist=false;self.errors.cityStateZipConbinationInvalid=false;self.errors.termsAndCondtionsNotSelected=false;var contactPhone1=
self.personalDetails.phoneNumber.replace(/[- )(\+]/g,"");contactPhone1=contactPhone1.substring(contactPhone1.length-10);if(self.personalDetails.stateOrProvince=="")appConfigService.appConfig.countryStates.forEach(function(item){if(item.type==self.personalDetails.country.code){self.personalDetails.stateOrProvince=item.code;return}});var request={physicalCountry:self.personalDetails.country.code,physicalState:self.personalDetails.stateOrProvince,firstName:self.personalDetails.firstName,lastName:self.personalDetails.lastName,
emailAddress:self.personalDetails.email,confirmationEmailAddress:self.personalDetails.confirmEmail,companyName:self.personalDetails.companyName,physicalAddress1:self.personalDetails.address,physicalAddress2:self.personalDetails.addressLine2,stateOrProvince:self.personalDetails.stateOrProvince,physicalCity:self.personalDetails.city,physicalZip:self.personalDetails.physicalZip5,contactPhoneNumber:contactPhone1.substring(3),contactPhoneExt:self.personalDetails.phoneExtension,contactPhoneAreaCode:contactPhone1.substring(0,
3),physicalZip4:self.personalDetails.physicalZip4,acceptTerms:self.personalDetails.termsAndConditions?"Y":"N"};dataServiceG2.registerNewMember(request,{onSuccess:function(responseData){if(responseData.data.errorCode){jQuery("#registrationSubmitbutton").prop("disabled",false);var errors=responseData.data.errorCode.trim();if(errors=="C226098"||errors=="C225598"){errors=responseData.data.errorText.trim().split("|");for(var i=0;i<errors.length;i++)self.validateFunc(errors[i])}else self.validateFunc(responseData.data.errorCode.trim())}else{jQuery("#registrationSubmitbutton").prop("disabled",
true);try{lm.Omniture.doTagRegistrationThankYouPage(responseData.data.newBuyerNumber,responseData.data.physicalState,responseData.data.physicalZip,responseData.data.physicalCountry,responseData.data.physicalCity)}catch(e){}$location.path("/thankyou")}},onFailure:function(data){console.error("connection with rest service gone away")}})}else{self.errors.termsAndCondtionsNotSelected=!self.personalDetails.termsAndConditions;self.errors.phoneNumber=!isValidNumber;self.submitted=true;jQuery("#registrationSubmitbutton").prop("disabled",
false)}},self.goToRegisteration=function(){$location.path("/doRegistration")},self.showPrivacyStatement=function(){},self.showTermsAndConditions=function(){},self.showWebConditions=function(){},self.changeCountry=function(){self.personalDetails.phoneNumber="";self.errors.phoneNumber=false;var element=$('[name\x3d"phoneNumber"]');var countryArray=element.intlTelInput.getCountryData();var selected=self.personalDetails.country.description;for(var i=0;i<countryArray.length;i++){var country=countryArray[i].name.toUpperCase();
if(country.indexOf("(")>-1)country=country.substring(0,countryArray[i].name.indexOf("(")).trim();if(country==selected){element.intlTelInput("setCountry",countryArray[i].iso2);break}}},self.selectedCountry=function(){var siteCode=copartUser.getUserConfig().siteCode.trim();if(siteCode=="CPRTUK")country="GBR";else if(siteCode=="CPRTMEA")country="ARE";else if(siteCode=="CPRTIE")country="IRL";else if(siteCode=="CPRTCA")country="CAN";else country="USA";appConfigService.appConfig.countries.forEach(function(item){if(item.code==
country)self.personalDetails.country=item})},self.openPrivacyPolicyModal=function(){self.fetchPrivacyPolicyCmsContent=true},self.openMemberServiceModal=function(){self.fetchMemberServiceCmsContent=true},self.openMemberTermsModal=function(){self.fetchMemberTermsCmsContent=true},self.changePhoneNumber=function(){self.errors.phoneNumber=$('[name\x3d"phoneNumber"]').intlTelInput("isValidNumber")},self.checkForSpecialChars=function(){if(self.personalDetails.address==""||self.personalDetails.address==undefined)self.errors.specialChars=
false;else self.errors.specialChars=!/^[a-zA-Z0-9- ]*$/.test(self.personalDetails.address.toString())},self.validateZip=function(){if(self.personalDetails.country.culture=="MIDDLE_EAST"||self.personalDetails.country.culture=="EURO_IR"||self.personalDetails.country.culture=="NONE")return true;if(self.personalDetails.zipOrPostalCode!=""&&self.personalDetails.zipOrPostalCode!=undefined){var zip=self.personalDetails.zipOrPostalCode;if(zip.indexOf("-")>-1){var split=zip.trim().split("-");self.personalDetails.physicalZip5=
split[0].trim();self.personalDetails.physicalZip4=split[1].trim();return true}else if(zip.indexOf(" ")>-1){var split=zip.trim().split(" ");self.personalDetails.physicalZip5=split[0].trim();self.personalDetails.physicalZip4=split[1].trim();return true}else if(zip.length>5&&/^[a-zA-Z]*$/.test(zip)){self.personalDetails.physicalZip5=zip.substring(0,4);self.personalDetails.physicalZip4=zip.substring(5);return true}else if(zip.length<=5&&!/^[a-zA-Z]*$/.test(zip)){self.personalDetails.physicalZip5=zip;
return true}}return false};self.$watch("personalDetails.zipOrPostalCode",function(){self.validateZip()});self.trackEvent=function(){lm.Omniture.doTagBeginRegistration()};var resolveAppConfigService=function(){var deferred=$q.defer();if(!appConfigService.isMoreLoaded)appConfigService.isMoreLoaded=deferred;else deferred.resolve(appConfigService.isMoreLoaded);return deferred.promise};self.init=function(){resolveAppConfigService().then(function(){self.selectedCountry()})};self.init()}]);
app.controller("manageCountermanController",["$scope","$http","$route","dataServiceG2",function($scope,$http,$route,dataServiceG2){var self=$scope;self.countermanVO={};var errorMsg1="Passwords not identical. Try again.";var errorMsg2="Password must be between 5-10 characters.";var successHeader1="Password Updated";var successHeader2="Counterman Enabled";var successMsg1="Your Counterman profile password has been updated.";var successMsg2="Your Counterman profile is now active.You can log-in using the password created.";
self.successMsg={};self.successMsg.msgHeading="";self.successMsg.msgText="";self.countermanForm={password:"",rePassword:""};var lhnAccountN="22724-1";var lhnButtonN=7677;var lhnChatPosition="righttab";var lhnInviteEnabled=1;var lhnWindowN=0;var lhnDepartmentN=0;var lhnInviteN=41139;var lhnInviteChime=1;self.errorShow=false;self.ErrorMessage="";self.myClick=function(myModel){if(myModel==false){self.counterFormShow=false;jQuery("#countermodal").modal()}else self.counterFormShow=true};self.submitCountermanForm=
function(){if(self.countermanForm.password!=self.countermanForm.rePassword){self.errorShow=true;self.errorMessage=errorMsg1}else if(self.countermanForm.password.length<5||self.countermanForm.password.length>10){self.errorShow=true;self.errorMessage=errorMsg2}else{self.errorShow=false;self.counterFormShow=true;self.countermanVO.password=self.countermanForm.password;dataServiceG2.createUpdateCountermanAccount(self.countermanVO,function(response){if(response.returnCode==1&&response.returnCodeDesc=="Success"){if(response.data.outExistFlag==
"A"){self.successMsg.msgHeading=successHeader2;self.successMsg.msgText=successMsg2}else if(response.data.outExistFlag=="U"){self.successMsg.msgHeading=successHeader1;self.successMsg.msgText=successMsg1}jQuery("#counterpassword").modal()}})}};dataServiceG2.getCountermanAccount(function(response){if(response.returnCode==1&&response.returnCodeDesc=="Success")if(response.data.outExistFlag=="Y"){self.myChkModel=true;self.counterFormShow=true}else{self.myChkModel=false;self.counterFormShow=false}});self.disableCounterman=
function(){self.counterFormShow=false;dataServiceG2.deleteCountermanAccount(function(response){if(response.returnCode==1&&response.returnCodeDesc=="Success");})};self.enableCounterman=function(){self.myChkModel=true;self.counterFormShow=true}}]);
app.controller("inventoryController",["$scope","$http","$locale","$routeParams","$location","urlService","copartUser","dataServiceG2","$filter","searchInventoryResult",function($scope,$http,$locale,$routeParams,$location,urlService,copartUser,dataServiceG2,$filter,searchInventoryResult){var self=$scope;self.locale=$scope.$parent.locale;self.countermanInventoryVO={};self.searchInventoryResultList={};self.modelList=null;self.getModels=function(){self.modelList=$filter("filter")(self.appConfig.vehicleMakeandModels,
{type:self.countermanInventoryVO.make})};self.errors={allFieldsEmpty:false};self.searchInventoryByLotVinSerial=function(){self.countermanInventoryVO.vehicleType="";self.countermanInventoryVO.yearFrom="";self.countermanInventoryVO.yearTo="";self.countermanInventoryVO.make="";self.countermanInventoryVO.model="";self.countermanInventoryVO.color="";self.countermanInventoryVO.lotNumber=self.countermanInventoryVO.lotNumber?self.countermanInventoryVO.lotNumber:"";self.countermanInventoryVO.vin=self.countermanInventoryVO.vin?
self.countermanInventoryVO.vin:"";self.countermanInventoryVO.serialNumber=self.countermanInventoryVO.serialNumber?self.countermanInventoryVO.serialNumber:"";if(self.countermanInventoryVO.lotNumber==""&&self.countermanInventoryVO.vin==""&&self.countermanInventoryVO.serialNumber==""){self.errors.allFieldsEmpty=true;return}if(_.isNaN(self.countermanInventoryVO.lotNumber-0)){self.errors.invalidLotNumber=true;return}self.errors.allFieldsEmpty=false;self.errors.invalidLotNumber=false;dataServiceG2.searchCountermanInventory(self.countermanInventoryVO,
function(response){self.searchInventoryResultList=response.data.data.lotList;searchInventoryResult.searchInventoryResultList=self.searchInventoryResultList;$location.path("/countermanInventorySearchResults")})};self.searchInventoryByVehicleType=function(){self.countermanInventoryVO.vehicleType=self.countermanInventoryVO.vehicleType?self.countermanInventoryVO.vehicleType:"";self.countermanInventoryVO.yearFrom=self.countermanInventoryVO.yearFrom?self.countermanInventoryVO.yearFrom:"";self.countermanInventoryVO.yearTo=
self.countermanInventoryVO.yearTo?self.countermanInventoryVO.yearTo:"";self.countermanInventoryVO.make=self.countermanInventoryVO.make?self.countermanInventoryVO.make:"";self.countermanInventoryVO.model=self.countermanInventoryVO.model?self.countermanInventoryVO.model:"";self.countermanInventoryVO.color=self.countermanInventoryVO.color?self.countermanInventoryVO.color:"";self.countermanInventoryVO.lotNumber="";self.countermanInventoryVO.vin="";self.countermanInventoryVO.serialNumber="";dataServiceG2.searchCountermanInventory(self.countermanInventoryVO,
function(response){self.searchInventoryResultList=response.data.data.lotList;searchInventoryResult.searchInventoryResultList=self.searchInventoryResultList;$location.path("/countermanInventorySearchResults")})};$scope.filterValue=function($event){if(isNaN(String.fromCharCode($event.keyCode)))$event.preventDefault()}}]);app.factory("searchInventoryResult",function(){return{}});
app.controller("inventorySearchResultsController",["$scope","$http","$locale","$routeParams","$location","urlService","copartUser","$timeout","dataServiceG2","$filter","searchInventoryResult",function($scope,$http,$locale,$routeParams,$location,urlService,copartUser,$timeout,dataServiceG2,$filter,searchInventoryResult){var self=$scope;self.locale=$scope.$parent.locale;self.images={};self.myLot={};self.searchInventoryResultList=searchInventoryResult.searchInventoryResultList;self.initializeDatatable=
function(){self.table=jQuery("#countermanSearchResults-datatable").DataTable({"processing":true,"data":self.searchInventoryResultList,"bPaginate":true,"deferRender":true,"paging":true,"ordering":true,"info":true,"fnDrawCallback":function(object){},"columns":[{"mData":"lotId","render":function(data,type,row){var imageDiv="\x3cimg alt\x3d'"+row["description"]+"' class\x3d'lazy' src\x3d'"+row["smallImage"].url+"' modal-image-viewer"+"lot-id\x3d'"+row.lotId+"' lot-desc\x3d'"+row.description+"' hide-watch-btn\x3dtrue images\x3d'images'/\x3e";
return imageDiv}},{"mData":"description","render":function(data,type,row){var link="\x3ca href\x3d'./lotDetail/"+row.lotId+"'\x3e"+data+"\x3c/a\x3e";return link}},{"mData":"lotId","render":function(data,type,row){var link="\x3ca href\x3d'./lotDetail/"+row.lotId+"'\x3e"+data+"\x3c/a\x3e";return link}},{"mData":"vin"},{"mData":"odometerReading"},{"mData":"color"},{"mData":"yard","render":function(data,type,row){return row["yard"].name}},{"mData":"saleDate","render":function(data,type,row){return $filter("date")(row["saleDate"].date,
"MM/dd/yyyy")}},{"mData":"color"}]});return self.table};self.showHideImages=function(flag){var table=$("#countermanSearchResults-datatable").DataTable();table.column(0).visible(flag)};if(_.isUndefined(self.searchInventoryResultList))$location.path("/countermanInventory");else self.initializeDatatable()}]);
app.controller("SupportServicesController",["$scope","$locale","$location","$anchorScroll","urlService","dataServiceG2","copartUtils","appConfigService",function($scope,$locale,$location,$anchorScroll,urlService,dataServiceG2,copartUtils,appConfigService){var self=$scope;self.locale=$scope.$parent.locale;self.facilities={};self.yardLocations=[];self.inspectors=[];self.copartLocation;self.wlWaiting=false;self.totalNumberOfInspectors=1E3;self.maxSize=5;var pageno=$location.search().page?parseInt($location.search().page):
1;var yardNum=$location.search().yardNum?parseInt($location.search().yardNum):0;self.currentPage=pageno;self.newInspectorFormURL=urlService.getContentURL("PDFs/Inspector-App-Form.pdf");self.getInspectors=function(page,yardNumber){$location.search({"page":page,yardNum:yardNumber});dataServiceG2.getInspectors(yardNumber,page,function(response){self.inspectors=response.data.inspectorsList;for(var i=0;i<self.inspectors.length;i++){var languages=self.inspectors[i].language;if(typeof languages!="undefined"&&
languages!=null&&languages.length>0)self.inspectors[i].language=copartUtils.splitIntoArray(languages)}self.totalNumberOfInspectors=response.data.totalNumberOfInspectors;self.wlWaiting=false;$("#backToTopId").click()},function(errorResponse){console.log("Error occurred"+errorResponse)});self.wlWaiting=true};self.pageChanged=function(page,copartLocation){pageno=page;self.getInspectors(pageno,copartLocation.yardNumber)};self.getYardLocations=function(){appConfigService.getLocationsListBySite(function(response){var all=
{yardName:self.locale.messages["support.services.inspectors.allFacilities"],yardNumber:0};self.yardLocations=response;self.yardLocations.push(all);self.copartLocation=_.find(self.yardLocations,function(yard){return yard.yardNumber==yardNum});if(!self.copartLocation)self.copartLocation=self.yardLocations[self.yardLocations.length-1];self.inspectors=self.getInspectors(pageno,self.copartLocation.yardNumber)})};self.getYardLocations()}]);
app.controller("InspectorController",["$scope","$locale","$routeParams","urlService","dataServiceG2","copartUtils",function($scope,$locale,$routeParams,urlService,dataServiceG2,copartUtils){var self=$scope;self.locale=$scope.$parent.locale;self.facilities={};self.inspectors={};self.facilityVO={};self.copartLocation;self.inspectorNumber=$routeParams.inspectorNumber;self.inspectorDetails={};self.yardLocationsArray={};self.langs={};self.languages={};self.wlWaiting=false;self.newInspectorFormURL=urlService.getContentURL("PDFs/Inspector-App-Form.pdf");
self.getInspectorDetails=function(){dataServiceG2.getInspectorDetails(self.inspectorNumber,function(response){self.inspectorDetails=response.data.inspectorDetails;var yardLocations=response.data.inspectorDetails.yardVOList;if(yardLocations!==undefined&&yardLocations.length>0)self.yardLocationsArray=copartUtils.splitArrayIntoChunks(yardLocations,4);var languages=self.inspectorDetails.language;if(typeof languages!="undefined"&&languages!=null&&languages.length>0)self.languages=copartUtils.splitIntoArray(languages);
self.wlWaiting=false},function(errorResponse){console.log("Error occurred"+errorResponse)});self.wlWaiting=true};self.getInspectorDetails()}]);
app.controller("SupportServicesBrokersController",["$scope","$timeout","$location","$filter","dataServiceG2","$routeParams",function($scope,$timeout,$location,$filter,dataServiceG2,$routeParams){var self=$scope;self.locale=$scope.$parent.locale;self.allBrokers=[];self.resellerAccountInfo={};self.resellerServices={};self.resellerPaymentMethods={};self.marketMakerslist={};self.activeTab=$routeParams.tab;self.wlWaiting=false;self.totalNumberOfBrokers=0;self.maxSize=5;self.currentPage=1;self.brokerContentUrl=
"Content/US/EN/Services/Brokers.html";$scope.setPage=function(pageNo){$scope.currentPage=pageNo};$scope.pageChanged=function(){self.getAllBrokers();console.log("Page changed to: "+$scope.currentPage)};self.getAllBrokers=function(){if(typeof self.currentPage=="undefined"||self.currentPage==null)self.currentPage=1;dataServiceG2.getAllBrokers(self.currentPage,function(response){self.allbrokers=response.data.allBrokersList;for(var index in self.allbrokers){self.getResellerAccountInfo(self.allbrokers[index].buyerNumber,
index);self.totalNumberOfBrokers=response.data.totalNumberOfBrokers}self.wlWaiting=false},function(errorResponse){console.log("Error occured while getting All Brokers"+errorResponse)})};self.getResellerAccountInfo=function(broker,index){dataServiceG2.getResellerAccountInfo(broker,function(response){self.allbrokers[index].brokerInfo=response.data.resellerAccount;if(self.allbrokers[index].brokerInfo.phoneNumber==null||self.allbrokers[index].brokerInfo.phoneNumber.trim()=="")self.allbrokers[index].brokerInfo.brokerPhoneNumber=
false;else self.allbrokers[index].brokerInfo.brokerPhoneNumber=true;if(self.allbrokers[index].brokerInfo.areaCode!=null&&self.allbrokers[index].brokerInfo.areaCode.trim()!="0")self.allbrokers[index].brokerInfo.phoneNumber=self.allbrokers[index].brokerInfo.areaCode+self.allbrokers[index].brokerInfo.phoneNumber;if(self.allbrokers[index].brokerInfo.website==null||self.allbrokers[index].brokerInfo.website.trim()=="")self.allbrokers[index].brokerInfo.brokerWebsite=false;else self.allbrokers[index].brokerInfo.brokerWebsite=
true},function(errorResponse){console.log("Error occured while getting  Reseller Account info"+errorResponse)})};$scope.getPaginationArray=function(){var paginationSize=Math.round(self.totalNumberOfBrokers!=0?self.totalNumberOfBrokers/10:1);return new Array(paginationSize)};self.init=function(){self.getAllBrokers()};self.init()}]);
app.controller("SupportServicesMarketMakersController",["$scope","$timeout","$location","$filter","dataServiceG2","$routeParams",function($scope,$timeout,$location,$filter,dataServiceG2,$routeParams){var self=$scope;self.locale=$scope.$parent.locale;self.allMarketMakers={};self.marketmakerdetails={};self.activeTab=2;self.wlWaiting=false;self.totalNumberOfMarketMakers=0;self.maxSize=5;self.currentPage=1;$scope.setPage=function(pageNo){$scope.currentPage=pageNo};$scope.pageChanged=function(){self.getAllBrokers();
console.log("Page changed to: "+$scope.currentPage)};self.getAllMarketMakers=function(){if(typeof self.currentPage=="undefined"||self.currentPage==null)self.currentPage=1;dataServiceG2.getMarketMakerslist(self.currentPage,function(response){self.allMarketMakers=response.data.marketMakersList;for(var index in self.allMarketMakers)self.getMarketmakerdetails(self.allMarketMakers[index].marketMakerKey,index);self.wlWaiting=false},function(errorResponse){console.log("Error occured while getting All Market Makers"+
errorResponse)})};self.getMarketmakerdetails=function(marketMaker,index){dataServiceG2.getMarketMakerDetails(marketMaker,function(response){self.allMarketMakers[index].marketMakerInfo=response.data.marketMakerDetails;if(self.allMarketMakers[index].marketMakerInfo.phoneNumber==null||self.allMarketMakers[index].marketMakerInfo.phoneNumber.trim()=="")self.allMarketMakers[index].marketMakerInfo.marketPhoneNumber=false;else self.allMarketMakers[index].marketMakerInfo.marketPhoneNumber=true;if(self.allMarketMakers[index].marketMakerInfo.phoneAreaCode!=
null&&self.allMarketMakers[index].marketMakerInfo.phoneAreaCode.trim()!="0")self.allMarketMakers[index].marketMakerInfo.phoneNumber=self.allMarketMakers[index].marketMakerInfo.phoneAreaCode+self.allMarketMakers[index].marketMakerInfo.phoneNumber;if(self.allMarketMakers[index].marketMakerInfo.registrationFee.charAt(0)=="0"){self.allMarketMakers[index].marketMakerInfo.registrationFee=self.locale.messages["support.services.market.fees1"];self.allMarketMakers[index].marketMakerInfo.securityDeposit=self.locale.messages["support.services.market.fees2"];
self.allMarketMakers[index].marketMakerInfo.transactionFee=self.locale.messages["support.services.market.fees3"]}},function(errorResponse){console.log("Error occured while getting Market Maker Details"+errorResponse)})};$scope.getPaginationArray=function(){var paginationSize=Math.round(self.totalNumberOfMarketMakers!=0?self.totalNumberOfMarketMakers/10:1);return new Array(paginationSize)};self.init=function(){self.getAllMarketMakers()};self.init()}]);
app.controller("SupportServicesViewMarketMakerController",["$scope","$timeout","$routeParams","$location","$filter","dataServiceG2",function($scope,$timeout,$routeParams,$location,$filter,dataServiceG2){var self=$scope;self.locale=$scope.$parent.locale;self.marketMakerAccountInfo={};self.resellerServices={};self.marketMaker=$routeParams.marketMaker;self.phoneValue=true;self.getMarketMakerAccountInfo=function(){dataServiceG2.getMarketMakerDetails(self.marketMaker,function(response){self.marketMakerAccountInfo=
response.data.marketMakerDetails;if(self.marketMakerAccountInfo.phoneNumber==null||self.marketMakerAccountInfo.phoneNumber.trim()=="")self.phoneValue=false;if(self.marketMakerAccountInfo.phoneAreaCode!=null&&self.marketMakerAccountInfo.phoneAreaCode.trim()!="0")self.marketMakerAccountInfo.phoneNumber=self.marketMakerAccountInfo.phoneAreaCode+self.marketMakerAccountInfo.phoneNumber},function(errorResponse){console.log("Error occured while getting  market maker info"+errorResponse)})};self.init=function(){self.getMarketMakerAccountInfo()};
self.init()}]);
app.controller("SupportServicesViewBrokerController",["$scope","$locale","$routeParams","dataServiceG2","copartUtils",function($scope,$locale,$routeParams,dataServiceG2,copartUtils){var self=$scope;self.locale=$scope.$parent.locale;self.brokerDetails={};self.services={};self.paymentMethods={};self.brokerNumber=$routeParams.brokerNumber;self.getBrokerDetails=function(){dataServiceG2.getResellerAccountInfo(self.brokerNumber,function(response){self.brokerDetails=response.data.resellerAccount;if(self.brokerDetails.areaCode!=
null&&self.brokerDetails.areaCode.trim()!="0")self.brokerDetails.phoneNumber=self.brokerDetails.areaCode+self.brokerDetails.phoneNumber},function(errorResponse){console.log("Error occurred in Reseller Account Info"+errorResponse)})};self.getResellerServices=function(){dataServiceG2.getResellerServices(self.brokerNumber,function(response){self.services=response.data.resellerServicesList},function(errorResponse){console.log("Error occurred in Reseller Services"+errorResponse)})};self.getResellerPaymentMethods=
function(){dataServiceG2.getResellerPaymentMethods(self.brokerNumber,function(response){self.paymentMethods=response.data.resellerPaymentMethodsList},function(errorResponse){console.log("Error occurred in Reseller Services"+errorResponse)})};self.init=function(){self.getBrokerDetails();self.getResellerServices();self.getResellerPaymentMethods()};self.init()}]);
app.controller("TowProviderContactUsController",["$scope","$locale","dataServiceG2","copartUtils","appConfigService",function($scope,$locale,dataServiceG2,copartUtils,appConfigService){var self=$scope;self.contactUsInquiry={};self.contactUsInquiry.message="-";self.isError=null;self.locationObj={};self.filterLocationObj=[];self.locale=$scope.$parent.locale;$scope.filterLocations=function(item){return item.type==="USA"||item.type==="CAN"};$scope.stateFilter=function(item){return item.type==="USA"||
item.type==="CAN"};self.getYardLocations=function(){appConfigService.getLocationsListBySite(function(response){self.yardLoations=response})};self.getYardLocationsByState=function(state){self.locationObj=_.where(self.yardLoations,{yardStateCode:self.contactUsInquiry.state});self.filterLocationObj=_.filter(self.locationObj,function(item){if(item.yardName.charAt(0)!="*"&&item.yardName.indexOf("-")==3)return item})};self.towProviderContactUS=function(isValid){if(self.contactUsInquiry.location==null||
self.contactUsInquiry.location=="")self.contactUsInquiry.location="";if(isValid)dataServiceG2.towProviderContactUS(self.contactUsInquiry,function(response){var responseCode=response.data.errorMsg;var responseCodeDesc=response.returnCodeDesc;if(responseCode!=null&&responseCode.trim()!=""&&responseCodeDesc!=null&&responseCodeDesc.trim()!="Success"){self.isError=true;var temp=self.locale.getMessage("member.error.tow.phone."+responseCode.trim());if(temp!=null&&temp!="")self.errorDesc=temp;else self.errorDesc=
"Unknown Error"}else{self.isError=false;self.errorDesc="Success";jQuery("#successModal").modal()}},function(errorResponse){console.log("Error occurred in Tow Provider Contact Us"+errorResponse)});else self.submitted=true};self.init=function(){self.getYardLocations()};self.init()}]);
app.controller("bidderManagementController",["$scope","$location","$http","$locale","$filter","$compile","dataServiceG2",function($scope,$location,$http,$locale,$filter,$compile,dataServiceG2){var self=$scope;self.bidderStatusList=null;self.searchBy;self.searchKeyWord;self.selectedBidder;self.selectedStatus;self.test="test";self.refreshRows=false;self.isPremier=false;self.noOfRecords;self.submitted=false;self.ERROR_STATUS_REQUIRED=false;self.ERROR_AMOUNT_ZERO=false;self.ERROR_COUNT_ZERO=false;self.ERROR_AMOUNT_NAN=
false;self.ERROR_COUNT_NAN=false;self.updatableBidder;self.SUCCESS_TITLE=self.$parent.locale.messages["bidder.model.title.success"];self.SUCCESS_MSG=self.$parent.locale.messages["bidder.model.msg.success"];self.getBidderStatusList=function(){dataServiceG2.getBidderStatusList(function(responseData){console.log(responseData);if(responseData.returnCode==-1)log.error("Error");else{self.bidderStatusList=responseData.data;self.noOfRecords=responseData.data?responseData.data.length:"";self.isPremier=responseData.isPremier}})};
self.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){self.initializeDatatable()});self.initializeDatatable=function(){self.table=$("#manageBiddersDataTable").DataTable({"bPaginate":false,"responsive":true,"aaSorting":[],"language":{"zeroRecords":self.$parent.locale.messages["bidder.grid.zerorecords.text"]},columnDefs:[{className:"control",orderable:false,targets:0}],"fnDrawCallback":function(object){}});$("#manageBiddersDataTable_info").html(self.$parent.locale.messages["bidder.grid.footer.numofbidders"]+
self.noOfRecords);return self.table};self.filterTable=function(filterBy){console.log(self.selectedBidder);self.table.columns("").search("");if(filterBy=="STATUS"){self.selectedBidder="";if(self.selectedStatus!=null&&self.selectedStatus!="")self.table.columns(".bidderStatus").search("^\\s*"+self.selectedStatus+"\\s*$",true,false);else self.table.columns(".bidderStatus").search("")}else if(filterBy=="BIDDER"){self.selectedStatus="";self.table.columns(".bidderNumber").search(self.selectedBidder!=null?
self.selectedBidder.bidderNumber:"")}self.table.draw();$("#manageBiddersDataTable_info").html(self.$parent.locale.messages["bidder.grid.footer.numofbidders"]+self.noOfRecords)};self.updateBidder=function(bidder,event){self.requestVO={};self.ERROR_INVALID_STATUS=false;self.ERROR_AMOUNT_ZERO=false;self.ERROR_COUNT_ZERO=false;self.ERROR_AMOUNT_NAN=false;self.ERROR_COUNT_NAN=false;self.SPROC_ERROR_STATUS=false;self.ERROR_LIMIT=false;self.changePasswordForm.$setPristine();self.updatableBidder=bidder;self.selectedElement=
event.target;self.requestVO.buyerNumber=bidder.buyerNumber;self.requestVO.bidderNumber=bidder.bidderNumber;self.requestVO.bidderStatus="";self.requestVO.bidderStatusDate=bidder.bidderStatusDate;self.requestVO.bidderCountLimit=bidder.bidderCountLimit;self.requestVO.bidderDollarLimit=bidder.bidderDollarLimit;self.requestVO.newPassword=bidder.newPassword;self.requestVO.confirmPassword=bidder.confirmPassword;self.requestVO.sendEmailTo=bidder.sendEmailTo;self.requestVO.sendEmailTo="R"};self.updateBidderStatus=
function(){if(self.requestVO.bidderStatus.trim()=="R"){self.resetStatus();return}dataServiceG2.updateBidderStatus(self.requestVO,function(responseData){if(responseData.returnCode==-1)log.error("Error");if(responseData.data.errorCode.trim()=="C202711")self.ERROR_INVALID_STATUS=true;else{self.table.destroy();jQuery(self.selectedModel).modal("hide");self.getBidderStatusList();jQuery("#successModal").modal()}})};self.updateAllocatedLimit=function(event){if(self.validateAllocatedLimits())dataServiceG2.updateBidderAllocatedLimit(self.requestVO,
function(responseData){if(responseData.returnCode==-1)log.error("Error");if(responseData.data!=null&&responseData.data.errorCode.trim()!=""){var errorCode=responseData.data.errorCode.trim();self.ERROR_LIMIT=true;self.sprocErrorCode="bidder.error.limit."+errorCode}else{self.table.destroy();self.getBidderStatusList();jQuery("#myModalbidlimit").modal("hide");jQuery("#successModal").modal()}})};self.validateAllocatedLimits=function(bidderVO){var validate=true;if(isNaN(self.requestVO.bidderDollarLimit)){self.ERROR_AMOUNT_NAN=
true;validate=false}if(isNaN(self.requestVO.bidderCountLimit)){self.ERROR_COUNT_NAN=true;validate=false}if(!isNaN(self.requestVO.bidderDollarLimit)&&self.requestVO.bidderDollarLimit<=0){self.ERROR_AMOUNT_ZERO=true;validate=false}if(!isNaN(self.requestVO.bidderCountLimit)&&self.requestVO.bidderCountLimit<=0){self.ERROR_COUNT_ZERO=true;validate=false}return validate};self.onChangeHideError=function(element){jQuery(element).hide()};self.changePassword=function(isValid){if(isValid&&self.requestVO.newPassword==
self.requestVO.confirmPassword)dataServiceG2.changeBidderPassword(self.requestVO,function(responseData){if(responseData.returnCode==-1)log.error("Error");else{jQuery("#myModalpassword").modal("hide");jQuery("#successModal").modal()}});else self.submitted=true};self.showConfirmationDialog=function(){if(self.updatableBidder.bidderStatus==self.requestVO.bidderStatus){self.ERROR_STATUS_REQUIRED=true;return}jQuery("#myModalstatus").modal("hide");switch(self.requestVO.bidderStatus){case "R":jQuery("#resetmodal").modal();
self.selectedModel="#resetmodal";break;case "A":jQuery("#activemodal").modal();self.selectedModel="#activemodal";break;case "I":jQuery("#inactivemodal").modal();self.selectedModel="#inactivemodal";break;case "S":jQuery("#suspendedmodal").modal();self.selectedModel="#suspendedmodal";break;case "V":jQuery("#vacantmodal").modal();self.selectedModel="#vacantmodal";break}};self.resetStatus=function(){dataServiceG2.resetBidderStatus(self.requestVO,function(responseData){if(responseData.returnCode==-1)log.error("Error");
else if(responseData.data.errorCode.trim()){self.SPROC_ERROR_STATUS=true;self.sprocErrorCode="bidder.info."+responseData.data.errorCode.trim();jQuery(self.selectedModel).modal("hide");jQuery("#myModalstatus").modal()}else{self.table.destroy();jQuery(self.selectedModel).modal("hide");self.getBidderStatusList();jQuery("#successModal").modal()}})};self.getStatusValue=function(){};self.searchBidder=function(event){self.selectedBidder="";self.selectedStatus="";self.table.columns("").search("");self.table.search(self.searchKeyWord).draw();
$("#manageBiddersDataTable_info").html(self.$parent.locale.messages["bidder.grid.footer.numofbidders"]+self.noOfRecords)};self.checkSearchEmpty=function(event){if(self.searchKeyWord.trim()==""){self.table.columns("").search("").draw();$("#manageBiddersDataTable_info").html(self.$parent.locale.messages["bidder.grid.footer.numofbidders"]+self.noOfRecords)}else self.searchBidder()};self.getViewCounts=function(bidder,event){self.updatableBidder=bidder;dataServiceG2.getBidderCounts(self.updatableBidder,
function(responseData){if(responseData.returnCode==-1)log.error("Error");else self.updatableBidder=responseData.data})};self.getBidderStatusList()}]);
app.controller("marketGuideController",["$scope","$http","$location","dataServiceG2","$routeParams",function($scope,$http,$location,dataServiceG2,$routeParams){var self=$scope;self.lotNumber=$routeParams.lotId;self.vinNumber=$routeParams.vin;self.NADAValues=null;self.proQuotaSalesList=null;self.vinDetails=null;self.images={};var staticLotDetails=function(){dataServiceG2.getLotDetails(self.lotNumber,function(response){self.lotDetails=response.data.data.lotDetails;getLotIconObjects()})};var getLotIconObjects=
function(){self.iconCodesObjArray=[];var showHighlightIconsArray=_.where(self.appConfig.highlightIcons,{iconType:"H"});var sellerHighlightIconsArray=_.where(self.appConfig.highlightIcons,{iconType:"S"});_.each(self.lotDetails.lic,function(iconCodeObj){_.find(showHighlightIconsArray,function(obj){if(obj.iconCode==iconCodeObj){self.iconCodesObjArray.push(obj);return true}});self.seller=self.seller||_.find(sellerHighlightIconsArray,{iconCode:iconCodeObj})})};self.getNADAValues=function(){dataServiceG2.getNADAValues(self.lotNumber,
function(response){if(response)self.NADAValues=response.data.nadaValues;else log.error("NADAValues Info is not available for lot "+self.lotNumber+"as the Response is"+response.returnCode)})};self.getVinDetails=function(){dataServiceG2.getVinDetails(self.vinNumber,function(response){if(response)self.vinDetails=response.data.vinDetails;else log.error(" VinDetails Info is not available for lot "+self.lotNumber+"as the Response is"+response.returnCode)})};self.getProQuotaSalesList=function(){dataServiceG2.getProquoteSalesList(self.lotNumber,
function(response){if(response){self.proQuotaSalesList=response.data.proQuotaSalesList;self.proQuotaValues=response.data.proQuotaValues}else log.error(" ProquoteSalesList Info is not available "+self.lotNumber+"as the Response is"+response.returnCode)})};self.showAllPhotosView=function(){$location.url("/lotDetail/"+self.lotNumber+"/Photos")};var getLotImages=function(){dataServiceG2.getLotImages($scope.lotNumber,function(response){if(response!=null){var imagesList=response.data.data.imagesList;$scope.fullSizeImages=
imagesList.THUMBNAIL_IMAGE}})};self.init=function(){staticLotDetails();self.getVinDetails();self.getProQuotaSalesList();self.getNADAValues();getLotImages()};self.init()}]);
app.controller("brokerProfileController",["$scope","$http","$route","copartUser","dataServiceG2","$window",function($scope,$http,$route,copartUser,dataServiceG2,$window){var self=$scope;self.brokerAccountInfo;self.brokerPaymentBusinessInfo;self.brokerServiceTexts;self.brokerPaymentMethods;self.brokerAdditionalInfoVO=[];self.brokerAdditionalInfoVO.moreInfoLBL="";self.brokerAdditionalInfoVO.moreInfoFL="";self.brokerAdditionalInfoVO.termsAndCond="";self.brokerAdditionalInfoVO.logo="";self.checkEditFlag=
false;self.buyerNumber=copartUser.getUserConfig().buyerNumber;self.amountToIncrease=0;self.totalSeatsRequested=0;self.totalSeatsRequested=self.totalSeatsRequested+self.amountToIncrease;self.parseInt=parseInt;self.init=function(){dataServiceG2.getBrokerAccountInfo(function(response){if(response.returnCode==1&&response.returnCodeDesc=="Success"){self.brokerAccountInfo=response.data.brokerAccountInfo;self.totalSeatsRequested=self.totalSeatsRequested+self.brokerAccountInfo.currentBidders;switch(self.brokerAccountInfo.accountStatus.trim()){case "A":self.brokerAccountInfo.accountStatus=
"Active";break;case "I":self.brokerAccountInfo.accountStatus="InActive";break;case "S":self.brokerAccountInfo.accountStatus="Suspended";break;default:self.brokerAccountInfo.accountStatus="Void"}}});dataServiceG2.getBrokerPaymentBusinessInfo(function(response){if(response.returnCode==1&&response.returnCodeDesc=="Success"){self.brokerPaymentBusinessInfo=response.data.brokerPaymentBusinessInfo;self.brokerAdditionalInfoVO.moreInfoLBL=self.brokerPaymentBusinessInfo.moreInfoLBL;var phoneNumber=self.brokerPaymentBusinessInfo.phoneNumber;
self.brokerPaymentBusinessInfo.phoneNumber=phoneNumber.substring(0,3)+"-"+phoneNumber.substring(3,7)}});dataServiceG2.getBrokerServiceTexts(function(response){if(response.returnCode==1&&response.returnCodeDesc=="Success")self.brokerServiceTexts=response.data.brokerServiceTexts});dataServiceG2.getBrokerPaymentMethods(function(response){if(response.returnCode==1&&response.returnCodeDesc=="Success")self.brokerPaymentMethods=response.data.brokerPaymentMethods})};self.init();self.dateFormat=function(dateString){if(dateString!=
undefined){var date=new Date(dateString.substring(0,4),parseInt(dateString.substring(4,6))-1,dateString.substring(6,8));return moment(date).format("MM/DD/YYYY")}};self.editToggle=function(){if(self.checkEditFlag)self.checkEditFlag=false;else self.checkEditFlag=true};self.additionalInfo=function(){self.checkEditFlag=false;self.brokerInfoVO={};self.brokerInfoVO["moreInfoLBL"]=self.brokerAdditionalInfoVO.moreInfoLBL;self.brokerInfoVO["moreInfoFL"]=self.brokerAdditionalInfoVO.moreInfoFL;self.brokerInfoVO["termsAndCond"]=
self.brokerAdditionalInfoVO.termsAndCond;self.brokerInfoVO["logo"]=self.brokerAdditionalInfoVO.logo;dataServiceG2.updateBrokerInfo(self.brokerInfoVO,function(response){if(response.returnCode==1&&response.returnCodeDesc=="Success");})};self.editClick=function(){self.editClickFlag=true};self.sendMail=function(userId,currBidderNo,incBidderNo){var increaseTo=parseInt(currBidderNo)+parseInt(incBidderNo);var emailId="Member.License@copart.com";var subject="Increase Bidder Seats Request - Member #"+userId;
var message="Please increase my bidder seats from "+currBidderNo+" to "+increaseTo+".";$window.open("mailto:"+emailId+"?subject\x3d"+subject+"\x26body\x3d"+message,"_self");jQuery("#myModalbidderrequest").modal("hide")}}]);
app.controller("brokerBidderEmailController",["$scope","$http","$locale","$routeParams","dataServiceG2","urlService","$location",function($scope,$http,$locale,$routeParams,dataServiceG2,urlService,$location){var self=$scope;self.emailVO={};self.errorMessage="";self.displayError=false;self.flag=false;self.submitEmail=function(){self.emailVO["bidderEmail"]=self.email;dataServiceG2.updateBidderEmail(self.emailVO,function(response){var responseCode=response.data.data.errorMsg;var responseCodeDesc=response.data.returnCodeDesc;
if(responseCode!=null&&responseCode.trim()!=""){self.displayError=true;self.errorMessage=responseCodeDesc}else if(response.data.returnCode==1){jQuery("#mysavemodal").modal();self.flag=true;self.errorMessage=""}})};self.forwardURL=function(){$location.path(urlService.dashboard)}}]);
app.controller("downloadSalesDataController",["$scope","$timeout","userService","dataServiceG2",function($scope,$timeout,userService,dataServiceG2){var self=$scope;var selectedTimezone=userService.userConfig.selectedTimezone;var dwnldSalesDataPref=userService.userConfig.downloadSalesDataPreference;self.fetchCsvFromExtDomain=dwnldSalesDataPref&&dwnldSalesDataPref.fetchFromExtDomain?true:false;self.getDate=function(){return moment().tz(selectedTimezone).format("YYYY MMMM DD")};var submitForm=function(){var form=
document.csv;form.action=self.saleDataConfig.formAction?self.saleDataConfig.formAction.trim():"";form.submit()};self.downloadCSV=function(){var successCallBack=function(response){self.saleDataConfig=response.saleDataConfig;$timeout(submitForm,0)};dataServiceG2.getSalesDataConfig(successCallBack)}}]);
app.controller("SellByIndividualController",["$scope","$filter","$location","dataServiceG2","vehicleFactory","appConfigService",function($scope,$filter,$location,dataServiceG2,vehicleFactory,appConfigService){var self=$scope;self.appInit=appInit;self.locale=$scope.$parent.locale;self.formSubmitted=false;self.sellVehicleVO=new SellVehicleVO;self.submissionConfirmed=false;self.errors={phoneNumber:false};self.makeObjs=_.filter(appConfigService.appConfig.vehicleMakes,function(make){return make.type==
"V"});self.submitForm=function(isValid){if(self.sellVehicleVO.zipPostalCode==null)self.sellVehicleVO.zipPostalCode=self.sellVehicleVO.PostalCode1+" "+self.sellVehicleVO.PostalCode2;if(!isValid||self.errors.phoneNumber||self.sellVehicleVO.phoneNumber==undefined||self.sellVehicleVO.phoneNumber==""||self.sellVehicleVO.phoneNumber==null){self.formSubmitted=true;return}var sellVehicleVO=_.omit(self.sellVehicleVO,"vehicleMake");sellVehicleVO.vehicleMake=self.sellVehicleVO.vehicleMake.description;dataServiceG2.signUpToSellVehicleAsIndividual(sellVehicleVO,
function(response){var responseCode=response.returnCodeDesc;if(responseCode!=="undefined"&&responseCode==="Success"){self.submissionConfirmed=true;$location.url("/Content/"+appInit.regionCode+"/"+appInit.localeString+"/How-To-Sell/Individual-ThankYou.html")}else;})};(function(){angular.element(document.querySelector("#tell-us-abt-business")).parent().addClass("quoteFormBox");angular.element(document.querySelector(".quoteFormBox")).parent().addClass("overflowImp")})();self.getModels=function(appConfig,
vehicleMake){console.log(appConfig);vehicleMake=vehicleMake.trim();console.log($filter("filter")(appConfig.vehicleMakes,{description:vehicleMake}))}}]);
app.controller("SellByBusinessOrDealerController",["$scope","$location","dataServiceG2","copartUser","appConfigService",function($scope,$location,dataServiceG2,copartUser,appConfigService){var self=$scope;self.appInit=appInit;self.locale=$scope.$parent.locale;self.formSubmitted=false;self.sellVehicleVO=new SellVehicleVO;self.submissionConfirmed=false;self.siteCode=copartUser.getUserConfig().siteCode;self.errors={phoneNumber:false};self.mycounties=appConfigService.appConfig.countryStates;self.streetField=
!copartUser.hasAccessSitePref("sellavehicleBusiness","hide_streetaddress");self.stateField=!copartUser.hasAccessSitePref("sellavehicleBusiness","hide_statefield");self.irelandCounties=["Co. Carlow","Co. Cavan","Co. Clare","Co. Cork","Co. Donegal","Co. Dublin","Co. Galway","Co. Kerry","Co. Kildare","Co. Kilkenny","Co. Laois","Co. Leitrim","Co. Limerick","Co. Longford","Co. Louth","Co. Mayo","Co. Meath","Co. Monaghan","Co. Offaly","Co. Roscommon","Co. Sligo","Co. Tipperary","Co. Waterford","Co. Westmeath",
"Co. Wexford","Co. Wicklow"];(function(){angular.element(document.querySelector("#tell-us-abt-business")).parent().addClass("quoteFormBox");angular.element(document.querySelector(".quoteFormBox")).parent().addClass("overflowImp")})();self.submitForm=function(isValid){if(self.sellVehicleVO.zipPostalCode==null)self.sellVehicleVO.zipPostalCode=self.sellVehicleVO.PostalCode1+" "+self.sellVehicleVO.PostalCode2;if(!isValid||self.errors.phoneNumber||self.sellVehicleVO.phoneNumber==undefined||self.sellVehicleVO.phoneNumber==
""||self.sellVehicleVO.phoneNumber==null){self.formSubmitted=true;return}dataServiceG2.signUpToSellVehicleAsBusinessOrDealer(self.sellVehicleVO,function(response){var responseCode=response.returnCodeDesc;if(responseCode!=="undefined"&&responseCode==="Success"){self.submissionConfirmed=true;$location.url("/Content/"+appInit.regionCode+"/"+appInit.localeString+"/How-To-Sell/Business-ThankYou.html")}else;})}}]);
app.controller("hireABrokerController",["$scope","$timeout","$location","$filter","dataServiceG2","$routeParams","watchListService","staticLotDetails",function($scope,$timeout,$location,$filter,dataServiceG2,$routeParams,watchListService,staticLotDetails){var self=$scope;self.lotNumber=$routeParams.lotNumber;self.allBrokers={};self.resellerAccountInfo={};self.resellerServices={};self.resellerPaymentMethods={};self.marketMakerslist={};var staticLotDetailsPromise=staticLotDetails;if(staticLotDetailsPromise&&
staticLotDetailsPromise.returnCode==1&&staticLotDetailsPromise.data.lotDetails)self.lotDetails=staticLotDetailsPromise.data.lotDetails;else return;watchListService.setWatchListDefinition($location.url());self.addToWatchList=watchListService.addToWatchList;self.isAlreadyAdded=watchListService.isAlreadyAdded;self.removeFromWatchList=watchListService.removeFromWatchList;var getDynamicLotDetails=function(){dataServiceG2.getDynamicLotDetails(self.lotNumber,lotDetailsDymicSuccessCallBack)};var lotDetailsDymicSuccessCallBack=
function(response){try{if(response.data.returnCode==-1)self.dynamicLotDetailsError=response.data.data.errorObject;else self.dynamiclotDetails=response.data.data.lotDetails}catch(e){log.error(e)}};self.getAllBrokers=function(){dataServiceG2.getHireabrokerList(self.lotNumber,self.lotDetails.stt,"USA",function(response){if(response.returnCode==1)self.allbrokers=response.data.brokerResults;else;},function(errorResponse){console.log("Error occured while getting All Brokers"+errorResponse)})};self.getResellerAccountInfo=
function(broker,index){};self.init=function(){self.getAllBrokers();getDynamicLotDetails()};self.init()}]);
app.controller("copartVideosController",["$scope","$sce","cmsContentService","siteCatalyst",function($scope,$sce,cmsContentService,siteCatalyst){var self=$scope;self.videosGroupArray=[];self.playCurrentVideo=function(video){var siteCatalystVal={};siteCatalystVal.fname="doTagCopartVideoPlay";siteCatalyst.addToQueue("doTagCopartVideoPlay",siteCatalystVal);siteCatalyst.executeCall("doTagCopartVideoPlay");self.iframeVideoUrl=$sce.trustAsResourceUrl(validateYouTubeUrl(video.embedUrl));self.videoDescription=
video.description;self.videoTitle=video.title};var parentFragmentId="Content/US/EN/copartVideos";var fragmentId="CopartVideos";var validateYouTubeUrl=function(url){if(url!=undefined||url!=""){var regExp=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=|\?v=)([^#\&\?]*).*/;var match=url.match(regExp);if(match&&match[2].length==11)return"https://www.youtube.com/embed/"+match[2]+"?autoplay\x3d1\x26enablejsapi\x3d1";else{console.log("url not valid");return""}}};self.getImageUrl=function(url,size){if(url===
null)return"";size=size===null?"big":size;var vid;var results;results=url.match("[\\?\x26]v\x3d([^\x26#]*)");vid=results===null?url:results[1];if(size=="small")return"http://img.youtube.com/vi/"+vid+"/2.jpg";else return"http://img.youtube.com/vi/"+vid+"/0.jpg"};var getSuggestedVideos=function(){if(self.videosGroup){var firstVideoGroup=_.first(_.values(self.videosGroup));if(firstVideoGroup&&firstVideoGroup.video){self.suggestedVideos=firstVideoGroup.video.slice(0,2);if(self.suggestedVideos&&!_.isEmpty(self.suggestedVideos))self.iframeVideoUrl=
$sce.trustAsResourceUrl(validateYouTubeUrl(self.suggestedVideos[0].embedUrl));self.videoDescription=self.suggestedVideos[0].description;self.videoTitle=self.suggestedVideos[0].title}}};var loadSlider=function(){var slider=$(".bxslider").bxSlider({mode:"horizontal",pagerCustom:"#bx-pager",nextSelector:"#lot-slider-next",prevSelector:"#lot-slider-prev",prevText:"",nextText:"",minSlides:2,maxSlides:4});$("#lot-slider-next").click(function(){slider.goToNextSlide();return false});$("#lot-slider-prev").click(function(){slider.goToPrevSlide();
return false})};var init=function(){cmsContentService.setParentFragment(parentFragmentId).then(function(){self.videosGroup=cmsContentService.getFragmentContent(parentFragmentId);getSuggestedVideos();loadSlider()})};$scope.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){$(".bxslider").bxSlider({minSlides:2,maxSlides:4,moveSlides:1,slideWidth:300,slideMargin:10})});init()}]);
app.controller("siteMapController",["$scope","$location","dataServiceG2","userService","$route",function($scope,$location,dataServiceG2,userService,$route){var self=$scope;var continentVal=undefined;self.primaryCountry="usa";self.primaryContinent="NORTH_AMERICA";self.finalList=[];self.stateSelected=false;self.userConfig=userService.userConfig;self.countryCodeMap={"usa":self.locale.messages["locations.label.US"],"can":self.locale.messages["locations.label.CANADA"],"gbr":self.locale.messages["locations.label.UK"],
"irl":self.locale.messages["locations.label.REPUBLICIRELAND"],"are":self.locale.messages["locations.label.UAE"],"bhr":self.locale.messages["locations.label.BAHRAIN"],"omn":self.locale.messages["locations.label.OMAN"]};self.init=function(){getRegionList()};var getRegionList=function(){dataServiceG2.getRegions(function(response){self.primaryContinent=response.data.primaryContinent;self.primaryCountry=response.data.primaryCountry;self.getYardLocations(self.primaryContinent)})};self.payAllUK=function(fromRequest){var requestParam=
{};requestParam.GATEWAY_URL_KEY="PAY_ALL_UK";dataServiceG2.setPciParam(requestParam,function(response){if(response.returnCode==1)$window.location.href=response.data.pciURL.trim();else log.error("Error in Gateway")})};self.routeReload=function(path){var url=$location.path();if(path==url)$route.reload()};var loadLocationNodes=function(){jQuery.fn.extend({treed:function(o){var openedClass="glyphicon-minus-sign";var closedClass="glyphicon-plus-sign";if(typeof o!="undefined"){if(typeof o.openedClass!=
"undefined")openedClass=o.openedClass;if(typeof o.closedClass!="undefined")closedClass=o.closedClass}var tree=jQuery(this);tree.addClass("tree");tree.find("li").has("ul").each(function(){var branch=jQuery(this);console.log(branch,"branch");branch.prepend("\x3ci class\x3d'indicator glyphicon "+closedClass+"'\x3e\x3c/i\x3e");branch.addClass("branch");branch.on("click",function(e){if(this==e.target){var icon=jQuery(this).children("i:first");icon.toggleClass(openedClass+" "+closedClass);jQuery(this).children().children().toggle()}});
branch.children().children().toggle()});tree.find(".branch .indicator").each(function(){$(this).on("click",function(){$(this).closest("li").click()})});tree.find(".branch\x3ea").each(function(){$(this).on("click",function(e){$(this).closest("li").click();e.preventDefault()})});tree.find(".branch\x3ebutton").each(function(){$(this).on("click",function(e){$(this).closest("li").click();e.preventDefault()})})}})};var sitemapRepeatEvent=self.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){loadLocationNodes();
jQuery("#tree1").treed()});self.getYardLocations=function(continent){dataServiceG2.getLocationsList(continent,function(response){var primaryyardDetails;var countries=response.data.countries;if(continent=="NORTH_AMERICA")for(var countryCode in countries){self.yardStates=_.chain(countries[countryCode]).groupBy("yardStateName").map(function(value1,key1){return{yardStateName:key1.toUpperCase(),yardNumbers:_.chain(value1).groupBy("yardName").map(function(value2,key2){return{yardNumber:value2[0].yardNumber,
yardName:_.pluck(value2,"yardName").toString(),yardCity:key2}}).value()}}).value();if(countryCode==self.primaryCountry)primaryYardDetails={"key":self.primaryCountry,"value":self.yardStates};else self.finalList.push({"key":countryCode,"value":self.yardStates})}else for(var countryCode in countries){if(self.userConfig.siteCode=="CPRTIE"&&countryCode=="gbr")break;self.yardStates=_.chain(countries[countryCode]).groupBy("yardName").map(function(value1,key1){return{yardCity:key1.toUpperCase(),yardNumber:value1[0].yardNumber}}).value();
if(countryCode==self.primaryCountry)primaryYardDetails={"key":self.primaryCountry,"value":self.yardStates};else self.finalList.push({"key":countryCode,"value":self.yardStates})}self.finalList.unshift(primaryYardDetails)})};self.init();$scope.$on("$destroy",function(){sitemapRepeatEvent()})}]);
app.controller("brokerDetailController",["$scope","$location","dataServiceG2","$routeParams","watchListService","staticLotDetails",function($scope,$location,dataServiceG2,$routeParams,watchListService,staticLotDetails){var self=$scope;self.brokerID=$routeParams.brokerID;self.lotNumber=$routeParams.lotNumber;self.brokerDetails=null;self.brokerPaymentsMethods=null;self.brokerServiceTexts=null;var staticLotDetailsPromise=staticLotDetails;if(staticLotDetailsPromise&&staticLotDetailsPromise.returnCode==
1&&staticLotDetailsPromise.data.lotDetails)self.lotDetails=staticLotDetailsPromise.data.lotDetails;else return;watchListService.setWatchListDefinition($location.url());self.addToWatchList=watchListService.addToWatchList;self.isAlreadyAdded=watchListService.isAlreadyAdded;self.removeFromWatchList=watchListService.removeFromWatchList;var getDynamicLotDetails=function(){dataServiceG2.getDynamicLotDetails(self.lotNumber,lotDetailsDymicSuccessCallBack)};var lotDetailsDymicSuccessCallBack=function(response){try{if(response.data.returnCode==
-1)self.dynamicLotDetailsError=response.data.data.errorObject;else self.dynamiclotDetails=response.data.data.lotDetails}catch(e){log.error(e)}};self.getSpecificBrokerInfo=function(){dataServiceG2.getSpecificBrokerInfo(self.brokerID,function(response){self.brokerDetails=response.data.brokerAccountInfo;self.brokerPaymentsMethods=response.data.brokerPaymentsMethods;self.brokerServiceTexts=response.data.brokerServiceTexts},function(errorResponse){console.log("Error occured while getting Details of All Brokers"+
errorResponse)})};self.init=function(){self.getSpecificBrokerInfo();getDynamicLotDetails()};self.init()}]);
app.controller("cmsController",["$scope","$rootScope","siteCatalyst",function($scope,$rootScope,siteCatalyst){try{var self=$scope;self.locale=self.$parent.locale;var metaTitle=$("#page_meta_title").text();var pageDescription=$("#page_meta_description").text();$rootScope.$emit("meta-args-update",{title:metaTitle?metaTitle:self.locale.messages["app.home.title"],description:pageDescription?pageDescription:self.locale.messages["app.home.description"]})}catch(e){}}]);
app.controller("makePaymentController",["$scope","$http","$location","dataServiceG2","$compile","$filter","$route","copartUser","appConfigService","backToLinkService","saveLotNumbersService","paymentService","dataTableConfig","$window","$sce",function($scope,$http,$location,dataServiceG2,$compile,$filter,$route,copartUser,appConfigService,backToLinkService,saveLotNumbersService,paymentService,dataTableConfig,$window,$sce){var self=$scope;self.signature="";self.selectedCurrency=copartUser.getUserConfig().currencyCode;
self.totalDues=0;self.showInvoiceConfirmation=false;self.showInvoiceProcessing=false;self.locale=$scope.$parent.locale;self.loadedFirstTime=false;self.showBidderColumn=false;self.yardDetails={};self.disabledPaymentButton=true;self.paymentConfirmButtonStatus=false;self.selectedEstimate=null;self.bidders={};self.images={};self.ccmaxLimit=appConfigService.getAppConfig().ccMaxLimit[0].code;self.backToLink=$location.url();backToLinkService.setBackToLink(self.backToLink);backToLinkService.setBackToLinkText("paymentdue.invoice.backurl.text");
self.buyerForCCPay=0;self.estimates={};self.availableFundAmount=[];self.currentEstimatesList=[];self.wuMaxLimit=0;var wuLimitRemaining=0;var wuEndPointUrl="";var wuServiceId="";var wuClientId="";var showWUInfoPopUp=true;self.totalDuesPaid={"AED":0,"BHD":0,"OMR":0};self.totalInvoices={"AED":0,"BHD":0,"OMR":0};self.totalTransAmount=0;self.selectedInvoices={};self.showDataTable=[{table:"#makePaymentDataTableAED",curCode:"AED",payButton:"#aedPayselected"},{table:"#makePaymentDataTableBHD",curCode:"BHD",
payButton:"#bhdPayselected"},{table:"#makePaymentDataTableOMR",curCode:"OMR",payButton:"#omrPayselected"}];var loadInvoices=function(tableName,curCode){var table=new ServersideDatatable_DB(saveLotNumbersService,dataTableConfig);var tableId=tableName;var backto=self.backToLink;self.paymentType="P";self.selectedCurrency=curCode;var dataTableOptions={"pageLength":1E4,"backToTop":false,"recalculateTableWidth":true,"columnDefs":[{"targets":[0,1,2,3,4,5,6],"data":null,"defaultContent":""},{"targets":["id"],
"orderable":false},{className:"control",orderable:false,targets:-1}],"lengthMenu":[[20,25,50,100],[20,25,50,100]],"url":"data/payments/getMEADueInvoiceList/"+self.paymentType+"/"+self.selectedCurrency,"containsFilters":false,"bPaginate":false,"paging":false,"lengthChange":false,"afterInit":function(){jQuery("#selectAllHdr").html("\x3cdiv class\x3d'text-center'\x3e\x3cinput type\x3d'checkbox' ng-click\x3d'selectAllCheckBox()'/\x3e\x3c/div\x3e");$compile(jQuery("#selectAllHdr"))($scope);self.$apply()},
"columns":[{"mData":"saleDate","sClass":"nowrap","render":function(data,type,row){var saleDate=moment(row["saleDate"],"YYYYMMDD");var defualtDateFormat=self.userConfig.displayPref.dateFormat.toUpperCase();return saleDate.format(defualtDateFormat)}},{"mData":"id"},{"mData":"yardName","render":function(data,type,row){var html="\x3ca class\x3d'cursor-pointer' href\x3d'/locationDetail/"+row["yn"]+"' target\x3d'_blank'\x3e"+"\x3cspan\x3e"+row["yname"]+"\x3c/span\x3e\x3c/a\x3e";return html}},{"mData":"description"},
{"mData":"amountDue","name":"amountDue","render":function(data,type,row){var due=$filter("globalize_currency_using_code")(data,row["cur"],2);return due}},{"mData":"conveyanceFee","name":"conveyanceFee","render":function(data,type,row){var due=$filter("globalize_currency_using_code")(data,row["cur"],2);return due}},{"mData":"totalDue","name":"totalDue","render":function(data,type,row){var due=$filter("globalize_currency_using_code")(data,row["cur"],2);return due}},{"mData":"amountDue","name":"amountDue",
"render":function(data,type,row){if(row["amountDue"]>0)return'\x3cinput  class\x3d"invoiceIdPayConfirm" type\x3d"checkbox"  value\x3d"'+row["id"]+'" ng-change\x3d"updateTotal({currencyCode:\''+curCode+"',invoiceNumber:"+row["id"]+",amount:"+row["totalDue"]+'})" ng-model\x3d"selectedInvoices[\''+curCode+"']['"+row["id"]+"']\"\x3e";else return'\x3cinput  type\x3d"checkbox" style\x3d"display:none" value\x3d"'+row["id"]+'"\x3e';return""}},{"mData":"","render":function(data,type,row){return""}}]};table.initServerSideDataTable(tableId,
dataTableOptions,function(){self.compileDomByClassName(".invoiceIdPayConfirm");self.totalInvoices[curCode]=$(tableId).DataTable().data().count();self.enableDisablePaybutton()})};for(var i=0;i<self.showDataTable.length;i++)loadInvoices(self.showDataTable[i].table,self.showDataTable[i].curCode);self.compileDom=function(table){var $dest=jQuery(table).find("tbody");var retn=$compile($dest)($scope);$scope.safeApply()};self.confirmInvoices=function(tableId){var countCheckBox=0;var table=$(tableId).dataTable();
var selected=true;var tempDue=0;var paymentDueConfirmTable="#MEApaymentDueConfirmTable";var oTableDest=$(paymentDueConfirmTable).DataTable();oTableDest.clear().draw();var currency="";jQuery(table.fnGetNodes()).find(":checkbox:checked").each(function(){var rowIndex=table.fnGetPosition(jQuery(this).closest("tr")[0]);var aData=table.fnGetData(rowIndex);tempDue=aData.totalDue+tempDue;currency=aData.cur});self.totalTransAmount=tempDue;oTableDest.draw();self.showInvoiceConfirmation=true;self.paySeletedInvoices(currency,
tableId)};self.paySeletedInvoices=function(currency,tableId){self.showInvoiceProcessing=true;var table=$(tableId).dataTable();var ids=jQuery(table.fnGetNodes()).find(":checkbox:checked").map(function(){return this.value}).get().join(",");var payInvoicesParam={};payInvoicesParam.udf1=copartUser.getUserConfig().buyerNumber;payInvoicesParam.udf2=ids;payInvoicesParam.amount=Number(self.totalTransAmount);payInvoicesParam.currency=currency.trim();dataServiceG2.paySelectedInvoicesMEA(payInvoicesParam,function(result){if(result.returnCode==
1){var form=$("#payment_confirmation");form.append(" \x3cinput type\x3d'hidden'  name\x3d'requestParameter' value\x3d'"+result.data.requestParameter+"'\x3e");form.submit()}})};self.updateTotal=function(data){if(self.selectedInvoices[data.currencyCode][data.invoiceNumber])self.totalDuesPaid[data.currencyCode]=Math.round((self.totalDuesPaid[data.currencyCode]+data.amount)*100)/100;else self.totalDuesPaid[data.currencyCode]=Math.round((self.totalDuesPaid[data.currencyCode]-data.amount)*100)/100;self.enableDisablePaybutton()};
self.enableDisablePaybutton=function(){for(var i=0;i<self.showDataTable.length;i++){var table=jQuery(self.showDataTable[i].table).dataTable();var selectedInvoiceCount=jQuery(table.fnGetNodes()).find(":checkbox:checked").size();if(selectedInvoiceCount==0)jQuery(self.showDataTable[i].payButton).prop("disabled",true);else jQuery(self.showDataTable[i].payButton).prop("disabled",false)}omrPayselected};$scope.safeApply=function(fn){var phase=this.$root.$$phase;if(phase=="$apply"||phase=="$digest"){if(fn&&
typeof fn==="function")fn()}else this.$apply(fn)};self.compileDomByClassName=function(className){$(className).each(function(){var value=$(this);var retn=$compile(value)($scope);self.safeApply()})}}]);